var lt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ct(at){return at&&at.__esModule&&Object.prototype.hasOwnProperty.call(at,"default")?at.default:at}var ut={exports:{}};/*!
 * @license Copyright 2015-2022 Ably Real-time Ltd (ably.com)
 * 
 * Ably JavaScript Library v1.2.33
 * https://github.com/ably/ably-js
 * 
 * Released under the Apache Licence v2.0
 */(function(at,ft){(function(R,l){at.exports=l()})(window,function(){return function(z){var R={};function l(v){if(R[v])return R[v].exports;var s=R[v]={i:v,l:!1,exports:{}};return z[v].call(s.exports,s,s.exports,l),s.l=!0,s.exports}return l.m=z,l.c=R,l.d=function(v,s,U){l.o(v,s)||Object.defineProperty(v,s,{enumerable:!0,get:U})},l.r=function(v){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(v,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(v,"__esModule",{value:!0})},l.t=function(v,s){if(s&1&&(v=l(v)),s&8||s&4&&typeof v=="object"&&v&&v.__esModule)return v;var U=Object.create(null);if(l.r(U),Object.defineProperty(U,"default",{enumerable:!0,value:v}),s&2&&typeof v!="string")for(var E in v)l.d(U,E,function(I){return v[I]}.bind(null,E));return U},l.n=function(v){var s=v&&v.__esModule?function(){return v.default}:function(){return v};return l.d(s,"a",s),s},l.o=function(v,s){return Object.prototype.hasOwnProperty.call(v,s)},l.p="",l(l.s=42)}([function(z,R,l){R.__esModule=!0;var v=function(){function s(){}return s}();R.default=v},function(z,R,l){l.r(R),l.d(R,"__extends",function(){return s}),l.d(R,"__assign",function(){return U}),l.d(R,"__rest",function(){return E}),l.d(R,"__decorate",function(){return I}),l.d(R,"__param",function(){return x}),l.d(R,"__metadata",function(){return b}),l.d(R,"__awaiter",function(){return C}),l.d(R,"__generator",function(){return y}),l.d(R,"__createBinding",function(){return r}),l.d(R,"__exportStar",function(){return p}),l.d(R,"__values",function(){return A}),l.d(R,"__read",function(){return O}),l.d(R,"__spread",function(){return u}),l.d(R,"__spreadArrays",function(){return f}),l.d(R,"__spreadArray",function(){return c}),l.d(R,"__await",function(){return t}),l.d(R,"__asyncGenerator",function(){return e}),l.d(R,"__asyncDelegator",function(){return i}),l.d(R,"__asyncValues",function(){return a}),l.d(R,"__makeTemplateObject",function(){return o}),l.d(R,"__importStar",function(){return d}),l.d(R,"__importDefault",function(){return m}),l.d(R,"__classPrivateFieldGet",function(){return S}),l.d(R,"__classPrivateFieldSet",function(){return T});/*! *****************************************************************************
	Copyright (c) Microsoft Corporation.

	Permission to use, copy, modify, and/or distribute this software for any
	purpose with or without fee is hereby granted.

	THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
	REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
	AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
	INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
	LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
	OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
	PERFORMANCE OF THIS SOFTWARE.
	***************************************************************************** */var v=function(h,g){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(P,L){P.__proto__=L}||function(P,L){for(var B in L)Object.prototype.hasOwnProperty.call(L,B)&&(P[B]=L[B])},v(h,g)};function s(h,g){if(typeof g!="function"&&g!==null)throw new TypeError("Class extends value "+String(g)+" is not a constructor or null");v(h,g);function P(){this.constructor=h}h.prototype=g===null?Object.create(g):(P.prototype=g.prototype,new P)}var U=function(){return U=Object.assign||function(g){for(var P,L=1,B=arguments.length;L<B;L++){P=arguments[L];for(var F in P)Object.prototype.hasOwnProperty.call(P,F)&&(g[F]=P[F])}return g},U.apply(this,arguments)};function E(h,g){var P={};for(var L in h)Object.prototype.hasOwnProperty.call(h,L)&&g.indexOf(L)<0&&(P[L]=h[L]);if(h!=null&&typeof Object.getOwnPropertySymbols=="function")for(var B=0,L=Object.getOwnPropertySymbols(h);B<L.length;B++)g.indexOf(L[B])<0&&Object.prototype.propertyIsEnumerable.call(h,L[B])&&(P[L[B]]=h[L[B]]);return P}function I(h,g,P,L){var B=arguments.length,F=B<3?g:L===null?L=Object.getOwnPropertyDescriptor(g,P):L,V;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")F=Reflect.decorate(h,g,P,L);else for(var j=h.length-1;j>=0;j--)(V=h[j])&&(F=(B<3?V(F):B>3?V(g,P,F):V(g,P))||F);return B>3&&F&&Object.defineProperty(g,P,F),F}function x(h,g){return function(P,L){g(P,L,h)}}function b(h,g){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(h,g)}function C(h,g,P,L){function B(F){return F instanceof P?F:new P(function(V){V(F)})}return new(P||(P=Promise))(function(F,V){function j(w){try{M(L.next(w))}catch(G){V(G)}}function D(w){try{M(L.throw(w))}catch(G){V(G)}}function M(w){w.done?F(w.value):B(w.value).then(j,D)}M((L=L.apply(h,g||[])).next())})}function y(h,g){var P={label:0,sent:function(){if(F[0]&1)throw F[1];return F[1]},trys:[],ops:[]},L,B,F,V;return V={next:j(0),throw:j(1),return:j(2)},typeof Symbol=="function"&&(V[Symbol.iterator]=function(){return this}),V;function j(M){return function(w){return D([M,w])}}function D(M){if(L)throw new TypeError("Generator is already executing.");for(;P;)try{if(L=1,B&&(F=M[0]&2?B.return:M[0]?B.throw||((F=B.return)&&F.call(B),0):B.next)&&!(F=F.call(B,M[1])).done)return F;switch(B=0,F&&(M=[M[0]&2,F.value]),M[0]){case 0:case 1:F=M;break;case 4:return P.label++,{value:M[1],done:!1};case 5:P.label++,B=M[1],M=[0];continue;case 7:M=P.ops.pop(),P.trys.pop();continue;default:if(F=P.trys,!(F=F.length>0&&F[F.length-1])&&(M[0]===6||M[0]===2)){P=0;continue}if(M[0]===3&&(!F||M[1]>F[0]&&M[1]<F[3])){P.label=M[1];break}if(M[0]===6&&P.label<F[1]){P.label=F[1],F=M;break}if(F&&P.label<F[2]){P.label=F[2],P.ops.push(M);break}F[2]&&P.ops.pop(),P.trys.pop();continue}M=g.call(h,P)}catch(w){M=[6,w],B=0}finally{L=F=0}if(M[0]&5)throw M[1];return{value:M[0]?M[1]:void 0,done:!0}}}var r=Object.create?function(h,g,P,L){L===void 0&&(L=P),Object.defineProperty(h,L,{enumerable:!0,get:function(){return g[P]}})}:function(h,g,P,L){L===void 0&&(L=P),h[L]=g[P]};function p(h,g){for(var P in h)P!=="default"&&!Object.prototype.hasOwnProperty.call(g,P)&&r(g,h,P)}function A(h){var g=typeof Symbol=="function"&&Symbol.iterator,P=g&&h[g],L=0;if(P)return P.call(h);if(h&&typeof h.length=="number")return{next:function(){return h&&L>=h.length&&(h=void 0),{value:h&&h[L++],done:!h}}};throw new TypeError(g?"Object is not iterable.":"Symbol.iterator is not defined.")}function O(h,g){var P=typeof Symbol=="function"&&h[Symbol.iterator];if(!P)return h;var L=P.call(h),B,F=[],V;try{for(;(g===void 0||g-- >0)&&!(B=L.next()).done;)F.push(B.value)}catch(j){V={error:j}}finally{try{B&&!B.done&&(P=L.return)&&P.call(L)}finally{if(V)throw V.error}}return F}function u(){for(var h=[],g=0;g<arguments.length;g++)h=h.concat(O(arguments[g]));return h}function f(){for(var h=0,g=0,P=arguments.length;g<P;g++)h+=arguments[g].length;for(var L=Array(h),B=0,g=0;g<P;g++)for(var F=arguments[g],V=0,j=F.length;V<j;V++,B++)L[B]=F[V];return L}function c(h,g,P){if(P||arguments.length===2)for(var L=0,B=g.length,F;L<B;L++)(F||!(L in g))&&(F||(F=Array.prototype.slice.call(g,0,L)),F[L]=g[L]);return h.concat(F||Array.prototype.slice.call(g))}function t(h){return this instanceof t?(this.v=h,this):new t(h)}function e(h,g,P){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var L=P.apply(h,g||[]),B,F=[];return B={},V("next"),V("throw"),V("return"),B[Symbol.asyncIterator]=function(){return this},B;function V(N){L[N]&&(B[N]=function(W){return new Promise(function(K,Y){F.push([N,W,K,Y])>1||j(N,W)})})}function j(N,W){try{D(L[N](W))}catch(K){G(F[0][3],K)}}function D(N){N.value instanceof t?Promise.resolve(N.value.v).then(M,w):G(F[0][2],N)}function M(N){j("next",N)}function w(N){j("throw",N)}function G(N,W){N(W),F.shift(),F.length&&j(F[0][0],F[0][1])}}function i(h){var g,P;return g={},L("next"),L("throw",function(B){throw B}),L("return"),g[Symbol.iterator]=function(){return this},g;function L(B,F){g[B]=h[B]?function(V){return(P=!P)?{value:t(h[B](V)),done:B==="return"}:F?F(V):V}:F}}function a(h){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var g=h[Symbol.asyncIterator],P;return g?g.call(h):(h=typeof A=="function"?A(h):h[Symbol.iterator](),P={},L("next"),L("throw"),L("return"),P[Symbol.asyncIterator]=function(){return this},P);function L(F){P[F]=h[F]&&function(V){return new Promise(function(j,D){V=h[F](V),B(j,D,V.done,V.value)})}}function B(F,V,j,D){Promise.resolve(D).then(function(M){F({value:M,done:j})},V)}}function o(h,g){return Object.defineProperty?Object.defineProperty(h,"raw",{value:g}):h.raw=g,h}var n=Object.create?function(h,g){Object.defineProperty(h,"default",{enumerable:!0,value:g})}:function(h,g){h.default=g};function d(h){if(h&&h.__esModule)return h;var g={};if(h!=null)for(var P in h)P!=="default"&&Object.prototype.hasOwnProperty.call(h,P)&&r(g,h,P);return n(g,h),g}function m(h){return h&&h.__esModule?h:{default:h}}function S(h,g,P,L){if(P==="a"&&!L)throw new TypeError("Private accessor was defined without a getter");if(typeof g=="function"?h!==g||!L:!g.has(h))throw new TypeError("Cannot read private member from an object whose class did not declare it");return P==="m"?L:P==="a"?L.call(h):L?L.value:g.get(h)}function T(h,g,P,L,B){if(L==="m")throw new TypeError("Private method is not writable");if(L==="a"&&!B)throw new TypeError("Private accessor was defined without a setter");if(typeof g=="function"?h!==g||!B:!g.has(h))throw new TypeError("Cannot write private member to an object whose class did not declare it");return L==="a"?B.call(h,P):B?B.value=P:g.set(h,P),P}},function(z,R,l){(function(v){R.__esModule=!0,R.allToUpperCase=R.allToLowerCase=R.encodeBody=R.decodeBody=R.Format=R.promisify=R.trim=R.arrChooseN=R.randomHexString=R.randomString=R.cheapRandStr=R.dataSizeBytes=R.inspectBody=R.inspectError=R.isErrorInfo=R.now=R.parseQueryString=R.toQueryString=R.arrPopRandomElement=R.defaultPostHeaders=R.defaultGetHeaders=R.allSame=R.arrEvery=R.arrFilter=R.arrMap=R.safeArrForEach=R.arrForEach=R.forInOwnNonNullProperties=R.valuesArray=R.keysArray=R.arrWithoutValue=R.arrDeleteValue=R.arrIn=R.arrIndexOf=R.arrSubtract=R.arrIntersectOb=R.arrIntersect=R.intersect=R.containsValue=R.inherits=R.prototypicalClone=R.shallowClone=R.isEmptyArg=R.isOnlyPropIn=R.isEmpty=R.isObject=R.ensureArray=R.isArray=R.copy=R.mixin=void 0,R.getGlobalObject=R.getJitterCoefficient=R.getBackoffCoefficient=void 0;var s=l(1),U=s.__importDefault(l(0)),E=s.__importStar(l(8));function I(H){return Math.floor(Math.random()*H.length)}function x(H){for(var _=[],k=1;k<arguments.length;k++)_[k-1]=arguments[k];for(var J=0;J<_.length;J++){var $=_[J];if(!$)break;var it=Object.prototype.hasOwnProperty;for(var st in $)(!it||it.call($,st))&&(H[st]=$[st])}return H}R.mixin=x;function b(H){return x({},H)}R.copy=b,R.isArray=Array.isArray||function(H){return Object.prototype.toString.call(H)=="[object Array]"};function C(H){return A(H)?[]:(0,R.isArray)(H)?H:[H]}R.ensureArray=C;function y(H){return Object.prototype.toString.call(H)=="[object Object]"}R.isObject=y;function r(H){for(var _ in H)return!1;return!0}R.isEmpty=r;function p(H,_){for(var k in H)if(k!==_)return!1;return!0}R.isOnlyPropIn=p;function A(H){return H==null}R.isEmptyArg=A;function O(H){var _=new Object;for(var k in H)_[k]=H[k];return _}R.shallowClone=O;function u(H,_){var k=function(){function $(){}return $}();k.prototype=H;var J=new k;return _&&x(J,_),J}R.prototypicalClone=u;var f=function(H,_){if(U.default.Config.inherits){U.default.Config.inherits(H,_);return}H.super_=_,H.prototype=u(_.prototype,{constructor:H})};R.inherits=f;function c(H,_){for(var k in H)if(H[k]==_)return!0;return!1}R.containsValue=c;function t(H,_){return(0,R.isArray)(_)?e(H,_):i(H,_)}R.intersect=t;function e(H,_){for(var k=[],J=0;J<H.length;J++){var $=H[J];(0,R.arrIndexOf)(_,$)!=-1&&k.push($)}return k}R.arrIntersect=e;function i(H,_){for(var k=[],J=0;J<H.length;J++){var $=H[J];$ in _&&k.push($)}return k}R.arrIntersectOb=i;function a(H,_){for(var k=[],J=0;J<H.length;J++){var $=H[J];(0,R.arrIndexOf)(_,$)==-1&&k.push($)}return k}R.arrSubtract=a,R.arrIndexOf=Array.prototype.indexOf?function(H,_,k){return H.indexOf(_,k)}:function(H,_,k){k=k||0;for(var J=H.length;k<J;k++)if(H[k]===_)return k;return-1};function o(H,_){return(0,R.arrIndexOf)(H,_)!==-1}R.arrIn=o;function n(H,_){var k=(0,R.arrIndexOf)(H,_),J=k!=-1;return J&&H.splice(k,1),J}R.arrDeleteValue=n;function d(H,_){var k=H.slice();return n(k,_),k}R.arrWithoutValue=d;function m(H,_){var k=[];for(var J in H)_&&!Object.prototype.hasOwnProperty.call(H,J)||k.push(J);return k}R.keysArray=m;function S(H,_){var k=[];for(var J in H)_&&!Object.prototype.hasOwnProperty.call(H,J)||k.push(H[J]);return k}R.valuesArray=S;function T(H,_){for(var k in H)Object.prototype.hasOwnProperty.call(H,k)&&H[k]&&_(k)}R.forInOwnNonNullProperties=T,R.arrForEach=Array.prototype.forEach?function(H,_){H.forEach(_)}:function(H,_){for(var k=H.length,J=0;J<k;J++)_(H[J],J,H)};function h(H,_){return(0,R.arrForEach)(H.slice(),_)}R.safeArrForEach=h,R.arrMap=Array.prototype.map?function(H,_){return H.map(_)}:function(H,_){for(var k=[],J=H.length,$=0;$<J;$++)k.push(_(H[$],$,H));return k},R.arrFilter=Array.prototype.filter?function(H,_){return H.filter(_)}:function(H,_){for(var k=[],J=H.length,$=0;$<J;$++)_(H[$])&&k.push(H[$]);return k},R.arrEvery=Array.prototype.every?function(H,_){return H.every(_)}:function(H,_){for(var k=H.length,J=0;J<k;J++)if(!_(H[J],J,H))return!1;return!0};function g(H,_){if(H.length===0)return!0;var k=H[0][_];return(0,R.arrEvery)(H,function(J){return J[_]===k})}R.allSame=g;var P={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};function L(H,_){var k=P[_||q.json];return{accept:k,"X-Ably-Version":E.default.apiVersion,"Ably-Agent":(0,E.getAgentString)(H)}}R.defaultGetHeaders=L;function B(H,_){var k,J=k=P[_||q.json];return{accept:J,"content-type":k,"X-Ably-Version":E.default.apiVersion,"Ably-Agent":(0,E.getAgentString)(H)}}R.defaultPostHeaders=B;function F(H){return H.splice(I(H),1)[0]}R.arrPopRandomElement=F;function V(H){var _=[];if(H)for(var k in H)_.push(encodeURIComponent(k)+"="+encodeURIComponent(H[k]));return _.length?"?"+_.join("&"):""}R.toQueryString=V;function j(H){for(var _,k=/([^?&=]+)=?([^&]*)/g,J={};_=k.exec(H);)J[decodeURIComponent(_[1])]=decodeURIComponent(_[2]);return J}R.parseQueryString=j,R.now=Date.now||function(){return new Date().getTime()};function D(H){return typeof H=="object"&&H!==null&&H.constructor.name=="ErrorInfo"}R.isErrorInfo=D;function M(H){var _;return H instanceof Error||((_=H==null?void 0:H.constructor)===null||_===void 0?void 0:_.name)==="ErrorInfo"?U.default.Config.inspect(H):H.toString()}R.inspectError=M;function w(H){return U.default.BufferUtils.isBuffer(H)?H.toString():typeof H=="string"?H:U.default.Config.inspect(H)}R.inspectBody=w;function G(H){if(U.default.BufferUtils.isBuffer(H))return U.default.BufferUtils.byteLength(H);if(typeof H=="string")return U.default.Config.stringByteSize(H);throw new Error("Expected input of Utils.dataSizeBytes to be a buffer or string, but was: "+typeof H)}R.dataSizeBytes=G;function N(){return String(Math.random()).substr(2)}R.cheapRandStr=N;var W=function(H){if(U.default.Config.getRandomValues&&typeof Uint8Array<"u"){var _=new Uint8Array(H);return U.default.Config.getRandomValues(_),U.default.BufferUtils.base64Encode(_)}for(var k=U.default.BufferUtils.base64CharSet,J=Math.round(H*4/3),$="",it=0;it<J;it++)$+=k[I(k)];return $};R.randomString=W;var K=function(H){if(U.default.Config.getRandomValues&&typeof Uint8Array<"u"){var _=new Uint8Array(H);return U.default.Config.getRandomValues(_),U.default.BufferUtils.hexEncode(_)}for(var k=U.default.BufferUtils.hexCharSet,J=H*2,$="",it=0;it<J;it++)$+=k[I(k)];return $};R.randomHexString=K;function Y(H,_){for(var k=Math.min(_,H.length),J=H.slice(),$=[],it=0;it<k;it++)$.push(F(J));return $}R.arrChooseN=Y,R.trim=String.prototype.trim?function(H){return H.trim()}:function(H){return H.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")};function X(H,_,k){return new Promise(function(J,$){H[_].apply(H,s.__spreadArray(s.__spreadArray([],k,!1),[function(it,st){it?$(it):J(st)}],!1))})}R.promisify=X;var q;(function(H){H.msgpack="msgpack",H.json="json"})(q=R.Format||(R.Format={}));function Z(H,_){return _=="msgpack"?U.default.Config.msgpack.decode(H):JSON.parse(String(H))}R.decodeBody=Z;function Q(H,_){return _=="msgpack"?U.default.Config.msgpack.encode(H,!0):JSON.stringify(H)}R.encodeBody=Q;function tt(H){return H.map(function(_){return _&&_.toLowerCase()})}R.allToLowerCase=tt;function rt(H){return H.map(function(_){return _&&_.toUpperCase()})}R.allToUpperCase=rt;function nt(H){return Math.min((H+2)/3,2)}R.getBackoffCoefficient=nt;function et(){return 1-Math.random()*.2}R.getJitterCoefficient=et;function ot(){return v||(typeof window<"u"?window:self)}R.getGlobalObject=ot}).call(this,l(12))},function(z,R,l){(function(v){R.__esModule=!0;var s=l(1),U=s.__importDefault(l(0)),E=v||(typeof window<"u"?window:self),I;(function(r){r[r.None=0]="None",r[r.Error=1]="Error",r[r.Major=2]="Major",r[r.Minor=3]="Minor",r[r.Micro=4]="Micro"})(I||(I={}));function x(r,p){return"".concat(r).padStart(p?3:2,"0")}function b(r){return U.default.Config.logTimestamps?function(p){var A=new Date;r(x(A.getHours())+":"+x(A.getMinutes())+":"+x(A.getSeconds())+"."+x(A.getMilliseconds(),1)+" "+p)}:r}var C=function(){var r,p,A,O;return typeof Window>"u"&&typeof WorkerGlobalScope>"u"||typeof((p=(r=E==null?void 0:E.console)===null||r===void 0?void 0:r.log)===null||p===void 0?void 0:p.apply)=="function"?(A=function(){for(var u=[],f=0;f<arguments.length;f++)u[f]=arguments[f];console.log.apply(console,u)},O=console.warn?function(){for(var u=[],f=0;f<arguments.length;f++)u[f]=arguments[f];console.warn.apply(console,u)}:A):E!=null&&E.console.log?A=O=function(){Function.prototype.apply.call(console.log,console,arguments)}:A=O=function(){},[A,O].map(b)},y=function(){function r(){r.logLevel=r.LOG_DEFAULT}return r.initLogHandlers=function(){var p=C(),A=p[0],O=p[1];this.logHandler=A,this.logErrorHandler=O},r.logLevel=I.Error,r.LOG_NONE=I.None,r.LOG_ERROR=I.Error,r.LOG_MAJOR=I.Major,r.LOG_MINOR=I.Minor,r.LOG_MICRO=I.Micro,r.LOG_DEFAULT=I.Error,r.LOG_DEBUG=I.Micro,r.logAction=function(p,A,O){r.shouldLog(p)&&(p===I.Error?r.logErrorHandler:r.logHandler)("Ably: "+A+": "+O)},r.deprecated=function(p,A){r.deprecatedWithMsg(p,"Please use '"+A+"' instead.")},r.deprecatedWithMsg=function(p,A){r.shouldLog(I.Error)&&r.logErrorHandler("Ably: Deprecation warning - '"+p+"' is deprecated and will be removed from a future version. "+A)},r.shouldLog=function(p){return p<=r.logLevel},r.setLog=function(p,A){p!==void 0&&(r.logLevel=p),A!==void 0&&(r.logHandler=r.logErrorHandler=A)},r}();R.default=y}).call(this,l(12))},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){return function(){if(typeof ArrayBuffer=="function"){var s=v,U=s.lib,E=U.WordArray,I=E.init,x=E.init=function(b){if(b instanceof ArrayBuffer&&(b=new Uint8Array(b)),(b instanceof Int8Array||typeof Uint8ClampedArray<"u"&&b instanceof Uint8ClampedArray||b instanceof Int16Array||b instanceof Uint16Array||b instanceof Int32Array||b instanceof Uint32Array||b instanceof Float32Array||b instanceof Float64Array)&&(b=new Uint8Array(b.buffer,b.byteOffset,b.byteLength)),b instanceof Uint8Array){for(var C=b.byteLength,y=[],r=0;r<C;r++)y[r>>>2]|=b[r]<<24-r%4*8;I.call(this,y,C)}else I.apply(this,arguments)};x.prototype=E}}(),v.lib.WordArray})},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(0)),U=v.__importStar(l(2)),E=function(){function I(x,b,C,y){this.message=x,this.code=b,this.statusCode=C,this.cause=y}return I.prototype.toString=function(){var x="["+this.constructor.name;return this.message&&(x+=": "+this.message),this.statusCode&&(x+="; statusCode="+this.statusCode),this.code&&(x+="; code="+this.code),this.cause&&(x+="; cause="+U.inspectError(this.cause)),this.href&&!(this.message&&this.message.indexOf("help.ably.io")>-1)&&(x+="; see "+this.href+" "),x+="]",x},I.fromValues=function(x){var b=x,C=b.message,y=b.code,r=b.statusCode;if(typeof C!="string"||typeof y!="number"||typeof r!="number")throw new Error("ErrorInfo.fromValues(): invalid values: "+s.default.Config.inspect(x));var p=Object.assign(new I(C,y,r),x);return p.code&&!p.href&&(p.href="https://help.ably.io/error/"+p.code),p},I}();R.default=E},function(z,R,l){(function(v){(function(s,U){z.exports=U()})(this,function(){var s=s||function(U,E){var I;if(typeof window<"u"&&window.crypto&&(I=window.crypto),!I&&typeof window<"u"&&window.msCrypto&&(I=window.msCrypto),!I&&typeof v<"u"&&v.crypto&&(I=v.crypto),!I)try{I=l(45)}catch{}var x=function(){if(I){if(typeof I.getRandomValues=="function")try{return I.getRandomValues(new Uint32Array(1))[0]}catch{}if(typeof I.randomBytes=="function")try{return I.randomBytes(4).readInt32LE()}catch{}}throw new Error("Native crypto module could not be used to get secure random number.")},b=Object.create||function(){function e(){}return function(i){var a;return e.prototype=i,a=new e,e.prototype=null,a}}(),C={},y=C.lib={},r=y.Base=function(){return{extend:function(e){var i=b(this);return e&&i.mixIn(e),(!i.hasOwnProperty("init")||this.init===i.init)&&(i.init=function(){i.$super.init.apply(this,arguments)}),i.init.prototype=i,i.$super=this,i},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var i in e)e.hasOwnProperty(i)&&(this[i]=e[i]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),p=y.WordArray=r.extend({init:function(e,i){e=this.words=e||[],i!=E?this.sigBytes=i:this.sigBytes=e.length*4},toString:function(e){return(e||O).stringify(this)},concat:function(e){var i=this.words,a=e.words,o=this.sigBytes,n=e.sigBytes;if(this.clamp(),o%4)for(var d=0;d<n;d++){var m=a[d>>>2]>>>24-d%4*8&255;i[o+d>>>2]|=m<<24-(o+d)%4*8}else for(var d=0;d<n;d+=4)i[o+d>>>2]=a[d>>>2];return this.sigBytes+=n,this},clamp:function(){var e=this.words,i=this.sigBytes;e[i>>>2]&=4294967295<<32-i%4*8,e.length=U.ceil(i/4)},clone:function(){var e=r.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var i=[],a=0;a<e;a+=4)i.push(x());return new p.init(i,e)}}),A=C.enc={},O=A.Hex={stringify:function(e){for(var i=e.words,a=e.sigBytes,o=[],n=0;n<a;n++){var d=i[n>>>2]>>>24-n%4*8&255;o.push((d>>>4).toString(16)),o.push((d&15).toString(16))}return o.join("")},parse:function(e){for(var i=e.length,a=[],o=0;o<i;o+=2)a[o>>>3]|=parseInt(e.substr(o,2),16)<<24-o%8*4;return new p.init(a,i/2)}},u=A.Latin1={stringify:function(e){for(var i=e.words,a=e.sigBytes,o=[],n=0;n<a;n++){var d=i[n>>>2]>>>24-n%4*8&255;o.push(String.fromCharCode(d))}return o.join("")},parse:function(e){for(var i=e.length,a=[],o=0;o<i;o++)a[o>>>2]|=(e.charCodeAt(o)&255)<<24-o%4*8;return new p.init(a,i)}},f=A.Utf8={stringify:function(e){try{return decodeURIComponent(escape(u.stringify(e)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(e){return u.parse(unescape(encodeURIComponent(e)))}},c=y.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=new p.init,this._nDataBytes=0},_append:function(e){typeof e=="string"&&(e=f.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(e){var i,a=this._data,o=a.words,n=a.sigBytes,d=this.blockSize,m=d*4,S=n/m;e?S=U.ceil(S):S=U.max((S|0)-this._minBufferSize,0);var T=S*d,h=U.min(T*4,n);if(T){for(var g=0;g<T;g+=d)this._doProcessBlock(o,g);i=o.splice(0,T),a.sigBytes-=h}return new p.init(i,h)},clone:function(){var e=r.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});y.Hasher=c.extend({cfg:r.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){e&&this._append(e);var i=this._doFinalize();return i},blockSize:16,_createHelper:function(e){return function(i,a){return new e.init(a).finalize(i)}},_createHmacHelper:function(e){return function(i,a){return new t.HMAC.init(e,a).finalize(i)}}});var t=C.algo={};return C}(Math);return s})}).call(this,l(12))},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(3)),E=v.__importDefault(l(0));function I(C,y,r){try{y.apply(C,r)}catch(p){U.default.logAction(U.default.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+p+"; stack = "+(p&&p.stack))}}function x(C,y,r){for(var p,A,O,u=0;u<C.length;u++)if(p=C[u],r&&(p=p[r]),s.isArray(p)){for(;(A=s.arrIndexOf(p,y))!==-1;)p.splice(A,1);r&&p.length===0&&delete C[u][r]}else if(s.isObject(p))for(O in p)Object.prototype.hasOwnProperty.call(p,O)&&s.isArray(p[O])&&x([p],y,O)}var b=function(){function C(){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}return C.prototype.on=function(){for(var y=this,r=[],p=0;p<arguments.length;p++)r[p]=arguments[p];if(r.length===1){var A=r[0];if(typeof A=="function")this.any.push(A);else throw new Error("EventListener.on(): Invalid arguments: "+E.default.Config.inspect(r))}if(r.length===2){var O=r[0],u=r[1];if(typeof u!="function")throw new Error("EventListener.on(): Invalid arguments: "+E.default.Config.inspect(r));if(s.isEmptyArg(O))this.any.push(u);else if(s.isArray(O))O.forEach(function(c){y.on(c,u)});else{if(typeof O!="string")throw new Error("EventListener.on(): Invalid arguments: "+E.default.Config.inspect(r));var f=this.events[O]||(this.events[O]=[]);f.push(u)}}},C.prototype.off=function(){for(var y,r=this,p=[],A=0;A<arguments.length;A++)p[A]=arguments[A];if(p.length==0||s.isEmptyArg(p[0])&&s.isEmptyArg(p[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}var O=p[0],u=p[1],f=null,c=null;if(p.length===1||!u)typeof O=="function"?f=O:c=O;else{if(typeof u!="function")throw new Error("EventEmitter.off(): invalid arguments:"+E.default.Config.inspect(p));y=[O,u],c=y[0],f=y[1]}if(f&&s.isEmptyArg(c)){x([this.any,this.events,this.anyOnce,this.eventsOnce],f);return}if(s.isArray(c)){c.forEach(function(t){r.off(t,f)});return}if(typeof c!="string")throw new Error("EventEmitter.off(): invalid arguments:"+E.default.Config.inspect(p));f?x([this.events,this.eventsOnce],f,c):(delete this.events[c],delete this.eventsOnce[c])},C.prototype.listeners=function(y){if(y){var r=this.events[y]||[];return this.eventsOnce[y]&&Array.prototype.push.apply(r,this.eventsOnce[y]),r.length?r:null}return this.any.length?this.any:null},C.prototype.emit=function(y){for(var r=[],p=1;p<arguments.length;p++)r[p-1]=arguments[p];var A={event:y},O=[];this.anyOnce.length&&(Array.prototype.push.apply(O,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(O,this.any);var u=this.eventsOnce[y];u&&(Array.prototype.push.apply(O,u),delete this.eventsOnce[y]);var f=this.events[y];f&&Array.prototype.push.apply(O,f),s.arrForEach(O,function(c){I(A,c,r)})},C.prototype.once=function(){for(var y=this,r=[],p=0;p<arguments.length;p++)r[p]=arguments[p];var A=r.length;if((A===0||A===1&&typeof r[0]!="function")&&E.default.Config.Promise){var O=r[0];return new E.default.Config.Promise(function(i){y.once(O,i)})}var u=r[0],f=r[1];if(r.length===1&&typeof u=="function")this.anyOnce.push(u);else if(s.isEmptyArg(u)){if(typeof f!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+E.default.Config.inspect(r));this.anyOnce.push(f)}else if(s.isArray(u)){var c=this,t=function(){var i=Array.prototype.slice.call(arguments);if(s.arrForEach(u,function(a){c.off(a,t)}),typeof f!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+E.default.Config.inspect(r));f.apply(this,i)};s.arrForEach(u,function(i){c.on(i,t)})}else{if(typeof u!="string")throw new Error("EventEmitter.once(): Invalid arguments:"+E.default.Config.inspect(r));var e=this.eventsOnce[u]||(this.eventsOnce[u]=[]);if(f){if(typeof f!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+E.default.Config.inspect(r));e.push(f)}}},C.prototype.whenState=function(y,r,p){for(var A=this,O=[],u=3;u<arguments.length;u++)O[u-3]=arguments[u];var f={event:y};if(typeof y!="string"||typeof r!="string")throw"whenState requires a valid event String argument";if(typeof p!="function"&&E.default.Config.Promise)return new E.default.Config.Promise(function(c){C.prototype.whenState.apply(A,[y,r,c].concat(O))});y===r?I(f,p,O):this.once(y,p)},C}();R.default=b},function(z,R,l){R.__esModule=!0,R.getDefaults=R.normaliseOptions=R.objectifyOptions=R.getAgentString=R.getHosts=R.getFallbackHosts=R.environmentFallbackHosts=R.getHttpScheme=R.getPort=R.getHost=void 0;var v=l(1),s=v.__importDefault(l(0)),U=v.__importStar(l(2)),E=v.__importDefault(l(3)),I=v.__importDefault(l(5)),x=l(43),b="ably-js/"+x.version,C={ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,preferenceConnectTimeout:6e3,parallelUpgradeDelay:6e3},httpMaxRetryCount:3,maxMessageSize:65536,version:x.version,apiVersion:"1.2",agent:b,getHost:y,getPort:r,getHttpScheme:p,environmentFallbackHosts:A,getFallbackHosts:O,getHosts:u,checkHost:f,objectifyOptions:i,normaliseOptions:a};function y(n,d,m){return m?d=d==n.restHost&&n.realtimeHost||d||n.realtimeHost:d=d||n.restHost,d}R.getHost=y;function r(n,d){return d||n.tls?n.tlsPort:n.port}R.getPort=r;function p(n){return n.tls?"https://":"http://"}R.getHttpScheme=p;function A(n){return[n+"-a-fallback.ably-realtime.com",n+"-b-fallback.ably-realtime.com",n+"-c-fallback.ably-realtime.com",n+"-d-fallback.ably-realtime.com",n+"-e-fallback.ably-realtime.com"]}R.environmentFallbackHosts=A;function O(n){var d=n.fallbackHosts,m=typeof n.httpMaxRetryCount<"u"?n.httpMaxRetryCount:C.httpMaxRetryCount;return d?U.arrChooseN(d,m):[]}R.getFallbackHosts=O;function u(n){return[n.restHost].concat(O(n))}R.getHosts=u;function f(n){if(typeof n!="string")throw new I.default("host must be a string; was a "+typeof n,4e4,400);if(!n.length)throw new I.default("host must not be zero-length",4e4,400)}function c(n,d,m){return n.realtimeHost?n.realtimeHost:n.restHost?(E.default.logAction(E.default.LOG_MINOR,"Defaults.normaliseOptions",'restHost is set to "'+n.restHost+'" but realtimeHost is not set, so setting realtimeHost to "'+n.restHost+'" too. If this is not what you want, please set realtimeHost explicitly.'),n.restHost):d?C.REALTIME_HOST:m+"-"+C.REALTIME_HOST}function t(n){var d={};for(var m in C.TIMEOUTS)d[m]=n[m]||C.TIMEOUTS[m];return d}function e(n){var d=C.agent;if(n.agents)for(var m in n.agents)d+=" "+m+"/"+n.agents[m];return d}R.getAgentString=e;function i(n){return typeof n=="string"?n.indexOf(":")==-1?{token:n}:{key:n}:n}R.objectifyOptions=i;function a(n){if(n.host&&(E.default.deprecated("host","restHost"),n.restHost=n.host),n.wsHost&&(E.default.deprecated("wsHost","realtimeHost"),n.realtimeHost=n.wsHost),n.queueEvents&&(E.default.deprecated("queueEvents","queueMessages"),n.queueMessages=n.queueEvents),n.fallbackHostsUseDefault){if(n.fallbackHosts){var d="fallbackHosts and fallbackHostsUseDefault cannot both be set";throw E.default.logAction(E.default.LOG_ERROR,"Defaults.normaliseOptions",d),new I.default(d,4e4,400)}if(n.port||n.tlsPort){var d="fallbackHostsUseDefault cannot be set when port or tlsPort are set";throw E.default.logAction(E.default.LOG_ERROR,"Defaults.normaliseOptions",d),new I.default(d,4e4,400)}n.environment?E.default.deprecatedWithMsg("fallbackHostsUseDefault","There is no longer a need to set this when the environment option is also set since the library will now generate the correct fallback hosts using the environment option."):E.default.deprecated("fallbackHostsUseDefault","fallbackHosts: Ably.Defaults.FALLBACK_HOSTS"),n.fallbackHosts=C.FALLBACK_HOSTS}n.recover===!0&&(E.default.deprecated("{recover: true}","{recover: function(lastConnectionDetails, cb) { cb(true); }}"),n.recover=function(D,M){M(!0)}),typeof n.recover=="function"&&n.closeOnUnload===!0&&(E.default.logAction(E.default.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),n.recover=void 0),"closeOnUnload"in n||(n.closeOnUnload=!n.recover),n.transports&&U.arrIn(n.transports,"xhr")&&(E.default.deprecated('transports: ["xhr"]','transports: ["xhr_streaming"]'),U.arrDeleteValue(n.transports,"xhr"),n.transports.push("xhr_streaming")),"queueMessages"in n||(n.queueMessages=!0);var m=n.environment&&String(n.environment).toLowerCase()||C.ENVIRONMENT,S=!m||m==="production";!n.fallbackHosts&&!n.restHost&&!n.realtimeHost&&!n.port&&!n.tlsPort&&(n.fallbackHosts=S?C.FALLBACK_HOSTS:A(m));var T=n.restHost||(S?C.REST_HOST:m+"-"+C.REST_HOST),h=c(n,S,m);U.arrForEach((n.fallbackHosts||[]).concat(T,h),f),n.port=n.port||C.PORT,n.tlsPort=n.tlsPort||C.TLS_PORT,"tls"in n||(n.tls=!0);var g=t(n);if("useBinaryProtocol"in n?n.useBinaryProtocol=s.default.Config.supportsBinary&&n.useBinaryProtocol:n.useBinaryProtocol=s.default.Config.preferBinary,n.clientId){var P=n.headers=n.headers||{};P["X-Ably-ClientId"]=s.default.BufferUtils.base64Encode(s.default.BufferUtils.utf8Encode(n.clientId))}"idempotentRestPublishing"in n||(n.idempotentRestPublishing=!0),n.promises&&!s.default.Config.Promise&&(E.default.logAction(E.default.LOG_ERROR,"Defaults.normaliseOptions","{promises: true} was specified, but no Promise constructor found; disabling promises"),n.promises=!1);var L=null,B=n.connectivityCheckUrl;if(n.connectivityCheckUrl){var F=n.connectivityCheckUrl.split("?"),V=F[0],j=F[1];L=j?U.parseQueryString(j):{},V.indexOf("://")===-1&&(V="https://"+V),B=V}return v.__assign(v.__assign({},n),{useBinaryProtocol:"useBinaryProtocol"in n?s.default.Config.supportsBinary&&n.useBinaryProtocol:s.default.Config.preferBinary,realtimeHost:h,restHost:T,maxMessageSize:n.maxMessageSize||C.maxMessageSize,timeouts:g,connectivityCheckParams:L,connectivityCheckUrl:B})}R.normaliseOptions=a,R.default=C;function o(n){return Object.assign(C,n)}R.getDefaults=o},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(0)),U=v.__importDefault(l(3)),E=v.__importDefault(l(5)),I=v.__importStar(l(2));function x(r){return!r||!r.channelOptions?{channelOptions:r,plugins:{},baseEncodedPreviousPayload:void 0}:r}function b(r){if(r&&r.cipher&&!r.cipher.channelCipher){if(!s.default.Crypto)throw new Error("Encryption not enabled; use ably.encryption.js instead");var p=s.default.Crypto.getCipher(r.cipher);return{cipher:p.cipherParams,channelCipher:p.cipher}}return r}function C(r){var p=0;return r.name&&(p+=r.name.length),r.clientId&&(p+=r.clientId.length),r.extras&&(p+=JSON.stringify(r.extras).length),r.data&&(p+=I.dataSizeBytes(r.data)),p}var y=function(){function r(){}return r.prototype.toJSON=function(){var p=this.encoding,A=this.data;return A&&s.default.BufferUtils.isBuffer(A)&&(arguments.length>0?(p=p?p+"/base64":"base64",A=s.default.BufferUtils.base64Encode(A)):A=s.default.BufferUtils.toBuffer(A)),{name:this.name,id:this.id,clientId:this.clientId,connectionId:this.connectionId,connectionKey:this.connectionKey,extras:this.extras,encoding:p,data:A}},r.prototype.toString=function(){var p="[Message";return this.name&&(p+="; name="+this.name),this.id&&(p+="; id="+this.id),this.timestamp&&(p+="; timestamp="+this.timestamp),this.clientId&&(p+="; clientId="+this.clientId),this.connectionId&&(p+="; connectionId="+this.connectionId),this.encoding&&(p+="; encoding="+this.encoding),this.extras&&(p+="; extras ="+JSON.stringify(this.extras)),this.data&&(typeof this.data=="string"?p+="; data="+this.data:s.default.BufferUtils.isBuffer(this.data)?p+="; data (buffer)="+s.default.BufferUtils.base64Encode(this.data):p+="; data (json)="+JSON.stringify(this.data)),this.extras&&(p+="; extras="+JSON.stringify(this.extras)),p+="]",p},r.encrypt=function(p,A,O){var u=p.data,f=p.encoding,c=A.channelCipher;f=f?f+"/":"",s.default.BufferUtils.isBuffer(u)||(u=s.default.BufferUtils.utf8Encode(String(u)),f=f+"utf-8/"),c.encrypt(u,function(t,e){if(t){O(t);return}p.data=e,p.encoding=f+"cipher+"+c.algorithm,O(null,p)})},r.encode=function(p,A,O){var u=p.data,f=typeof u=="string"||s.default.BufferUtils.isBuffer(u)||u===null||u===void 0;if(!f)if(I.isObject(u)||I.isArray(u))p.data=JSON.stringify(u),p.encoding=p.encoding?p.encoding+"/json":"json";else throw new E.default("Data type is unsupported",40013,400);A!=null&&A.cipher?r.encrypt(p,A,O):O(null,p)},r.encodeArray=function(p,A,O){for(var u=0,f=0;f<p.length;f++)r.encode(p[f],A,function(c){if(c){O(c);return}u++,u==p.length&&O(null,p)})},r.decode=function(p,A){var O=x(A),u=p.data,f=p.encoding;if(f){var c=f.split("/"),t=void 0,e=c.length,i=p.data,a="";try{for(;(t=e)>0;){var o=c[--e].match(/([-\w]+)(\+([\w-]+))?/);if(!o)break;switch(a=o[1],a){case"base64":i=s.default.BufferUtils.base64Decode(String(i)),t==c.length&&(u=i);continue;case"utf-8":i=s.default.BufferUtils.utf8Decode(i);continue;case"json":i=JSON.parse(i);continue;case"cipher":if(O.channelOptions!=null&&O.channelOptions.cipher&&O.channelOptions.channelCipher){var n=o[3],d=O.channelOptions.channelCipher;if(n!=d.algorithm)throw new Error("Unable to decrypt message with given cipher; incompatible cipher params");i=d.decrypt(i);continue}else throw new Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!O.plugins||!O.plugins.vcdiff)throw new E.default("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if(typeof Uint8Array>"u")throw new E.default("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{var m=O.baseEncodedPreviousPayload;typeof m=="string"&&(m=s.default.BufferUtils.utf8Encode(m)),m=s.default.BufferUtils.toBuffer(m),i=s.default.BufferUtils.toBuffer(i),i=s.default.BufferUtils.typedArrayToBuffer(O.plugins.vcdiff.decode(i,m)),u=i}catch(T){throw new E.default("Vcdiff delta decode failed with "+T,40018,400)}continue;default:throw new Error("Unknown encoding")}}}catch(T){var S=T;throw new E.default("Error processing the "+a+" encoding, decoder returned \u2018"+S.message+"\u2019",S.code||40013,400)}finally{p.encoding=t<=0?null:c.slice(0,t).join("/"),p.data=i}}O.baseEncodedPreviousPayload=u},r.fromResponseBody=function(p,A,O){O&&(p=I.decodeBody(p,O));for(var u=0;u<p.length;u++){var f=p[u]=r.fromValues(p[u]);try{r.decode(f,A)}catch(c){U.default.logAction(U.default.LOG_ERROR,"Message.fromResponseBody()",c.toString())}}return p},r.fromValues=function(p){return Object.assign(new r,p)},r.fromValuesArray=function(p){for(var A=p.length,O=new Array(A),u=0;u<A;u++)O[u]=r.fromValues(p[u]);return O},r.fromEncoded=function(p,A){var O=r.fromValues(p),u=b(A);try{r.decode(O,u)}catch(f){U.default.logAction(U.default.LOG_ERROR,"Message.fromEncoded()",f.toString())}return O},r.fromEncodedArray=function(p,A){return b(A),p.map(function(O){return r.fromEncoded(O,A)})},r.getMessagesSize=function(p){for(var A,O=0,u=0;u<p.length;u++)A=p[u],O+=A.size||(A.size=C(A));return O},r.serialize=I.encodeBody,r}();R.default=y},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(5)),E=v.__importDefault(l(9)),I=v.__importDefault(l(14)),x={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17},b=[];Object.keys(x).forEach(function(O){b[x[O]]=O});var C={HAS_PRESENCE:1<<0,HAS_BACKLOG:1<<1,RESUMED:1<<2,TRANSIENT:1<<4,ATTACH_RESUME:1<<5,PRESENCE:1<<16,PUBLISH:1<<17,SUBSCRIBE:1<<18,PRESENCE_SUBSCRIBE:1<<19},y=Object.keys(C);C.MODE_ALL=C.PRESENCE|C.PUBLISH|C.SUBSCRIBE|C.PRESENCE_SUBSCRIBE;function r(O){var u=[];if(O)for(var f=0;f<O.length;f++)u.push(O[f].toString());return"[ "+u.join(", ")+" ]"}var p="id channel channelSerial connectionId connectionKey connectionSerial count msgSerial timestamp".split(" "),A=function(){function O(){var u=this;this.hasFlag=function(f){return(u.flags&C[f])>0}}return O.prototype.setFlag=function(u){return this.flags=this.flags|C[u]},O.prototype.getMode=function(){return this.flags&&this.flags&C.MODE_ALL},O.prototype.encodeModesToFlags=function(u){var f=this;u.forEach(function(c){return f.setFlag(c)})},O.prototype.decodeModesFromFlags=function(){var u=this,f=[];return O.channelModes.forEach(function(c){u.hasFlag(c)&&f.push(c)}),f.length>0?f:void 0},O.fromValues=function(u){return Object.assign(new O,u)},O.Action=x,O.channelModes=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE"],O.ActionName=b,O.serialize=s.encodeBody,O.deserialize=function(u,f){var c=s.decodeBody(u,f);return O.fromDeserialized(c)},O.fromDeserialized=function(u){var f=u.error;f&&(u.error=U.default.fromValues(f));var c=u.messages;if(c)for(var t=0;t<c.length;t++)c[t]=E.default.fromValues(c[t]);var e=u.presence;if(e)for(var t=0;t<e.length;t++)e[t]=I.default.fromValues(e[t],!0);return Object.assign(new O,u)},O.stringify=function(u){var f="[ProtocolMessage";u.action!==void 0&&(f+="; action="+O.ActionName[u.action]||!1);for(var c,t=0;t<p.length;t++)c=p[t],u[c]!==void 0&&(f+="; "+c+"="+u[c]);if(u.messages&&(f+="; messages="+r(E.default.fromValuesArray(u.messages))),u.presence&&(f+="; presence="+r(I.default.fromValuesArray(u.presence))),u.error&&(f+="; error="+U.default.fromValues(u.error).toString()),u.auth&&u.auth.accessToken&&(f+="; token="+u.auth.accessToken),u.flags&&(f+="; flags="+y.filter(u.hasFlag).join(",")),u.params){var e="";s.forInOwnNonNullProperties(u.params,function(i){e.length>0&&(e+="; "),e+=i+"="+u.params[i]}),e.length>0&&(f+="; params=["+e+"]")}return f+="]",f},O.isDuplicate=function(u,f){if(u&&f&&(u.action===x.MESSAGE||u.action===x.PRESENCE)&&u.action===f.action&&u.channel===f.channel&&u.id===f.id){if(u.action===x.PRESENCE)return!0;if(u.messages.length===f.messages.length){for(var c=0;c<u.messages.length;c++){var t=u.messages[c],e=f.messages[c];if((t.extras&&t.extras.delta&&t.extras.delta.format)!==(e.extras&&e.extras.delta&&e.extras.delta.format))return!1}return!0}}return!1},O}();R.default=A},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(10)),E=v.__importDefault(l(26)),I=v.__importDefault(l(3)),x=v.__importDefault(l(8)),b=v.__importDefault(l(19)),C=v.__importDefault(l(16)),y=v.__importDefault(l(5)),r=v.__importDefault(l(20)),p=v.__importDefault(l(0));function A(f){var c=[80015,80017,80030];return f.code?C.default.isTokenErr(f)?!1:s.arrIn(c,f.code)?!0:f.code>=4e4&&f.code<5e4:!1}function O(f){return A(f)?[U.default.fromValues({action:U.default.Action.ERROR,error:f})]:[U.default.fromValues({action:U.default.Action.DISCONNECTED,error:f})]}var u=function(f){v.__extends(c,f);function c(t,e,i){var a=f.call(this,t,e,i,!0)||this;return a.onAuthUpdated=function(o){a.authParams={access_token:o.token}},a.stream="stream"in i?i.stream:!0,a.sendRequest=null,a.recvRequest=null,a.pendingCallback=null,a.pendingItems=null,a}return c.prototype.connect=function(){var t=this;I.default.logAction(I.default.LOG_MINOR,"CometTransport.connect()","starting"),E.default.prototype.connect.call(this);var e=this.params,i=e.options,a=x.default.getHost(i,e.host),o=x.default.getPort(i),n=i.tls?"https://":"http://";this.baseUri=n+a+":"+o+"/comet/";var d=this.baseUri+"connect";I.default.logAction(I.default.LOG_MINOR,"CometTransport.connect()","uri: "+d),this.auth.getAuthParams(function(m,S){if(m){t.disconnect(m);return}if(!t.isDisposed){t.authParams=S;var T=t.params.getConnectParams(S);"stream"in T&&(t.stream=T.stream),I.default.logAction(I.default.LOG_MINOR,"CometTransport.connect()","connectParams:"+s.toQueryString(T));var h=!1,g=t.recvRequest=t.createRequest(d,null,T,null,t.stream?r.default.REQ_RECV_STREAM:r.default.REQ_RECV);g.on("data",function(P){!t.recvRequest||(h||(h=!0,t.emit("preconnect")),t.onData(P))}),g.on("complete",function(P){if(t.recvRequest||(P=P||new y.default("Request cancelled",80003,400)),t.recvRequest=null,!h&&!P&&(h=!0,t.emit("preconnect")),t.onActivity(),P){P.code?t.onData(O(P)):t.disconnect(P);return}p.default.Config.nextTick(function(){t.recv()})}),g.exec()}})},c.prototype.requestClose=function(){I.default.logAction(I.default.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)},c.prototype.requestDisconnect=function(){I.default.logAction(I.default.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)},c.prototype._requestCloseOrDisconnect=function(t){var e=this,i=t?this.closeUri:this.disconnectUri;if(i){var a=this.createRequest(i,null,this.authParams,null,r.default.REQ_SEND);a.on("complete",function(o){o&&(I.default.logAction(I.default.LOG_ERROR,"CometTransport.request"+(t?"Close()":"Disconnect()"),"request returned err = "+s.inspectError(o)),e.finish("disconnected",o))}),a.exec()}},c.prototype.dispose=function(){var t=this;I.default.logAction(I.default.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(I.default.logAction(I.default.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",b.default.disconnected),p.default.Config.nextTick(function(){t.emit("disposed")}))},c.prototype.onConnect=function(t){if(!this.isDisposed){var e=t.connectionKey;E.default.prototype.onConnect.call(this,t);var i=this.baseUri+e;I.default.logAction(I.default.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+i+"; connectionKey = "+t.connectionKey),this.sendUri=i+"/send",this.recvUri=i+"/recv",this.closeUri=i+"/close",this.disconnectUri=i+"/disconnect"}},c.prototype.send=function(t){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(t);return}var e=this.pendingItems||[];e.push(t),this.pendingItems=null,this.sendItems(e)},c.prototype.sendAnyPending=function(){var t=this.pendingItems;!t||(this.pendingItems=null,this.sendItems(t))},c.prototype.sendItems=function(t){var e=this,i=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(t),r.default.REQ_SEND);i.on("complete",function(a,o){if(a&&I.default.logAction(I.default.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+s.inspectError(a)),e.sendRequest=null,a){a.code?e.onData(O(a)):e.disconnect(a);return}o&&e.onData(o),e.pendingItems&&p.default.Config.nextTick(function(){e.sendRequest||e.sendAnyPending()})}),i.exec()},c.prototype.recv=function(){var t=this;if(!this.recvRequest&&!!this.isConnected){var e=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?r.default.REQ_RECV_STREAM:r.default.REQ_RECV_POLL);e.on("data",function(i){t.onData(i)}),e.on("complete",function(i){if(t.recvRequest=null,t.onActivity(),i){i.code?t.onData(O(i)):t.disconnect(i);return}p.default.Config.nextTick(function(){t.recv()})}),e.exec()}},c.prototype.onData=function(t){try{var e=this.decodeResponse(t);if(e&&e.length)for(var i=0;i<e.length;i++)this.onProtocolMessage(U.default.fromDeserialized(e[i]))}catch(a){I.default.logAction(I.default.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+a.stack)}},c.prototype.encodeRequest=function(t){return JSON.stringify(t)},c.prototype.decodeResponse=function(t){return typeof t=="string"?JSON.parse(t):t},c}(E.default);R.default=u},function(z,R){var l;l=function(){return this}();try{l=l||new Function("return this")()}catch{typeof window=="object"&&(l=window)}z.exports=l},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){return function(){var s=v,U=s.lib,E=U.WordArray,I=s.enc;I.Base64={stringify:function(b){var C=b.words,y=b.sigBytes,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";b.clamp();for(var p=[],A=0;A<y;A+=3)for(var O=C[A>>>2]>>>24-A%4*8&255,u=C[A+1>>>2]>>>24-(A+1)%4*8&255,f=C[A+2>>>2]>>>24-(A+2)%4*8&255,c=O<<16|u<<8|f,t=0;t<4&&A+t*.75<y;t++)p.push(r.charAt(c>>>6*(3-t)&63));var e=r.charAt(64);if(e)for(;p.length%4;)p.push(e);return p.join("")},parse:function(b){var C=b.length,y="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r=this._reverseMap;if(!r){r=this._reverseMap=[];for(var p=0;p<y.length;p++)r[y.charCodeAt(p)]=p}var A=y.charAt(64);if(A){var O=b.indexOf(A);O!==-1&&(C=O)}return x(b,C,r)}};function x(b,C,y){for(var r=[],p=0,A=0;A<C;A++)if(A%4){var O=y[b.charCodeAt(A-1)]<<A%4*2,u=y[b.charCodeAt(A)]>>>6-A%4*2,f=O|u;r[p>>>2]|=f<<24-p%4*8,p++}return E.create(r,p)}}(),v.enc.Base64})},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(3)),U=v.__importDefault(l(0)),E=v.__importDefault(l(9)),I=v.__importStar(l(2));function x(C){return b.Actions.indexOf(C)}var b=function(){function C(){}return C.prototype.isSynthesized=function(){return!this.id||!this.connectionId?!0:this.id.substring(this.connectionId.length,0)!==this.connectionId},C.prototype.parseId=function(){if(!this.id)throw new Error("parseId(): Presence message does not contain an id");var y=this.id.split(":");return{connectionId:y[0],msgSerial:parseInt(y[1],10),index:parseInt(y[2],10)}},C.prototype.toJSON=function(){var y=this.data,r=this.encoding;return y&&U.default.BufferUtils.isBuffer(y)&&(arguments.length>0?(r=r?r+"/base64":"base64",y=U.default.BufferUtils.base64Encode(y)):y=U.default.BufferUtils.toBuffer(y)),{clientId:this.clientId,action:x(this.action),data:y,encoding:r}},C.prototype.toString=function(){var y="[PresenceMessage";return y+="; action="+this.action,this.id&&(y+="; id="+this.id),this.timestamp&&(y+="; timestamp="+this.timestamp),this.clientId&&(y+="; clientId="+this.clientId),this.connectionId&&(y+="; connectionId="+this.connectionId),this.encoding&&(y+="; encoding="+this.encoding),this.data&&(typeof this.data=="string"?y+="; data="+this.data:U.default.BufferUtils.isBuffer(this.data)?y+="; data (buffer)="+U.default.BufferUtils.base64Encode(this.data):y+="; data (json)="+JSON.stringify(this.data)),y+="]",y},C.fromResponseBody=function(y,r,p){var A=[];p&&(y=I.decodeBody(y,p));for(var O=0;O<y.length;O++){var u=A[O]=C.fromValues(y[O],!0);try{C.decode(u,r)}catch(f){s.default.logAction(s.default.LOG_ERROR,"PresenceMessage.fromResponseBody()",f.toString())}}return A},C.fromValues=function(y,r){return r&&(y.action=C.Actions[y.action]),Object.assign(new C,y)},C.fromValuesArray=function(y){for(var r=y.length,p=new Array(r),A=0;A<r;A++)p[A]=C.fromValues(y[A]);return p},C.fromEncoded=function(y,r){var p=C.fromValues(y,!0);try{C.decode(p,r)}catch(A){s.default.logAction(s.default.LOG_ERROR,"PresenceMessage.fromEncoded()",A.toString())}return p},C.fromEncodedArray=function(y,r){return y.map(function(p){return C.fromEncoded(p,r)})},C.Actions=["absent","present","enter","leave","update"],C.encode=E.default.encode,C.decode=E.default.decode,C.getMessagesSize=E.default.getMessagesSize,C}();R.default=b},function(z,R,l){(function(v){R.__esModule=!0;var s=l(1),U=s.__importStar(l(2)),E=s.__importDefault(l(7)),I=s.__importDefault(l(5)),x=s.__importDefault(l(3)),b=s.__importDefault(l(8)),C=s.__importDefault(l(20)),y=s.__importDefault(l(0));function r(n,d){return U.arrIn(U.allToLowerCase(U.keysArray(d)),"x-ably-errorcode")}function p(n,d){if(r(n,d))return n.error&&I.default.fromValues(n.error)}var A=function(){},O=0,u={},f=typeof v<"u"&&v.XDomainRequest;function c(){var n=navigator.userAgent.toString().match(/MSIE\s([\d.]+)/);return n&&Number(n[1])}function t(){var n;return f&&(n=c())&&n===10}function e(n,d){return n.getResponseHeader&&n.getResponseHeader(d)}function i(n){return n.getResponseHeader&&(n.getResponseHeader("transfer-encoding")||!n.getResponseHeader("content-length"))}function a(n){for(var d=U.trim(n.getAllResponseHeaders()).split(`\r
`),m={},S=0;S<d.length;S++){var T=d[S].split(":").map(U.trim);m[T[0].toLowerCase()]=T[1]}return m}var o=function(n){s.__extends(d,n);function d(m,S,T,h,g,P,L){var B=n.call(this)||this;return T=T||{},T.rnd=U.cheapRandStr(),t()&&!T.envelope&&(T.envelope="json"),B.uri=m+U.toQueryString(T),B.headers=S||{},B.body=h,B.method=L?L.toUpperCase():U.isEmptyArg(h)?"GET":"POST",B.requestMode=g,B.timeouts=P,B.timedOut=!1,B.requestComplete=!1,B.id=String(++O),u[B.id]=B,B}return d.createRequest=function(m,S,T,h,g,P,L){var B=P||b.default.TIMEOUTS;return new d(m,S,U.copy(T),h,g,B,L)},d.prototype.complete=function(m,S,T,h,g){this.requestComplete||(this.requestComplete=!0,!m&&S&&this.emit("data",S),this.emit("complete",m,S,T,h,g),this.dispose())},d.prototype.abort=function(){this.dispose()},d.prototype.exec=function(){var m=this,S=this.headers,T=this.requestMode==C.default.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,h=this.timer=setTimeout(function(){m.timedOut=!0,P.abort()},T),g=this.method,P=this.xhr=new XMLHttpRequest,L=S.accept,B=this.body,F="text";if(L?L.indexOf("application/x-msgpack")===0&&(F="arraybuffer"):S.accept="application/json",B){var V=S["content-type"]||(S["content-type"]="application/json");V.indexOf("application/json")>-1&&typeof B!="string"&&(B=JSON.stringify(B))}P.open(g,this.uri,!0),P.responseType=F,"authorization"in S&&(P.withCredentials=!0);for(var j in S)P.setRequestHeader(j,S[j]);var D=function(Q,tt,rt,nt){var et,ot=tt+" (event type: "+Q.type+")";!((et=m==null?void 0:m.xhr)===null||et===void 0)&&et.statusText&&(ot+=", current statusText is "+m.xhr.statusText),x.default.logAction(x.default.LOG_ERROR,"Request.on"+Q.type+"()",ot),m.complete(new I.default(ot,rt,nt))};P.onerror=function(Q){D(Q,"XHR error occurred",null,400)},P.onabort=function(Q){m.timedOut?D(Q,"Request aborted due to request timeout expiring",null,408):D(Q,"Request cancelled",null,400)},P.ontimeout=function(Q){D(Q,"Request timed out",null,408)};var M,w,G,N=0,W=!1,K=function(){if(clearTimeout(h),G=w<400,w==204){m.complete(null,null,null,null,w);return}M=m.requestMode==C.default.REQ_RECV_STREAM&&G&&i(P)},Y=function(){var Q;try{var tt=e(P,"content-type"),rt=tt?tt.indexOf("application/json")>=0:P.responseType=="text";if(rt){var nt=P.responseType==="arraybuffer"?y.default.BufferUtils.utf8Decode(P.response):String(P.responseText);nt.length?Q=JSON.parse(nt):Q=nt,W=!0}else Q=P.response;Q.response!==void 0?(w=Q.statusCode,G=w<400,S=Q.headers,Q=Q.response):S=a(P)}catch(ot){m.complete(new I.default("Malformed response body from server: "+ot.message,null,400));return}if(G||U.isArray(Q)){m.complete(null,Q,S,W,w);return}var et=p(Q,S);et||(et=new I.default("Error response received from server: "+w+" body was: "+y.default.Config.inspect(Q),null,w)),m.complete(et,Q,S,W,w)};function X(){for(var Q=P.responseText,tt=Q.length-1,rt,nt;N<tt&&(rt=Q.indexOf(`
`,N))>-1;)nt=Q.slice(N,rt),N=rt+1,q(nt)}var q=function(Q){try{Q=JSON.parse(Q)}catch(tt){m.complete(new I.default("Malformed response body from server: "+tt.message,null,400));return}m.emit("data",Q)},Z=function(){X(),m.streamComplete=!0,y.default.Config.nextTick(function(){m.complete()})};P.onreadystatechange=function(){var Q=P.readyState;Q<3||P.status!==0&&(w===void 0&&(w=P.status,w===1223&&(w=204),K()),Q==3&&M?X():Q==4&&(M?Z():Y()))},P.send(B)},d.prototype.dispose=function(){var m=this.xhr;if(m){m.onreadystatechange=m.onerror=m.onabort=m.ontimeout=A,this.xhr=null;var S=this.timer;S&&(clearTimeout(S),this.timer=null),this.requestComplete||m.abort()}delete u[this.id]},d}(E.default);R.default=o}).call(this,l(12))},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(3)),U=v.__importStar(l(2)),E=v.__importDefault(l(22)),I=v.__importDefault(l(5)),x=v.__importDefault(l(44)),b=l(13),C=l(32),y=v.__importDefault(l(17)),r=v.__importDefault(l(0)),p=Math.pow(2,17);function A(){}function O(){return("000000"+Math.floor(Math.random()*1e16)).slice(-16)}function u(T){return!!T.connection}function f(T){return U.isErrorInfo(T)?(T.code||(T.statusCode===403?T.code=40300:(T.code=40170,T.statusCode=401)),T):new I.default(U.inspectError(T),T.code||40170,T.statusCode||401)}var c=function(T){return r.default.Config.createHmac?Buffer.from(T,"ascii").toString("base64"):(0,b.stringify)((0,C.parse)(T))},t=function(T,h){if(r.default.Config.createHmac){var g=r.default.Config.createHmac("SHA256",h);return g.update(T),g.digest("base64")}return(0,b.stringify)((0,x.default)(T,h))};function e(T){if(!T)return"";typeof T=="string"&&(T=JSON.parse(T));var h=Object.create(null),g=U.keysArray(T,!0);if(!g)return"";g.sort();for(var P=0;P<g.length;P++)h[g[P]]=T[g[P]].sort();return JSON.stringify(h)}function i(T){if(T.authCallback)s.default.logAction(s.default.LOG_MINOR,"Auth()","using token auth with authCallback");else if(T.authUrl)s.default.logAction(s.default.LOG_MINOR,"Auth()","using token auth with authUrl");else if(T.key)s.default.logAction(s.default.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(T.tokenDetails)s.default.logAction(s.default.LOG_MINOR,"Auth()","using token auth with supplied token only");else{var h="authOptions must include valid authentication parameters";throw s.default.logAction(s.default.LOG_ERROR,"Auth()",h),new Error(h)}}function a(T){return"useTokenAuth"in T&&!T.useTokenAuth}function o(T){return T.useTokenAuth||!a(T)&&(T.authCallback||T.authUrl||T.token||T.tokenDetails)}function n(T){return!T.key&&!T.authCallback&&!T.authUrl}var d=0;function m(){return d++}var S=function(){function T(h,g){if(this.authOptions={},this.client=h,this.tokenParams=g.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,o(g)){if(g.key&&!t){var P="client-side token request signing not supported";throw s.default.logAction(s.default.LOG_ERROR,"Auth()",P),new Error(P)}n(g)&&s.default.logAction(s.default.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(g.defaultTokenParams,g),i(this.authOptions)}else{if(!g.key){var P="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw s.default.logAction(s.default.LOG_ERROR,"Auth()",P),new I.default(P,40160,401)}s.default.logAction(s.default.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(g)}}return T.prototype.authorize=function(h,g,P){var L=this,B;if(typeof h=="function"&&!P?(P=h,B=h=null):typeof g=="function"&&!P?(P=g,B=null):B=g,!P&&this.client.options.promises)return U.promisify(this,"authorize",arguments);if(B&&B.key&&this.authOptions.key!==B.key)throw new I.default("Unable to update auth options with incompatible key",40102,401);B&&"force"in B&&(s.default.logAction(s.default.LOG_ERROR,"Auth.authorize","Deprecation warning: specifying {force: true} in authOptions is no longer necessary, authorize() now always gets a new token. Please remove this, as in version 1.0 and later, having a non-null authOptions will overwrite stored library authOptions, which may not be what you want"),U.isOnlyPropIn(B,"force")&&(B=null)),this._forceNewToken(h,B,function(F,V){if(F){L.client.connection&&L.client.connection.connectionManager.actOnErrorFromAuthorize(F),P==null||P(F);return}u(L.client)?L.client.connection.connectionManager.onAuthUpdated(V,P||A):P==null||P(null,V)})},T.prototype.authorise=function(h,g,P){s.default.deprecated("Auth.authorise","Auth.authorize"),this.authorize(h,g,P)},T.prototype._forceNewToken=function(h,g,P){var L=this;this.tokenDetails=null,this._saveTokenOptions(h,g),i(this.authOptions),this._ensureValidAuthCredentials(!0,function(B,F){delete L.tokenParams.timestamp,delete L.authOptions.queryTime,P(B,F)})},T.prototype.requestToken=function(h,g,P){var L=this;if(typeof h=="function"&&!P?(P=h,g=h=null):typeof g=="function"&&!P&&(P=g,g=null),!P&&this.client.options.promises)return U.promisify(this,"requestToken",arguments);g=g||this.authOptions,h=h||U.copy(this.tokenParams);var B=P||A,F,V=this.client;if(g.authCallback)s.default.logAction(s.default.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),F=g.authCallback;else if(g.authUrl)s.default.logAction(s.default.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),F=function(N,W){var K=U.mixin({accept:"application/json, text/plain"},g.authHeaders),Y=g.authMethod&&g.authMethod.toLowerCase()==="post",X,q=g.authUrl.indexOf("?");q>-1&&(X=U.parseQueryString(g.authUrl.slice(q)),g.authUrl=g.authUrl.slice(0,q),Y||(g.authParams=U.mixin(X,g.authParams)));var Z=U.mixin({},g.authParams||{},N),Q=function(nt,et,ot,H){var _;if(nt?s.default.logAction(s.default.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+U.inspectError(nt)):(_=ot["content-type"],s.default.logAction(s.default.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+_+"; body: "+U.inspectBody(et))),nt||H)return W(nt,et);if(r.default.BufferUtils.isBuffer(et)&&(et=et.toString()),!_){W(new I.default("authUrl response is missing a content-type header",40170,401));return}var k=_.indexOf("application/json")>-1,J=_.indexOf("text/plain")>-1||_.indexOf("application/jwt")>-1;if(!k&&!J){W(new I.default("authUrl responded with unacceptable content-type "+_+", should be either text/plain, application/jwt or application/json",40170,401));return}if(k){if(et.length>p){W(new I.default("authUrl response exceeded max permitted length",40170,401));return}try{et=JSON.parse(et)}catch($){W(new I.default("Unexpected error processing authURL response; err = "+$.message,40170,401));return}}W(null,et,_)};if(s.default.logAction(s.default.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+g.authUrl+"; Params: "+JSON.stringify(Z)+"; method: "+(Y?"POST":"GET")),Y){var tt=K||{};tt["content-type"]="application/x-www-form-urlencoded";var rt=U.toQueryString(Z).slice(1);L.client.http.doUri(y.default.Post,V,g.authUrl,tt,rt,X,Q)}else L.client.http.doUri(y.default.Get,V,g.authUrl,K||{},null,Z,Q)};else if(g.key)s.default.logAction(s.default.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),F=function(N,W){L.createTokenRequest(N,g,W)};else{var j="Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)";s.default.logAction(s.default.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),B(new I.default(j,40171,403));return}"capability"in h&&(h.capability=e(h.capability));var D=function(N,W){var K=N.keyName,Y="/keys/"+K+"/requestToken",X=function(Z){return V.baseUri(Z)+Y},q=U.defaultPostHeaders(L.client.options);g.requestHeaders&&U.mixin(q,g.requestHeaders),s.default.logAction(s.default.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+Y+"; Token params: "+JSON.stringify(N)),L.client.http.do(y.default.Post,V,X,q,JSON.stringify(N),null,W)},M=!1,w=this.client.options.timeouts.realtimeRequestTimeout,G=setTimeout(function(){M=!0;var N="Token request callback timed out after "+w/1e3+" seconds";s.default.logAction(s.default.LOG_ERROR,"Auth.requestToken()",N),B(new I.default(N,40170,401))},w);F(h,function(N,W,K){if(!M){if(clearTimeout(G),N){s.default.logAction(s.default.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+U.inspectError(N)),B(f(N));return}if(typeof W=="string"){W.length===0?B(new I.default("Token string is empty",40170,401)):W.length>p?B(new I.default("Token string exceeded max permitted length (was "+W.length+" bytes)",40170,401)):W==="undefined"||W==="null"?B(new I.default("Token string was literal null/undefined",40170,401)):W[0]==="{"&&!(K&&K.indexOf("application/jwt")>-1)?B(new I.default("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401)):B(null,{token:W});return}if(typeof W!="object"){var Y="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof W;s.default.logAction(s.default.LOG_ERROR,"Auth.requestToken()",Y),B(new I.default(Y,40170,401));return}var X=JSON.stringify(W).length;if(X>p&&!g.suppressMaxLengthCheck){B(new I.default("Token request/details object exceeded max permitted stringified size (was "+X+" bytes)",40170,401));return}if("issued"in W){B(null,W);return}if(!("keyName"in W)){var Y="Expected token request callback to call back with a token string, token request object, or token details object";s.default.logAction(s.default.LOG_ERROR,"Auth.requestToken()",Y),B(new I.default(Y,40170,401));return}D(W,function(q,Z,Q,tt){if(q){s.default.logAction(s.default.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+U.inspectError(q)),B(f(q));return}tt||(Z=JSON.parse(Z)),s.default.logAction(s.default.LOG_MINOR,"Auth.getToken()","token received"),B(null,Z)})}})},T.prototype.createTokenRequest=function(h,g,P){var L=this;if(typeof h=="function"&&!P?(P=h,g=h=null):typeof g=="function"&&!P&&(P=g,g=null),!P&&this.client.options.promises)return U.promisify(this,"createTokenRequest",arguments);g=g||this.authOptions,h=h||U.copy(this.tokenParams);var B=g.key;if(!B){P(new I.default("No key specified",40101,403));return}var F=B.split(":"),V=F[0],j=F[1];if(!j){P(new I.default("Invalid key specified",40101,403));return}if(h.clientId===""){P(new I.default("clientId can\u2019t be an empty string",40012,400));return}"capability"in h&&(h.capability=e(h.capability));var D=U.mixin({keyName:V},h),M=h.clientId||"",w=h.ttl||"",G=h.capability||"";(function(N){if(D.timestamp){N();return}L.getTimestamp(g&&g.queryTime,function(W,K){if(W){P(W);return}D.timestamp=K,N()})})(function(){var N=D.nonce||(D.nonce=O()),W=D.timestamp,K=D.keyName+`
`+w+`
`+G+`
`+M+`
`+W+`
`+N+`
`;D.mac=D.mac||t(K,j),s.default.logAction(s.default.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),P(null,D)})},T.prototype.getAuthParams=function(h){this.method=="basic"?h(null,{key:this.key}):this._ensureValidAuthCredentials(!1,function(g,P){if(g){h(g);return}if(!P)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");h(null,{access_token:P.token})})},T.prototype.getAuthHeaders=function(h){this.method=="basic"?h(null,{authorization:"Basic "+this.basicKey}):this._ensureValidAuthCredentials(!1,function(g,P){if(g){h(g);return}if(!P)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");h(null,{authorization:"Bearer "+c(P.token)})})},T.prototype.getTimestamp=function(h,g){!this.isTimeOffsetSet()&&(h||this.authOptions.queryTime)?this.client.time(g):g(null,this.getTimestampUsingOffset())},T.prototype.getTimestampUsingOffset=function(){return U.now()+(this.client.serverTimeOffset||0)},T.prototype.isTimeOffsetSet=function(){return this.client.serverTimeOffset!==null},T.prototype._saveBasicOptions=function(h){this.method="basic",this.key=h.key,this.basicKey=c(h.key),this.authOptions=h||{},"clientId"in h&&this._userSetClientId(h.clientId)},T.prototype._saveTokenOptions=function(h,g){this.method="token",h&&(this.tokenParams=h),g&&(g.token&&(g.tokenDetails=typeof g.token=="string"?{token:g.token}:g.token),g.tokenDetails&&(this.tokenDetails=g.tokenDetails),"clientId"in g&&this._userSetClientId(g.clientId),this.authOptions=g)},T.prototype._ensureValidAuthCredentials=function(h,g){var P=this,L=this.tokenDetails;if(L){if(this._tokenClientIdMismatch(L.clientId)){g(new I.default("Mismatch between clientId in token ("+L.clientId+") and current clientId ("+this.clientId+")",40102,403));return}if(!this.isTimeOffsetSet()||!L.expires||L.expires>=this.getTimestampUsingOffset()){s.default.logAction(s.default.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+L.expires),g(null,L);return}s.default.logAction(s.default.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}if((this.waitingForTokenRequest||(this.waitingForTokenRequest=E.default.create())).push(g),!(this.currentTokenRequestId!==null&&!h)){var B=this.currentTokenRequestId=m();this.requestToken(this.tokenParams,this.authOptions,function(F,V){if(P.currentTokenRequestId>B){s.default.logAction(s.default.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one");return}P.currentTokenRequestId=null;var j=P.waitingForTokenRequest||A;if(P.waitingForTokenRequest=null,F){j(F);return}j(null,P.tokenDetails=V)})}},T.prototype._userSetClientId=function(h){if(typeof h=="string"||h===null){if(h==="*")throw new I.default('Can\u2019t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);var g=this._uncheckedSetClientId(h);if(g)throw g}else throw new I.default("clientId must be either a string or null",40012,400)},T.prototype._uncheckedSetClientId=function(h){if(this._tokenClientIdMismatch(h)){var g="Unexpected clientId mismatch: client has "+this.clientId+", requested "+h,P=new I.default(g,40102,401);return s.default.logAction(s.default.LOG_ERROR,"Auth._uncheckedSetClientId()",g),P}else return this.clientId=this.tokenParams.clientId=h,null},T.prototype._tokenClientIdMismatch=function(h){return!!(this.clientId&&this.clientId!=="*"&&h&&h!=="*"&&this.clientId!==h)},T.isTokenErr=function(h){return h.code&&h.code>=40140&&h.code<40150},T}();R.default=S},function(z,R,l){R.__esModule=!0;var v;(function(s){s.Get="get",s.Delete="delete",s.Post="post",s.Put="put",s.Patch="patch"})(v||(v={})),R.default=v},function(z,R,l){R.__esModule=!0,R.HttpPaginatedResponse=R.PaginatedResult=void 0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(3)),E=v.__importDefault(l(24));function I(p){var A=p.match(/^\.\/(\w+)\?(.*)$/);return A&&A[2]&&s.parseQueryString(A[2])}function x(p){typeof p=="string"&&(p=p.split(","));for(var A={},O=0;O<p.length;O++){var u=p[O].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(u){var f=I(u[1]);f&&(A[u[2]]=f)}}return A}function b(p,A,O){return!(O&&(A||typeof p.code=="number"))}var C=function(){function p(A,O,u,f,c,t){this.rest=A,this.path=O,this.headers=u,this.envelope=f!=null?f:null,this.bodyHandler=c,this.useHttpPaginatedResponse=t||!1}return p.prototype.get=function(A,O){var u=this;E.default.get(this.rest,this.path,this.headers,A,this.envelope,function(f,c,t,e,i){u.handlePage(f,c,t,e,i,O)})},p.prototype.delete=function(A,O){var u=this;E.default.delete(this.rest,this.path,this.headers,A,this.envelope,function(f,c,t,e,i){u.handlePage(f,c,t,e,i,O)})},p.prototype.post=function(A,O,u){var f=this;E.default.post(this.rest,this.path,O,this.headers,A,this.envelope,function(c,t,e,i,a){u&&f.handlePage(c,t,e,i,a,u)})},p.prototype.put=function(A,O,u){var f=this;E.default.put(this.rest,this.path,O,this.headers,A,this.envelope,function(c,t,e,i,a){u&&f.handlePage(c,t,e,i,a,u)})},p.prototype.patch=function(A,O,u){var f=this;E.default.patch(this.rest,this.path,O,this.headers,A,this.envelope,function(c,t,e,i,a){u&&f.handlePage(c,t,e,i,a,u)})},p.prototype.handlePage=function(A,O,u,f,c,t){if(A&&b(A,O,this.useHttpPaginatedResponse)){U.default.logAction(U.default.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+s.inspectError(A)),t==null||t(A);return}var e,i,a;try{e=this.bodyHandler(O,u||{},f)}catch(o){t==null||t(A||o);return}u&&(i=u.Link||u.link)&&(a=x(i)),this.useHttpPaginatedResponse?t(null,new r(this,e,u||{},c,a,A)):t(null,new y(this,e,a))},p}(),y=function(){function p(A,O,u){var f=this;this.resource=A,this.items=O;var c=this;u&&("first"in u&&(this.first=function(t){if(!t&&c.resource.rest.options.promises)return s.promisify(c,"first",[]);c.get(u.first,t)}),"current"in u&&(this.current=function(t){if(!t&&c.resource.rest.options.promises)return s.promisify(c,"current",[]);c.get(u.current,t)}),this.next=function(t){if(!t&&c.resource.rest.options.promises)return s.promisify(c,"next",[]);"next"in u?c.get(u.next,t):t(null)},this.hasNext=function(){return"next"in u},this.isLast=function(){var t;return!(!((t=f.hasNext)===null||t===void 0)&&t.call(f))})}return p.prototype.get=function(A,O){var u=this.resource;E.default.get(u.rest,u.path,u.headers,A,u.envelope,function(f,c,t,e,i){u.handlePage(f,c,t,e,i,O)})},p}();R.PaginatedResult=y;var r=function(p){v.__extends(A,p);function A(O,u,f,c,t,e){var i=p.call(this,O,u,t)||this;return i.statusCode=c,i.success=c<300&&c>=200,i.headers=f,i.errorCode=e&&e.code,i.errorMessage=e&&e.message,i}return A.prototype.toJSON=function(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}},A}(y);R.HttpPaginatedResponse=r,R.default=C},function(z,R,l){R.__esModule=!0,R.isRetriable=void 0;var v=l(1),s=v.__importDefault(l(5)),U={disconnected:s.default.fromValues({statusCode:400,code:80003,message:"Connection to server temporarily unavailable"}),suspended:s.default.fromValues({statusCode:400,code:80002,message:"Connection to server unavailable"}),failed:s.default.fromValues({statusCode:400,code:8e4,message:"Connection failed or disconnected by server"}),closing:s.default.fromValues({statusCode:400,code:80017,message:"Connection closing"}),closed:s.default.fromValues({statusCode:400,code:80017,message:"Connection closed"}),unknownConnectionErr:s.default.fromValues({statusCode:500,code:50002,message:"Internal connection error"}),unknownChannelErr:s.default.fromValues({statusCode:500,code:50001,message:"Internal channel error"})};function E(I){if(!I.statusCode||!I.code||I.statusCode>=500)return!0;var x=!1;return Object.values(U).forEach(function(b){b.code&&b.code==I.code&&(x=!0)}),x}R.isRetriable=E,R.default=U},function(z,R,l){R.__esModule=!0;var v;(function(s){s[s.REQ_SEND=0]="REQ_SEND",s[s.REQ_RECV=1]="REQ_RECV",s[s.REQ_RECV_POLL=2]="REQ_RECV_POLL",s[s.REQ_RECV_STREAM=3]="REQ_RECV_STREAM"})(v||(v={})),R.default=v},function(z,R,l){(function(v,s){z.exports=s(l(6),l(4),l(58),l(13),l(40),l(31),l(23),l(27),l(28),l(59),l(60))})(this,function(v){return v})},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(3)),U=function(){function E(I){this.members=I||[]}return E.prototype.call=function(){for(var I=[],x=0;x<arguments.length;x++)I[x]=arguments[x];for(var b=0,C=this.members;b<C.length;b++){var y=C[b];if(y)try{y.apply(void 0,I)}catch(r){s.default.logAction(s.default.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+r+"; stack = "+r.stack)}}},E.prototype.push=function(){for(var I,x=[],b=0;b<arguments.length;b++)x[b]=arguments[b];(I=this.members).push.apply(I,x)},E.create=function(I){var x=new E(I);return Object.assign(function(){for(var b=[],C=0;C<arguments.length;C++)b[C]=arguments[C];return x.call.apply(x,b)},{push:function(b){return x.push(b)}})},E}();R.default=U},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){(function(){var s=v,U=s.lib,E=U.Base,I=s.enc,x=I.Utf8,b=s.algo;b.HMAC=E.extend({init:function(C,y){C=this._hasher=new C.init,typeof y=="string"&&(y=x.parse(y));var r=C.blockSize,p=r*4;y.sigBytes>p&&(y=C.finalize(y)),y.clamp();for(var A=this._oKey=y.clone(),O=this._iKey=y.clone(),u=A.words,f=O.words,c=0;c<r;c++)u[c]^=1549556828,f[c]^=909522486;A.sigBytes=O.sigBytes=p,this.reset()},reset:function(){var C=this._hasher;C.reset(),C.update(this._iKey)},update:function(C){return this._hasher.update(C),this},finalize:function(C){var y=this._hasher,r=y.finalize(C);y.reset();var p=y.finalize(this._oKey.clone().concat(r));return p}})})()})},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(0)),U=v.__importStar(l(2)),E=v.__importDefault(l(3)),I=v.__importDefault(l(16)),x=v.__importDefault(l(17)),b=v.__importDefault(l(5));function C(u,f,c,t,e){u.http.supportsAuthHeaders?u.auth.getAuthHeaders(function(i,a){i?t(i):e(U.mixin(a,f),c)}):u.auth.getAuthParams(function(i,a){i?t(i):e(f,U.mixin(a,c))})}function y(u,f){return function(c,t,e,i,a){if(c&&!t){u(c);return}if(!i)try{t=U.decodeBody(t,f)}catch(T){U.isErrorInfo(T)?u(T):u(new b.default(U.inspectError(T),null));return}if(!t){u(new b.default("unenvelope(): Response body is missing",null));return}var o=t,n=o.statusCode,d=o.response,m=o.headers;if(n===void 0){u(c,t,e,!0,a);return}if(n<200||n>=300){var S=d&&d.error||c;S||(S=new Error("Error in unenveloping "+t),S.statusCode=n),u(S,d,m,!0,n);return}u(c,d,m,!0,n)}}function r(u){var f=[];if(u)for(var c in u)f.push(c+"="+u[c]);return f.join("&")}function p(u,f){return u+(f?"?":"")+r(f)}function A(u,f,c,t){return function(e,i,a,o,n){e?E.default.logAction(E.default.LOG_MICRO,"Resource."+f+"()","Received Error; "+p(c,t)+"; Error: "+U.inspectError(e)):E.default.logAction(E.default.LOG_MICRO,"Resource."+f+"()","Received; "+p(c,t)+"; Headers: "+r(a)+"; StatusCode: "+n+"; Body: "+(s.default.BufferUtils.isBuffer(i)?i.toString():i)),u&&u(e,i,a,o,n)}}var O=function(){function u(){}return u.get=function(f,c,t,e,i,a){u.do(x.default.Get,f,c,null,t,e,i,a)},u.delete=function(f,c,t,e,i,a){u.do(x.default.Delete,f,c,null,t,e,i,a)},u.post=function(f,c,t,e,i,a,o){u.do(x.default.Post,f,c,t,e,i,a,o)},u.patch=function(f,c,t,e,i,a,o){u.do(x.default.Patch,f,c,t,e,i,a,o)},u.put=function(f,c,t,e,i,a,o){u.do(x.default.Put,f,c,t,e,i,a,o)},u.do=function(f,c,t,e,i,a,o,n){E.default.shouldLog(E.default.LOG_MICRO)&&(n=A(n,f,t,a)),o&&(n=n&&y(n,o),(a=a||{}).envelope=o);function d(m,S){var T;if(E.default.shouldLog(E.default.LOG_MICRO)&&E.default.logAction(E.default.LOG_MICRO,"Resource."+f+"()","Sending; "+p(t,S)),E.default.shouldLog(E.default.LOG_MICRO)){var h=e;if(((T=m["content-type"])===null||T===void 0?void 0:T.indexOf("msgpack"))>0)try{h=s.default.Config.msgpack.decode(e)}catch(g){E.default.logAction(E.default.LOG_MICRO,"Resource."+f+"()","Sending MsgPack Decoding Error: "+U.inspectError(g))}E.default.logAction(E.default.LOG_MICRO,"Resource."+f+"()","Sending; "+p(t,S)+"; Body: "+h)}c.http.do(f,c,t,m,e,S,function(g,P,L,B,F){if(g&&I.default.isTokenErr(g)){c.auth.authorize(null,null,function(V){if(V){n(V);return}C(c,L,S,n,d)});return}n(g,P,L,B,F)})}C(c,i,a,n,d)},u}();R.default=O},function(z,R,l){(function(v){R.__esModule=!0,R.TransportParams=void 0;var s=l(1),U=s.__importDefault(l(10)),E=s.__importStar(l(2)),I=s.__importStar(l(52)),x=s.__importStar(l(8)),b=s.__importDefault(l(0)),C=s.__importDefault(l(7)),y=s.__importDefault(l(35)),r=s.__importDefault(l(3)),p=s.__importDefault(l(36)),A=s.__importStar(l(19)),O=s.__importDefault(l(5)),u=s.__importDefault(l(16)),f=s.__importDefault(l(9)),c=s.__importDefault(l(22)),t=s.__importDefault(l(53)),e=s.__importDefault(l(26)),i=s.__importDefault(l(37)),a=function(){var V;return typeof b.default.WebStorage<"u"&&((V=b.default.WebStorage)===null||V===void 0?void 0:V.localSupported)},o=function(){var V;return typeof b.default.WebStorage<"u"&&((V=b.default.WebStorage)===null||V===void 0?void 0:V.sessionSupported)},n=U.default.Action,d=function(){},m="ably-transport-preference",S="ably-connection-recovery";function T(){var V,j;return o()&&((j=(V=b.default.WebStorage)===null||V===void 0?void 0:V.getSession)===null||j===void 0?void 0:j.call(V,S))}function h(V){var j,D;return o()&&((D=(j=b.default.WebStorage)===null||j===void 0?void 0:j.setSession)===null||D===void 0?void 0:D.call(j,S,V))}function g(){var V,j;return o()&&((j=(V=b.default.WebStorage)===null||V===void 0?void 0:V.removeSession)===null||j===void 0?void 0:j.call(V,S))}function P(V,j){return E.arrIndexOf(b.default.Defaults.transportPreferenceOrder,V.shortName)>E.arrIndexOf(b.default.Defaults.transportPreferenceOrder,j.shortName)}function L(V,j,D){var M;if(V.channel!==j.channel||(M=V.action)!==n.PRESENCE&&M!==n.MESSAGE||M!==j.action)return!1;var w=M===n.PRESENCE?"presence":"messages",G=V[w].concat(j[w]),N=f.default.getMessagesSize(G);return N>D||!E.allSame(G,"clientId")||!E.arrEvery(G,function(W){return!W.id})?!1:(V[w]=G,!0)}var B=function(){function V(j,D,M,w){this.options=j,this.host=D,this.mode=M,this.connectionKey=w,this.format=j.useBinaryProtocol?E.Format.msgpack:E.Format.json,this.connectionSerial=void 0}return V.prototype.getConnectParams=function(j){var D=j?E.copy(j):{},M=this.options;switch(this.mode){case"upgrade":D.upgrade=this.connectionKey;break;case"resume":D.resume=this.connectionKey,this.connectionSerial!==void 0&&(D.connectionSerial=this.connectionSerial);break;case"recover":{var w=M.recover.split(":");w&&(D.recover=w[0],D.connectionSerial=w[1]);break}}return M.clientId!==void 0&&(D.clientId=M.clientId),M.echoMessages===!1&&(D.echo="false"),this.format!==void 0&&(D.format=this.format),this.stream!==void 0&&(D.stream=this.stream),this.heartbeats!==void 0&&(D.heartbeats=this.heartbeats),D.v=x.default.apiVersion,D.agent=encodeURIComponent((0,x.getAgentString)(this.options)),M.transportParams!==void 0&&E.mixin(D,M.transportParams),D},V.prototype.toString=function(){var j="[mode="+this.mode;return this.host&&(j+=",host="+this.host),this.connectionKey&&(j+=",connectionKey="+this.connectionKey),this.connectionSerial!==void 0&&(j+=",connectionSerial="+this.connectionSerial),this.format&&(j+=",format="+this.format),j+="]",j},V}();R.TransportParams=B;var F=function(V){s.__extends(j,V);function j(D,M){var w=V.call(this)||this;w.disconnectedRetryCount=0,j.initTransports(),w.realtime=D,w.options=M;var G=M.timeouts,N=G.preferenceConnectTimeout+G.realtimeRequestTimeout;if(w.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:N,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},synchronizing:{state:"connected",terminal:!1,queueEvents:!0,sendEvents:!1,forceQueueEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:G.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:G.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:G.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},w.state=w.states.initialized,w.errorReason=null,w.queuedMessages=new y.default,w.msgSerial=0,w.connectionDetails=void 0,w.connectionId=void 0,w.connectionKey=void 0,w.connectionSerial=void 0,w.connectionStateTtl=G.connectionStateTtl,w.maxIdleInterval=null,w.transports=E.intersect(M.transports||x.default.defaultTransports,j.supportedTransports),w.baseTransport=E.intersect(x.default.baseTransportOrder,w.transports)[0],w.upgradeTransports=E.intersect(w.transports,x.default.upgradeTransports),w.transportPreference=null,w.httpHosts=x.default.getHosts(M),w.activeProtocol=null,w.proposedTransports=[],w.pendingTransports=[],w.host=null,w.lastAutoReconnectAttempt=null,w.lastActivity=null,w.mostRecentMsg=null,w.forceFallbackHost=!1,w.connectCounter=0,r.default.logAction(r.default.LOG_MINOR,"Realtime.ConnectionManager()","started"),r.default.logAction(r.default.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(M.transports||x.default.defaultTransports)+"]"),r.default.logAction(r.default.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+w.transports+"]"),r.default.logAction(r.default.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+w.httpHosts+"]"),!w.transports.length){var W="no requested transports available";throw r.default.logAction(r.default.LOG_ERROR,"realtime.ConnectionManager()",W),new Error(W)}var K=b.default.Config.addEventListener;return K&&(o()&&typeof M.recover=="function"&&K("beforeunload",w.persistConnection.bind(w)),M.closeOnUnload===!0&&K("beforeunload",function(){r.default.logAction(r.default.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),w.requestState({state:"closing"})}),K("online",function(){(w.state==w.states.disconnected||w.state==w.states.suspended)&&(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager caught browser \u2018online\u2019 event","reattempting connection"),w.requestState({state:"connecting"}))}),K("offline",function(){w.state==w.states.connected&&(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager caught browser \u2018offline\u2019 event","disconnecting active transport"),w.disconnectAllTransports())})),w}return j.initTransports=function(){(0,t.default)(j),E.arrForEach(b.default.Transports,function(D){D(j)})},j.prototype.createTransportParams=function(D,M){var w=new B(this.options,D,M,this.connectionKey);return this.connectionSerial!==void 0&&(w.connectionSerial=this.connectionSerial),w},j.prototype.getTransportParams=function(D){var M=this,w=function(G){if(M.connectionKey){G("resume");return}if(typeof M.options.recover=="string"){G("recover");return}var N=M.options.recover,W=T();if(W&&typeof N=="function"){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data"),N(W,function(K){K?(M.options.recover=W.recoveryKey,G("recover")):G("clean")});return}G("clean")};w(function(G){var N=M.createTransportParams(null,G);if(G==="recover"){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+M.options.recover);var W=M.options.recover.split(":");W&&W[2]&&(M.msgSerial=Number(W[2]))}else r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+N.toString());D(N)})},j.prototype.tryATransport=function(D,M,w){var G=this;r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+M),e.default.tryConnect(j.supportedTransports[M],this,this.realtime.auth,D,function(N,W){var K=G.state;if(K==G.states.closing||K==G.states.closed||K==G.states.failed){W&&(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+K.state+" while we were attempting the transport; closing "+W),W.close()),w(!0);return}if(N){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+M+" "+N.event+", err: "+N.error.toString()),u.default.isTokenErr(N.error)&&!(G.errorReason&&u.default.isTokenErr(G.errorReason))?(G.errorReason=N.error,G.realtime.auth._forceNewToken(null,null,function(Y){if(Y){G.actOnErrorFromAuthorize(Y);return}G.tryATransport(D,M,w)})):N.event==="failed"?(G.notifyState({state:"failed",error:N.error}),w(!0)):N.event==="disconnected"&&((0,A.isRetriable)(N.error)?w(!1):(G.notifyState({state:G.states.connecting.failState,error:N.error}),w(!0)));return}r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+M+"; setting pending"),G.setTransportPending(W,D),w(null,W)})},j.prototype.setTransportPending=function(D,M){var w=this,G=M.mode;r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+D+"; mode = "+G),E.arrDeleteValue(this.proposedTransports,D),this.pendingTransports.push(D);var N=b.default.Defaults.transportPreferenceOrder[b.default.Defaults.transportPreferenceOrder.length-1];D.once("connected",function(K,Y,X,q){G=="upgrade"&&w.activeProtocol?D.shortName!==N&&E.arrIn(w.getUpgradePossibilities(),N)&&w.activeProtocol?setTimeout(function(){w.scheduleTransportActivation(K,D,Y,X,q.connectionSerial)},w.options.timeouts.parallelUpgradeDelay):w.scheduleTransportActivation(K,D,Y,X,q.connectionSerial):(w.activateTransport(K,D,Y,X,q.connectionSerial),b.default.Config.nextTick(function(){w.connectImpl(M)})),G==="recover"&&w.options.recover&&(w.options.recover=null,w.unpersistConnection())});var W=this;D.on(["disconnected","closed","failed"],function(K){W.deactivateTransport(D,this.event,K)}),this.emit("transport.pending",D)},j.prototype.scheduleTransportActivation=function(D,M,w,G,N){var W=this,K=this.activeProtocol&&this.activeProtocol.getTransport(),Y=function(){M.disconnect(),E.arrDeleteValue(W.pendingTransports,M)};if(this.state!==this.states.connected&&this.state!==this.states.connecting){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+this.state.state+(this.state===this.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+M.shortName),Y();return}if(K&&!P(M,K)){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+M.shortName+" is no better than current active transport "+K.shortName+" - abandoning upgrade"),Y();return}r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Scheduling transport upgrade; transport = "+M);var X=function(q){var Z;if(q){r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unable to activate transport; transport = "+M+"; err = "+q);return}if(!M.isConnected){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+M.shortName+"is no longer connected; abandoning upgrade"),Y();return}if(W.state===W.states.connected)r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Currently connected, so temporarily pausing events until the upgrade is complete"),W.state=W.states.synchronizing,Z=W.activeProtocol;else if(W.state!==W.states.connecting){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+W.state.state+(W.state===W.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+M.shortName),Y();return}var Q=w!==W.connectionId,tt=Q?N:W.connectionSerial;Q&&r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Upgrade resulted in new connectionId; resetting library connection serial from "+W.connectionSerial+" to "+tt+"; upgrade error was "+D),r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Syncing transport; transport = "+M),W.sync(M,tt,function(rt,nt,et){if(rt){W.state===W.states.synchronizing&&(r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unexpected error attempting to sync transport; transport = "+M+"; err = "+rt),W.disconnectAllTransports());return}var ot=function(){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Activating transport; transport = "+M),W.activateTransport(D,M,nt,G,et),W.state===W.states.synchronizing?(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, sending queued messages on upgraded transport; transport = "+M),W.state=W.states.connected):r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, but state is now "+W.state.state+", so leaving unchanged"),W.state.sendEvents&&W.sendQueuedMessages()};Z?Z.onceIdle(ot):ot()})};K?this.realtime.channels.onceNopending(X):X()},j.prototype.activateTransport=function(D,M,w,G,N){var W=this;r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+M),D&&r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+D),w&&r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+w),G&&r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(G)),N&&r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.activateTransport()","serial =  "+N),this.persistTransportPreference(M);var K=this.state,Y=this.states.connected.state;if(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+K.state),K.state==this.states.closing.state||K.state==this.states.closed.state||K.state==this.states.failed.state)return r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),M.disconnect(),!1;if(E.arrDeleteValue(this.pendingTransports,M),!M.isConnected)return r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+M+" since it appears to no longer be connected"),!1;var X=this.activeProtocol;this.activeProtocol=new I.default(M),this.host=M.params.host;var q=G.connectionKey;if(q&&this.connectionKey!=q&&this.setConnection(w,G,N,!!D),this.onConnectionDetailsUpdate(G,M),b.default.Config.nextTick(function(){M.on("connected",function(Q,tt,rt){W.onConnectionDetailsUpdate(rt,M),W.emit("update",new p.default(Y,Y,null,Q))})}),K.state===this.states.connected.state?D&&(this.errorReason=this.realtime.connection.errorReason=D,this.emit("update",new p.default(Y,Y,null,D))):(this.notifyState({state:"connected",error:D}),this.errorReason=this.realtime.connection.errorReason=D||null),this.emit("transport.active",M),X)if(X.messageQueue.count()>0&&r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+X.transport.shortName+", new one is "+M.shortName+") finishing with "+X.messageQueue.count()+" messages still pending"),X.transport===M){var Z="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+M.shortName+"; stack = "+new Error().stack;r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.activateTransport()",Z)}else X.finish();return E.safeArrForEach(this.pendingTransports,function(Q){if(Q===M){var tt="Assumption violated: activating a transport that is still marked as a pending transport; transport = "+M.shortName+"; stack = "+new Error().stack;r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.activateTransport()",tt),E.arrDeleteValue(W.pendingTransports,M)}else Q.disconnect()}),E.safeArrForEach(this.proposedTransports,function(Q){Q===M?(r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.activateTransport()","Assumption violated: activating a transport that is still marked as a proposed transport; transport = "+M.shortName+"; stack = "+new Error().stack),E.arrDeleteValue(W.proposedTransports,M)):Q.dispose()}),!0},j.prototype.deactivateTransport=function(D,M,w){var G=this.activeProtocol,N=G&&G.getTransport()===D,W=E.arrDeleteValue(this.pendingTransports,D),K=E.arrDeleteValue(this.proposedTransports,D),Y=this.noTransportsScheduledForActivation();if(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+D),r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+M+(N?"; was active":W?"; was pending":K?"; was proposed":"")+(Y?"":"; another transport is scheduled for activation")),w&&w.message&&r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+w.message),N&&(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(G.getPendingMessages()),b.default.Config.nextTick(function(){G.clearPendingMessages()}),this.activeProtocol=this.host=null,clearTimeout(this.channelResumeCheckTimer)),this.emit("transport.inactive",D),N&&Y||N&&M==="failed"||M==="closed"||G===null&&W&&this.pendingTransports.length===0){if(M==="disconnected"&&w&&w.statusCode>500&&this.httpHosts.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:M,error:w,retryImmediately:!0});return}var X=M==="failed"&&u.default.isTokenErr(w)?"disconnected":M;this.notifyState({state:X,error:w});return}N&&M==="disconnected"&&this.state!==this.states.synchronizing&&(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.deactivateTransport()","wasActive but another transport is connected and scheduled for activation, so going into the connecting state until it activates"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),this.notifyState({state:"connecting",error:w}))},j.prototype.noTransportsScheduledForActivation=function(){return E.isEmpty(this.pendingTransports)||this.pendingTransports.every(function(D){return!D.isConnected})},j.prototype.sync=function(D,M,w){var G=setTimeout(function(){D.off("sync"),w(new O.default("Timeout waiting for sync response",5e4,500))},this.options.timeouts.realtimeRequestTimeout),N=U.default.fromValues({action:n.SYNC,connectionKey:this.connectionKey});M!==void 0&&(N.connectionSerial=M),D.send(N),D.once("sync",function(W,K){clearTimeout(G),w(null,W,K)})},j.prototype.setConnection=function(D,M,w,G){var N=this,W=this.connectionId,K=W&&W!==D,Y=!W&&G;(K||Y)&&(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0),this.connectionId!==D?(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),b.default.Config.nextTick(function(){N.realtime.channels.reattach()})):this.options.checkChannelsOnResume&&(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.setConnection()","Same connectionId; checkChannelsOnResume is enabled"),clearTimeout(this.channelResumeCheckTimer),this.realtime.channels.resetAttachedMsgIndicators(),this.channelResumeCheckTimer=setTimeout(function(){N.realtime.channels.checkAttachedMsgIndicators(D)},3e4)),this.realtime.connection.id=this.connectionId=D,this.realtime.connection.key=this.connectionKey=M.connectionKey;var X=K||!W;this.setConnectionSerial(w,X,!1)},j.prototype.clearConnection=function(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.clearConnectionSerial(),this.msgSerial=0,this.unpersistConnection()},j.prototype.setConnectionSerial=function(D,M,w){if(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.setConnectionSerial()","Updating connection serial; serial = "+D+"; force = "+M+"; previous = "+this.connectionSerial),D!==void 0){if(D<=this.connectionSerial&&!M)return w&&r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with connectionSerial "+D+", but current connectionSerial is "+this.connectionSerial+"; assuming message is a duplicate and discarding it"),!0;this.realtime.connection.serial=this.connectionSerial=D,this.setRecoveryKey()}},j.prototype.clearConnectionSerial=function(){this.realtime.connection.serial=this.connectionSerial=void 0,this.clearRecoveryKey()},j.prototype.setRecoveryKey=function(){this.realtime.connection.recoveryKey=this.connectionKey+":"+this.connectionSerial+":"+this.msgSerial},j.prototype.clearRecoveryKey=function(){this.realtime.connection.recoveryKey=null},j.prototype.checkConnectionStateFreshness=function(){if(!(!this.lastActivity||!this.connectionId)){var D=E.now()-this.lastActivity;D>this.connectionStateTtl+this.maxIdleInterval&&(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+D+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended")}},j.prototype.persistConnection=function(){if(o()){var D=this.realtime.connection.recoveryKey;D&&h({recoveryKey:D,disconnectedAt:E.now(),location:v.location,clientId:this.realtime.auth.clientId})}},j.prototype.unpersistConnection=function(){g()},j.prototype.getError=function(){return this.errorReason||this.getStateError()},j.prototype.getStateError=function(){return A.default[this.state.state]},j.prototype.activeState=function(){return this.state.queueEvents||this.state.sendEvents},j.prototype.enactStateChange=function(D){var M=D.current==="failed"?r.default.LOG_ERROR:r.default.LOG_MAJOR;r.default.logAction(M,"Connection state",D.current+(D.reason?"; reason: "+D.reason:"")),r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+D.current+"; reason = "+(D.reason&&D.reason.message));var w=this.state=this.states[D.current];D.reason&&(this.errorReason=D.reason,this.realtime.connection.errorReason=D.reason),(w.terminal||w.state==="suspended")&&this.clearConnection(),this.emit("connectionstate",D)},j.prototype.startTransitionTimer=function(D){var M=this;r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+D.state),this.transitionTimer&&(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer)),this.transitionTimer=setTimeout(function(){M.transitionTimer&&(M.transitionTimer=null,r.default.logAction(r.default.LOG_MINOR,"ConnectionManager "+D.state+" timer expired","requesting new state: "+D.failState),M.notifyState({state:D.failState}))},D.retryDelay)},j.prototype.cancelTransitionTimer=function(){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)},j.prototype.startSuspendTimer=function(){var D=this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){D.suspendTimer&&(D.suspendTimer=null,r.default.logAction(r.default.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),D.states.connecting.failState="suspended",D.notifyState({state:"suspended"}))},this.connectionStateTtl))},j.prototype.checkSuspendTimer=function(D){D!=="disconnected"&&D!=="suspended"&&D!=="connecting"&&this.cancelSuspendTimer()},j.prototype.cancelSuspendTimer=function(){this.states.connecting.failState="disconnected",this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)},j.prototype.startRetryTimer=function(D){var M=this;this.retryTimer=setTimeout(function(){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),M.retryTimer=null,M.requestState({state:"connecting"})},D)},j.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},j.prototype.notifyState=function(D){var M=this,w=D.state,G=w==="disconnected"&&(this.state===this.states.connected||this.state===this.states.synchronizing||D.retryImmediately||this.state===this.states.connecting&&D.error&&u.default.isTokenErr(D.error)&&!(this.errorReason&&u.default.isTokenErr(this.errorReason)));if(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+w+(G?"; will retry connection immediately":"")),w!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(D.state),(w==="suspended"||w==="connected")&&(this.disconnectedRetryCount=0),!this.state.terminal)){var N=this.states[D.state],W=N.retryDelay;N.state==="disconnected"&&(this.disconnectedRetryCount++,W=N.retryDelay*E.getBackoffCoefficient(this.disconnectedRetryCount)*E.getJitterCoefficient());var K=new p.default(this.state.state,N.state,W,D.error||A.default[N.state]);if(G){var Y=function(){M.state===M.states.disconnected&&(M.lastAutoReconnectAttempt=E.now(),M.requestState({state:"connecting"}))},X=this.lastAutoReconnectAttempt&&E.now()-this.lastAutoReconnectAttempt+1;X&&X<1e3?(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+X+"ms ago, waiting another "+(1e3-X)+"ms before trying again"),setTimeout(Y,1e3-X)):b.default.Config.nextTick(Y)}else(w==="disconnected"||w==="suspended")&&this.startRetryTimer(W);(w==="disconnected"&&!G||w==="suspended"||N.terminal)&&b.default.Config.nextTick(function(){M.disconnectAllTransports()}),w=="connected"&&!this.activeProtocol&&r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(K),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(w,K.reason),this.failQueuedMessages(K.reason))}},j.prototype.requestState=function(D){var M=this,w=D.state;if(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+w+"; current state: "+this.state.state),w!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(w),!(w=="connecting"&&this.state.state=="connected")&&!(w=="closing"&&this.state.state=="closed"))){var G=this.states[w],N=new p.default(this.state.state,G.state,null,D.error||A.default[G.state]);this.enactStateChange(N),w=="connecting"&&b.default.Config.nextTick(function(){M.startConnect()}),w=="closing"&&this.closeImpl()}},j.prototype.startConnect=function(){var D=this;if(this.state!==this.states.connecting){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);return}var M=this.realtime.auth,w=++this.connectCounter,G=function(){D.checkConnectionStateFreshness(),D.getTransportParams(function(W){w===D.connectCounter&&D.connectImpl(W,w)})};if(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),M.method==="basic")G();else{var N=function(W){w===D.connectCounter&&(W?D.actOnErrorFromAuthorize(W):G())};this.errorReason&&u.default.isTokenErr(this.errorReason)?M._forceNewToken(null,null,N):M._ensureValidAuthCredentials(!1,N)}},j.prototype.connectImpl=function(D,M){var w=this.state.state;w!==this.states.connecting.state&&w!==this.states.connected.state?r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect (or connected to upgrade), but was "+w):this.pendingTransports.length?r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.connectImpl()","Transports "+this.pendingTransports[0].toString()+" currently pending; taking no action"):w==this.states.connected.state?this.upgradeIfNeeded(D):this.transports.length>1&&this.getTransportPreference()?this.connectPreference(D):this.connectBase(D,M)},j.prototype.connectPreference=function(D){var M=this,w=this.getTransportPreference(),G=!1;E.arrIn(this.transports,w)||(this.unpersistTransportPreference(),this.connectImpl(D)),r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.connectPreference()","Trying to connect with stored transport preference "+w);var N=setTimeout(function(){G=!0,M.state.state!==M.states.connected.state&&(r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.connectPreference()","Shortcircuit connection attempt with "+w+" failed; clearing preference and trying from scratch"),M.disconnectAllTransports(),M.unpersistTransportPreference()),M.connectImpl(D)},this.options.timeouts.preferenceConnectTimeout);D.host=this.httpHosts[0],this.tryATransport(D,w,function(W,K){clearTimeout(N),G&&K?(K.off(),K.disconnect(),E.arrDeleteValue(M.pendingTransports,K)):!K&&!W&&(M.unpersistTransportPreference(),M.connectImpl(D))})},j.prototype.connectBase=function(D,M){var w=this,G=function(X){w.notifyState({state:w.states.connecting.failState,error:X})},N=this.httpHosts.slice(),W=function(X,q){M===w.connectCounter&&!q&&!X&&Y()};r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.connectBase()","Trying to connect with base transport "+this.baseTransport);var K=N.shift();if(!K){G(new O.default("Unable to connect (no available host)",80003,404));return}D.host=K;var Y=function(){if(!N.length){G(new O.default("Unable to connect (and no more fallback hosts to try)",80003,404));return}if(!w.realtime.http.checkConnectivity){G(new O.default("Internal error: Http.checkConnectivity not set",null,500));return}w.realtime.http.checkConnectivity(function(X,q){if(M===w.connectCounter){if(X){G(X);return}if(!q){G(new O.default("Unable to connect (network unreachable)",80003,404));return}D.host=E.arrPopRandomElement(N),w.tryATransport(D,w.baseTransport,W)}})};if(this.forceFallbackHost&&N.length){this.forceFallbackHost=!1,Y();return}this.tryATransport(D,this.baseTransport,W)},j.prototype.getUpgradePossibilities=function(){var D=this.activeProtocol.getTransport().shortName,M=E.arrIndexOf(this.upgradeTransports,D);return this.upgradeTransports.slice(M+1)},j.prototype.upgradeIfNeeded=function(D){var M=this,w=this.getUpgradePossibilities();r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.upgradeIfNeeded()","upgrade possibilities: "+b.default.Config.inspect(w)),w.length&&E.arrForEach(w,function(G){var N=M.createTransportParams(D.host,"upgrade");M.tryATransport(N,G,d)})},j.prototype.closeImpl=function(){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),E.safeArrForEach(this.pendingTransports,function(D){r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+D),D&&D.close()}),E.safeArrForEach(this.proposedTransports,function(D){r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.closeImpl()","Disposing of proposed transport: "+D),D&&D.dispose()}),this.activeProtocol&&(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})},j.prototype.onAuthUpdated=function(D,M){var w=this,G;switch(this.state.state){case"connected":{if(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport"),(this.pendingTransports.length||this.proposedTransports.length)&&this.state!==this.states.synchronizing){this.disconnectAllTransports(!0);var N=this.activeProtocol.getTransport().params;b.default.Config.nextTick(function(){w.state.state==="connected"&&w.upgradeIfNeeded(N)})}var W=(G=this.activeProtocol)===null||G===void 0?void 0:G.getTransport();W&&W.onAuthUpdated&&W.onAuthUpdated(D);var K=U.default.fromValues({action:n.AUTH,auth:{accessToken:D.token}});this.send(K);var Y=function(){w.off(X),M(null,D)},X=function(Z){Z.current==="failed"&&(w.off(Y),w.off(X),M(Z.reason||w.getStateError()))};this.once("connectiondetails",Y),this.on("connectionstate",X);break}case"connecting":r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");var q=function(Z){switch(Z.current){case"connected":w.off(q),M(null,D);break;case"failed":case"closed":case"suspended":w.off(q),M(Z.reason||w.getStateError());break}};this.on("connectionstate",q),this.state.state==="connecting"?this.startConnect():this.requestState({state:"connecting"})}}},j.prototype.disconnectAllTransports=function(D){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"+(D?" except the active transport":"")),this.connectCounter++,E.safeArrForEach(this.pendingTransports,function(M){r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+M),M&&M.disconnect()}),this.pendingTransports=[],E.safeArrForEach(this.proposedTransports,function(M){r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disposing of proposed transport: "+M),M&&M.dispose()}),this.proposedTransports=[],this.activeProtocol&&!D&&(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())},j.prototype.send=function(D,M,w){w=w||d;var G=this.state;if(G.sendEvents){r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new I.PendingMessage(D,w));return}var N=M&&G.queueEvents||G.forceQueueEvents;if(!N){var W="rejecting event, queueEvent was "+M+", state was "+G.state;r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.send()",W),w(this.errorReason||new O.default(W,9e4,400));return}r.default.shouldLog(r.default.LOG_MICRO)&&r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+U.default.stringify(D)),this.queue(D,w)},j.prototype.sendImpl=function(D){var M=D.message;D.ackRequired&&!D.sendAttempted&&(M.msgSerial=this.msgSerial++,this.setRecoveryKey());try{this.activeProtocol.send(D)}catch(w){r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+w.stack)}},j.prototype.queue=function(D,M){r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.queue()","queueing event");var w=this.queuedMessages.last(),G=this.options.maxMessageSize;w&&!w.sendAttempted&&L(w.message,D,G)?(w.merged||(w.callback=c.default.create([w.callback]),w.merged=!0),w.callback.push(M)):this.queuedMessages.push(new I.PendingMessage(D,M))},j.prototype.sendQueuedMessages=function(){r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");for(var D;D=this.queuedMessages.shift();)this.sendImpl(D)},j.prototype.queuePendingMessages=function(D){D&&D.length&&(r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+D.length+" pending messages"),this.queuedMessages.prepend(D))},j.prototype.failQueuedMessages=function(D){var M=this.queuedMessages.count();M>0&&(r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+M+" queued messages, err = "+E.inspectError(D)),this.queuedMessages.completeAllMessages(D))},j.prototype.onChannelMessage=function(D,M){var w=this.activeProtocol&&M===this.activeProtocol.getTransport(),G=E.arrIn(this.pendingTransports,M)&&this.state==this.states.synchronizing,N=D.action===n.MESSAGE||D.action===n.PRESENCE;if(w||G){if(N){var W=this.setConnectionSerial(D.connectionSerial,!1,!0);if(W)return;if(U.default.isDuplicate(D,this.mostRecentMsg)){r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.onChannelMessage()","received message with different connectionSerial, but same message id as a previous; discarding; id = "+D.id);return}this.mostRecentMsg=D}this.realtime.channels.onChannelMessage(D)}else E.arrIndexOf([n.ACK,n.NACK,n.ERROR],D.action)>-1?this.realtime.channels.onChannelMessage(D):r.default.logAction(r.default.LOG_MICRO,"ConnectionManager.onChannelMessage()","received message "+JSON.stringify(D)+"on defunct transport; discarding")},j.prototype.ping=function(D,M){var w=this;if(D){r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.ping()","transport = "+D);var G=function(){D.off("heartbeat",K),M(new O.default("Timeout waiting for heartbeat response",5e4,500))},N=E.now(),W=E.cheapRandStr(),K=function(Q){if(Q===W){D.off("heartbeat",K),clearTimeout(Y);var tt=E.now()-N;M(null,tt)}},Y=setTimeout(G,this.options.timeouts.realtimeRequestTimeout);D.on("heartbeat",K),D.ping(W);return}if(this.state.state!=="connected"){M(new O.default("Unable to ping service; not connected",4e4,400));return}var X=!1,q=function(Q,tt){w.off("transport.active",Z),X||(X=!0,M(Q,tt))},Z=function(){X||(X=!0,b.default.Config.nextTick(function(){w.ping(null,M)}))};this.on("transport.active",Z),this.ping(this.activeProtocol.getTransport(),q)},j.prototype.abort=function(D){this.activeProtocol.getTransport().fail(D)},j.prototype.registerProposedTransport=function(D){this.proposedTransports.push(D)},j.prototype.getTransportPreference=function(){var D,M;return this.transportPreference||a()&&((M=(D=b.default.WebStorage)===null||D===void 0?void 0:D.get)===null||M===void 0?void 0:M.call(D,m))},j.prototype.persistTransportPreference=function(D){var M,w;E.arrIn(x.default.upgradeTransports,D.shortName)&&(this.transportPreference=D.shortName,a()&&((w=(M=b.default.WebStorage)===null||M===void 0?void 0:M.set)===null||w===void 0||w.call(M,m,D.shortName)))},j.prototype.unpersistTransportPreference=function(){var D,M;this.transportPreference=null,a()&&((M=(D=b.default.WebStorage)===null||D===void 0?void 0:D.remove)===null||M===void 0||M.call(D,m))},j.prototype.actOnErrorFromAuthorize=function(D){if(D.code===40171)this.notifyState({state:"failed",error:D});else if(D.statusCode===i.default.Forbidden){var M="Client configured authentication provider returned 403; failing the connection";r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",M),this.notifyState({state:"failed",error:new O.default(M,80019,403,D)})}else{var M="Client configured authentication provider request failed";r.default.logAction(r.default.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",M),this.notifyState({state:this.state.failState,error:new O.default(M,80019,401,D)})}},j.prototype.onConnectionDetailsUpdate=function(D,M){if(!!D){this.connectionDetails=D,D.maxMessageSize&&(this.options.maxMessageSize=D.maxMessageSize);var w=D.clientId;if(w){var G=this.realtime.auth._uncheckedSetClientId(w);if(G){r.default.logAction(r.default.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",G.message),M.fail(G);return}}var N=D.connectionStateTtl;N&&(this.connectionStateTtl=N),this.maxIdleInterval=D.maxIdleInterval,this.emit("connectiondetails",D)}},j.supportedTransports={},j}(C.default);R.default=F}).call(this,l(12))},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(10)),U=v.__importStar(l(2)),E=v.__importDefault(l(7)),I=v.__importDefault(l(3)),x=v.__importDefault(l(19)),b=v.__importDefault(l(5)),C=v.__importDefault(l(0)),y=s.default.Action,r=s.default.fromValues({action:y.CLOSE}),p=s.default.fromValues({action:y.DISCONNECT}),A=function(O){v.__extends(u,O);function u(f,c,t,e){var i=O.call(this)||this;return e&&(t.format=void 0,t.heartbeats=!0),i.connectionManager=f,f.registerProposedTransport(i),i.auth=c,i.params=t,i.timeouts=t.options.timeouts,i.format=t.format,i.isConnected=!1,i.isFinished=!1,i.isDisposed=!1,i.maxIdleInterval=null,i.idleTimer=null,i.lastActivity=null,i}return u.prototype.connect=function(){},u.prototype.close=function(){this.isConnected&&this.requestClose(),this.finish("closed",x.default.closed)},u.prototype.disconnect=function(f){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",f||x.default.disconnected)},u.prototype.fail=function(f){this.isConnected&&this.requestDisconnect(),this.finish("failed",f||x.default.failed)},u.prototype.finish=function(f,c){var t;this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout((t=this.idleTimer)!==null&&t!==void 0?t:void 0),this.idleTimer=null,this.emit(f,c),this.dispose())},u.prototype.onProtocolMessage=function(f){switch(I.default.shouldLog(I.default.LOG_MICRO)&&I.default.logAction(I.default.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+s.default.stringify(f)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),f.action){case y.HEARTBEAT:I.default.logAction(I.default.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",f.id);break;case y.CONNECTED:this.onConnect(f),this.emit("connected",f.error,f.connectionId,f.connectionDetails,f);break;case y.CLOSED:this.onClose(f);break;case y.DISCONNECTED:this.onDisconnect(f);break;case y.ACK:this.emit("ack",f.msgSerial,f.count);break;case y.NACK:this.emit("nack",f.msgSerial,f.count,f.error);break;case y.SYNC:if(f.connectionId!==void 0){this.emit("sync",f.connectionId,f);break}this.connectionManager.onChannelMessage(f,this);break;case y.AUTH:this.auth.authorize(function(c){c&&I.default.logAction(I.default.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+U.inspectError(c))});break;case y.ERROR:if(I.default.logAction(I.default.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+C.default.Config.inspect(f.error)+(f.channel?", channel: "+f.channel:"")),f.channel===void 0){this.onFatalError(f);break}this.connectionManager.onChannelMessage(f,this);break;default:this.connectionManager.onChannelMessage(f,this)}},u.prototype.onConnect=function(f){if(this.isConnected=!0,!f.connectionDetails)throw new Error("Transport.onConnect(): Connect message recieved without connectionDetails");var c=f.connectionDetails.maxIdleInterval;c&&(this.maxIdleInterval=c+this.timeouts.realtimeRequestTimeout,this.onActivity())},u.prototype.onDisconnect=function(f){var c=f&&f.error;I.default.logAction(I.default.LOG_MINOR,"Transport.onDisconnect()","err = "+U.inspectError(c)),this.finish("disconnected",c)},u.prototype.onFatalError=function(f){var c=f&&f.error;I.default.logAction(I.default.LOG_MINOR,"Transport.onFatalError()","err = "+U.inspectError(c)),this.finish("failed",c)},u.prototype.onClose=function(f){var c=f&&f.error;I.default.logAction(I.default.LOG_MINOR,"Transport.onClose()","err = "+U.inspectError(c)),this.finish("closed",c)},u.prototype.requestClose=function(){I.default.logAction(I.default.LOG_MINOR,"Transport.requestClose()",""),this.send(r)},u.prototype.requestDisconnect=function(){I.default.logAction(I.default.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(p)},u.prototype.ping=function(f){var c={action:s.default.Action.HEARTBEAT};f&&(c.id=f),this.send(s.default.fromValues(c))},u.prototype.dispose=function(){I.default.logAction(I.default.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()},u.prototype.onActivity=function(){!this.maxIdleInterval||(this.lastActivity=this.connectionManager.lastActivity=U.now(),this.setIdleTimer(this.maxIdleInterval+100))},u.prototype.setIdleTimer=function(f){var c=this;this.idleTimer||(this.idleTimer=setTimeout(function(){c.onIdleTimerExpire()},f))},u.prototype.onIdleTimerExpire=function(){if(!this.lastActivity||!this.maxIdleInterval)throw new Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;var f=U.now()-this.lastActivity,c=this.maxIdleInterval-f;if(c<=0){var t="No activity seen from realtime in "+f+"ms; assuming connection has dropped";I.default.logAction(I.default.LOG_ERROR,"Transport.onIdleTimerExpire()",t),this.disconnect(new b.default(t,80003,408))}else this.setIdleTimer(c+100)},u.tryConnect=function(f,c,t,e,i){var a=new f(c,t,e),o,n=function(m){clearTimeout(o),i({event:this.event,error:m})},d=c.options.timeouts.realtimeRequestTimeout;o=setTimeout(function(){a.off(["preconnect","disconnected","failed"]),a.dispose(),n.call({event:"disconnected"},new b.default("Timeout waiting for transport to indicate itself viable",5e4,500))},d),a.on(["failed","disconnected"],n),a.on("preconnect",function(){I.default.logAction(I.default.LOG_MINOR,"Transport.tryConnect()","viable transport "+a),clearTimeout(o),a.off(["failed","disconnected"],n),i(null,a)}),a.connect()},u}(E.default);R.default=A},function(z,R,l){(function(v,s){z.exports=s(l(6),l(40),l(23))})(this,function(v){return function(){var s=v,U=s.lib,E=U.Base,I=U.WordArray,x=s.algo,b=x.MD5,C=x.EvpKDF=E.extend({cfg:E.extend({keySize:128/32,hasher:b,iterations:1}),init:function(y){this.cfg=this.cfg.extend(y)},compute:function(y,r){for(var p,A=this.cfg,O=A.hasher.create(),u=I.create(),f=u.words,c=A.keySize,t=A.iterations;f.length<c;){p&&O.update(p),p=O.update(y).finalize(r),O.reset();for(var e=1;e<t;e++)p=O.finalize(p),O.reset();u.concat(p)}return u.sigBytes=c*4,u}});s.EvpKDF=function(y,r,p){return C.create(p).compute(y,r)}}(),v.EvpKDF})},function(z,R,l){(function(v,s){z.exports=s(l(6),l(27))})(this,function(v){v.lib.Cipher||function(s){var U=v,E=U.lib,I=E.Base,x=E.WordArray,b=E.BufferedBlockAlgorithm,C=U.enc;C.Utf8;var y=C.Base64,r=U.algo,p=r.EvpKDF,A=E.Cipher=b.extend({cfg:I.extend(),createEncryptor:function(S,T){return this.create(this._ENC_XFORM_MODE,S,T)},createDecryptor:function(S,T){return this.create(this._DEC_XFORM_MODE,S,T)},init:function(S,T,h){this.cfg=this.cfg.extend(h),this._xformMode=S,this._key=T,this.reset()},reset:function(){b.reset.call(this),this._doReset()},process:function(S){return this._append(S),this._process()},finalize:function(S){S&&this._append(S);var T=this._doFinalize();return T},keySize:128/32,ivSize:128/32,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function S(T){return typeof T=="string"?m:o}return function(T){return{encrypt:function(h,g,P){return S(g).encrypt(T,h,g,P)},decrypt:function(h,g,P){return S(g).decrypt(T,h,g,P)}}}}()});E.StreamCipher=A.extend({_doFinalize:function(){var S=this._process(!0);return S},blockSize:1});var O=U.mode={},u=E.BlockCipherMode=I.extend({createEncryptor:function(S,T){return this.Encryptor.create(S,T)},createDecryptor:function(S,T){return this.Decryptor.create(S,T)},init:function(S,T){this._cipher=S,this._iv=T}}),f=O.CBC=function(){var S=u.extend();S.Encryptor=S.extend({processBlock:function(h,g){var P=this._cipher,L=P.blockSize;T.call(this,h,g,L),P.encryptBlock(h,g),this._prevBlock=h.slice(g,g+L)}}),S.Decryptor=S.extend({processBlock:function(h,g){var P=this._cipher,L=P.blockSize,B=h.slice(g,g+L);P.decryptBlock(h,g),T.call(this,h,g,L),this._prevBlock=B}});function T(h,g,P){var L,B=this._iv;B?(L=B,this._iv=s):L=this._prevBlock;for(var F=0;F<P;F++)h[g+F]^=L[F]}return S}(),c=U.pad={},t=c.Pkcs7={pad:function(S,T){for(var h=T*4,g=h-S.sigBytes%h,P=g<<24|g<<16|g<<8|g,L=[],B=0;B<g;B+=4)L.push(P);var F=x.create(L,g);S.concat(F)},unpad:function(S){var T=S.words[S.sigBytes-1>>>2]&255;S.sigBytes-=T}};E.BlockCipher=A.extend({cfg:A.cfg.extend({mode:f,padding:t}),reset:function(){var S;A.reset.call(this);var T=this.cfg,h=T.iv,g=T.mode;this._xformMode==this._ENC_XFORM_MODE?S=g.createEncryptor:(S=g.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==S?this._mode.init(this,h&&h.words):(this._mode=S.call(g,this,h&&h.words),this._mode.__creator=S)},_doProcessBlock:function(S,T){this._mode.processBlock(S,T)},_doFinalize:function(){var S,T=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(T.pad(this._data,this.blockSize),S=this._process(!0)):(S=this._process(!0),T.unpad(S)),S},blockSize:128/32});var e=E.CipherParams=I.extend({init:function(S){this.mixIn(S)},toString:function(S){return(S||this.formatter).stringify(this)}}),i=U.format={},a=i.OpenSSL={stringify:function(S){var T,h=S.ciphertext,g=S.salt;return g?T=x.create([1398893684,1701076831]).concat(g).concat(h):T=h,T.toString(y)},parse:function(S){var T,h=y.parse(S),g=h.words;return g[0]==1398893684&&g[1]==1701076831&&(T=x.create(g.slice(2,4)),g.splice(0,4),h.sigBytes-=16),e.create({ciphertext:h,salt:T})}},o=E.SerializableCipher=I.extend({cfg:I.extend({format:a}),encrypt:function(S,T,h,g){g=this.cfg.extend(g);var P=S.createEncryptor(h,g),L=P.finalize(T),B=P.cfg;return e.create({ciphertext:L,key:h,iv:B.iv,algorithm:S,mode:B.mode,padding:B.padding,blockSize:S.blockSize,formatter:g.format})},decrypt:function(S,T,h,g){g=this.cfg.extend(g),T=this._parse(T,g.format);var P=S.createDecryptor(h,g).finalize(T.ciphertext);return P},_parse:function(S,T){return typeof S=="string"?T.parse(S,this):S}}),n=U.kdf={},d=n.OpenSSL={execute:function(S,T,h,g){g||(g=x.random(64/8));var P=p.create({keySize:T+h}).compute(S,g),L=x.create(P.words.slice(T),h*4);return P.sigBytes=T*4,e.create({key:P,iv:L,salt:g})}},m=E.PasswordBasedCipher=o.extend({cfg:o.cfg.extend({kdf:d}),encrypt:function(S,T,h,g){g=this.cfg.extend(g);var P=g.kdf.execute(h,S.keySize,S.ivSize);g.iv=P.iv;var L=o.encrypt.call(this,S,T,P.key,g);return L.mixIn(P),L},decrypt:function(S,T,h,g){g=this.cfg.extend(g),T=this._parse(T,g.format);var P=g.kdf.execute(h,S.keySize,S.ivSize,T.salt);g.iv=P.iv;var L=o.decrypt.call(this,S,T,P.key,g);return L}})}()})},function(z,R,l){R.__esModule=!0,R.Request=R.createRequest=void 0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(11)),E=v.__importDefault(l(0)),I=v.__importDefault(l(7)),x=v.__importDefault(l(5)),b=v.__importDefault(l(8)),C=v.__importDefault(l(3)),y=v.__importDefault(l(20)),r=s.getGlobalObject(),p=function(){},A=r._ablyjs_jsonp={};A._=function(i){return A["_"+i]||p};var O=1,u="jsonp";function f(i,a,o,n,d,m,S){return m=m||b.default.TIMEOUTS,new t(void 0,i,a,s.copy(o),n,d,m,S)}R.createRequest=f;var c=function(i){v.__extends(a,i);function a(o,n,d){var m=i.call(this,o,n,d)||this;return m.shortName=u,d.stream=!1,m}return a.isAvailable=function(){return E.default.Config.jsonpSupported&&E.default.Config.allowComet},a.prototype.toString=function(){return"JSONPTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},a.prototype.createRequest=function(o,n,d,m,S,T,h){return T=(this===null||this===void 0?void 0:this.timeouts)||T||b.default.TIMEOUTS,f(o,n,d,m,S,T,h)},a}(U.default),t=function(i){v.__extends(a,i);function a(o,n,d,m,S,T,h,g){var P=i.call(this)||this;return o===void 0&&(o=O++),P.id=o,P.uri=n,P.params=m||{},P.params.rnd=s.cheapRandStr(),d&&(d["X-Ably-Version"]&&(P.params.v=d["X-Ably-Version"]),d["X-Ably-Lib"]&&(P.params.lib=d["X-Ably-Lib"])),P.body=S,P.method=g,P.requestMode=T,P.timeouts=h,P.requestComplete=!1,P}return a.prototype.exec=function(){var o=this,n=this.id,d=this.body,m=this.method,S=this.uri,T=this.params;T.callback="_ablyjs_jsonp._("+n+")",T.envelope="jsonp",d&&(T.body=d),m&&m!=="get"&&(T.method=m);var h=this.script=document.createElement("script"),g=S+s.toQueryString(T);h.src=g,h.src.split("/").slice(-1)[0]!==g.split("/").slice(-1)[0]&&C.default.logAction(C.default.LOG_ERROR,"JSONP Request.exec()","Warning: the browser appears to have truncated the script URI. This will likely result in the request failing due to an unparseable body param"),h.async=!0,h.type="text/javascript",h.charset="UTF-8",h.onerror=function(B){o.complete(new x.default("JSONP script error (event: "+E.default.Config.inspect(B)+")",null,400))},A["_"+n]=function(B){if(B.statusCode){var F=B.response;if(B.statusCode==204)o.complete(null,null,null,B.statusCode);else if(!F)o.complete(new x.default("Invalid server response: no envelope detected",null,500));else if(B.statusCode<400||s.isArray(F))o.complete(null,F,B.headers,B.statusCode);else{var V=F.error||new x.default("Error response received from server",null,B.statusCode);o.complete(V)}}else o.complete(null,B)};var P=this.requestMode==y.default.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout;this.timer=setTimeout(this.abort.bind(this),P);var L=document.getElementsByTagName("head")[0];L.insertBefore(h,L.firstChild)},a.prototype.complete=function(o,n,d,m){if(d=d||{},!this.requestComplete){this.requestComplete=!0;var S=void 0;n&&(S=typeof n=="string"?"text/plain":"application/json",d["content-type"]=S,this.emit("data",n)),this.emit("complete",o,n,d,!0,m),this.dispose()}},a.prototype.abort=function(){this.dispose()},a.prototype.dispose=function(){var o=this.timer;o&&(clearTimeout(o),this.timer=null);var n=this.script;n.parentNode&&n.parentNode.removeChild(n),delete A[this.id],this.emit("disposed")},a}(I.default);R.Request=t;function e(i){return r.JSONPTransport=c,c.isAvailable()&&(i.supportedTransports[u]=c),c}R.default=e},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(3)),E=v.__importDefault(l(8)),I=v.__importDefault(l(16)),x=v.__importDefault(l(46)),b=v.__importDefault(l(18)),C=v.__importDefault(l(33)),y=v.__importDefault(l(5)),r=v.__importDefault(l(49)),p=v.__importDefault(l(17)),A=v.__importDefault(l(0)),O=function(){},u=function(){function c(t){if(!t){var e="no options provided";throw U.default.logAction(U.default.LOG_ERROR,"Rest()",e),new Error(e)}var i=E.default.objectifyOptions(t);i.log&&U.default.setLog(i.log.level,i.log.handler),U.default.logAction(U.default.LOG_MICRO,"Rest()","initialized with clientOptions "+A.default.Config.inspect(t));var a=this.options=E.default.normaliseOptions(i);if(a.key){var o=a.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!o){var e="invalid key parameter";throw U.default.logAction(U.default.LOG_ERROR,"Rest()",e),new y.default(e,40400,404)}a.keyName=o[1],a.keySecret=o[2]}if("clientId"in a)if(typeof a.clientId=="string"||a.clientId===null){if(a.clientId==="*")throw new y.default('Can\u2019t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}else throw new y.default("clientId must be either a string or null",40012,400);U.default.logAction(U.default.LOG_MINOR,"Rest()","started; version = "+E.default.version),this.baseUri=this.authority=function(n){return E.default.getHttpScheme(a)+n+":"+E.default.getPort(a,!1)},this._currentFallback=null,this.serverTimeOffset=null,this.http=new A.default.Http(a),this.auth=new I.default(this,a),this.channels=new f(this),this.push=new x.default(this)}return c.prototype.stats=function(t,e){if(e===void 0)if(typeof t=="function")e=t,t=null;else{if(this.options.promises)return s.promisify(this,"stats",[t]);e=O}var i=s.defaultGetHeaders(this.options),a=this.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,o=this.http.supportsLinkHeaders?void 0:a;this.options.headers&&s.mixin(i,this.options.headers),new b.default(this,"/stats",i,o,function(n,d,m){for(var S=m?n:JSON.parse(n),T=0;T<S.length;T++)S[T]=r.default.fromValues(S[T]);return S}).get(t,e)},c.prototype.time=function(t,e){var i=this;if(e===void 0){if(typeof t=="function")e=t,t=null;else if(this.options.promises)return s.promisify(this,"time",[t])}var a=e||O,o=s.defaultGetHeaders(this.options);this.options.headers&&s.mixin(o,this.options.headers);var n=function(d){return i.authority(d)+"/time"};this.http.do(p.default.Get,this,n,o,null,t,function(d,m,S,T){if(d){a(d);return}T||(m=JSON.parse(m));var h=m[0];if(!h){a(new y.default("Internal error (unexpected result type from GET /time)",5e4,500));return}i.serverTimeOffset=h-s.now(),a(null,h)})},c.prototype.request=function(t,e,i,a,o,n){var d=this.options.useBinaryProtocol,m=d?A.default.Config.msgpack.encode:JSON.stringify,S=d?A.default.Config.msgpack.decode:JSON.parse,T=d?s.Format.msgpack:s.Format.json,h=this.http.supportsLinkHeaders?void 0:T;i=i||{};var g=t.toLowerCase(),P=g=="get"?s.defaultGetHeaders(this.options,T):s.defaultPostHeaders(this.options,T);if(n===void 0){if(this.options.promises)return s.promisify(this,"request",[t,e,i,a,o]);n=O}typeof a!="string"&&(a=m(a)),this.options.headers&&s.mixin(P,this.options.headers),o&&s.mixin(P,o);var L=new b.default(this,e,P,h,function(B,F,V){return s.ensureArray(V?B:S(B))},!0);if(!s.arrIn(A.default.Http.methods,g))throw new y.default("Unsupported method "+g,40500,405);s.arrIn(A.default.Http.methodsWithBody,g)?L[g](i,a,n):L[g](i,n)},c.prototype.setLog=function(t){U.default.setLog(t.level,t.handler)},c.Promise=function(t){return t=E.default.objectifyOptions(t),t.promises=!0,new c(t)},c.Callbacks=c,c.Platform=A.default,c}(),f=function(){function c(t){this.rest=t,this.all=Object.create(null)}return c.prototype.get=function(t,e){t=String(t);var i=this.all[t];return i?e&&i.setOptions(e):this.all[t]=i=new C.default(this.rest,t,e),i},c.prototype.release=function(t){delete this.all[String(t)]},c}();R.default=u},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){return function(s){var U=v,E=U.lib,I=E.WordArray,x=E.Hasher,b=U.algo,C=[],y=[];(function(){function A(c){for(var t=s.sqrt(c),e=2;e<=t;e++)if(!(c%e))return!1;return!0}function O(c){return(c-(c|0))*4294967296|0}for(var u=2,f=0;f<64;)A(u)&&(f<8&&(C[f]=O(s.pow(u,1/2))),y[f]=O(s.pow(u,1/3)),f++),u++})();var r=[],p=b.SHA256=x.extend({_doReset:function(){this._hash=new I.init(C.slice(0))},_doProcessBlock:function(A,O){for(var u=this._hash.words,f=u[0],c=u[1],t=u[2],e=u[3],i=u[4],a=u[5],o=u[6],n=u[7],d=0;d<64;d++){if(d<16)r[d]=A[O+d]|0;else{var m=r[d-15],S=(m<<25|m>>>7)^(m<<14|m>>>18)^m>>>3,T=r[d-2],h=(T<<15|T>>>17)^(T<<13|T>>>19)^T>>>10;r[d]=S+r[d-7]+h+r[d-16]}var g=i&a^~i&o,P=f&c^f&t^c&t,L=(f<<30|f>>>2)^(f<<19|f>>>13)^(f<<10|f>>>22),B=(i<<26|i>>>6)^(i<<21|i>>>11)^(i<<7|i>>>25),F=n+B+g+y[d]+r[d],V=L+P;n=o,o=a,a=i,i=e+F|0,e=t,t=c,c=f,f=F+V|0}u[0]=u[0]+f|0,u[1]=u[1]+c|0,u[2]=u[2]+t|0,u[3]=u[3]+e|0,u[4]=u[4]+i|0,u[5]=u[5]+a|0,u[6]=u[6]+o|0,u[7]=u[7]+n|0},_doFinalize:function(){var A=this._data,O=A.words,u=this._nDataBytes*8,f=A.sigBytes*8;return O[f>>>5]|=128<<24-f%32,O[(f+64>>>9<<4)+14]=s.floor(u/4294967296),O[(f+64>>>9<<4)+15]=u,A.sigBytes=O.length*4,this._process(),this._hash},clone:function(){var A=x.clone.call(this);return A._hash=this._hash.clone(),A}});U.SHA256=x._createHelper(p),U.HmacSHA256=x._createHmacHelper(p)}(Math),v.SHA256})},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){return v.enc.Utf8})},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(7)),E=v.__importDefault(l(3)),I=v.__importDefault(l(34)),x=v.__importDefault(l(9)),b=v.__importDefault(l(5)),C=v.__importDefault(l(18)),y=v.__importDefault(l(24)),r=v.__importDefault(l(0));function p(){}var A=9;function O(c){return s.arrEvery(c,function(t){return!t.id})}function u(c){var t=c||{};if(t.cipher){if(!r.default.Crypto)throw new Error("Encryption not enabled; use ably.encryption.js instead");var e=r.default.Crypto.getCipher(t.cipher);t.cipher=e.cipherParams,t.channelCipher=e.cipher}else"cipher"in t&&(t.cipher=void 0,t.channelCipher=null);return t}var f=function(c){v.__extends(t,c);function t(e,i,a){var o=c.call(this)||this;return E.default.logAction(E.default.LOG_MINOR,"Channel()","started; name = "+i),o.rest=e,o.name=i,o.basePath="/channels/"+encodeURIComponent(i),o.presence=new I.default(o),o.channelOptions=u(a),o}return t.prototype.setOptions=function(e){this.channelOptions=u(e)},t.prototype.history=function(e,i){if(E.default.logAction(E.default.LOG_MICRO,"Channel.history()","channel = "+this.name),i===void 0)if(typeof e=="function")i=e,e=null;else{if(this.rest.options.promises)return s.promisify(this,"history",arguments);i=p}this._history(e,i)},t.prototype._history=function(e,i){var a=this.rest,o=a.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,n=this.rest.http.supportsLinkHeaders?void 0:o,d=s.defaultGetHeaders(a.options,o);a.options.headers&&s.mixin(d,a.options.headers);var m=this.channelOptions;new C.default(a,this.basePath+"/messages",d,n,function(S,T,h){return x.default.fromResponseBody(S,m,h?void 0:o)}).get(e,i)},t.prototype.publish=function(){var e=this,i=arguments.length,a=arguments[0],o=arguments[1],n=arguments[i-1],d,m;if(typeof n!="function"){if(this.rest.options.promises)return s.promisify(this,"publish",arguments);n=p}if(typeof a=="string"||a===null)d=[x.default.fromValues({name:a,data:o})],m=arguments[2];else if(s.isObject(a))d=[x.default.fromValues(a)],m=arguments[1];else if(s.isArray(a))d=x.default.fromValuesArray(a),m=arguments[1];else throw new b.default("The single-argument form of publish() expects a message object or an array of message objects",40013,400);(typeof m!="object"||!m)&&(m={});var S=this.rest,T=S.options,h=T.useBinaryProtocol?s.Format.msgpack:s.Format.json,g=S.options.idempotentRestPublishing,P=s.defaultPostHeaders(S.options,h);if(T.headers&&s.mixin(P,T.headers),g&&O(d)){var L=s.randomString(A);s.arrForEach(d,function(B,F){B.id=L+":"+F.toString()})}x.default.encodeArray(d,this.channelOptions,function(B){if(B){n(B);return}var F=x.default.getMessagesSize(d),V=T.maxMessageSize;if(F>V){n(new b.default("Maximum size of messages that can be published at once exceeded ( was "+F+" bytes; limit is "+V+" bytes)",40009,400));return}e._publish(x.default.serialize(d,h),P,m,n)})},t.prototype._publish=function(e,i,a,o){y.default.post(this.rest,this.basePath+"/messages",e,i,a,null,o)},t.prototype.status=function(e){if(typeof e!="function"&&this.rest.options.promises)return s.promisify(this,"status",[]);var i=this.rest.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,a=s.defaultPostHeaders(this.rest.options,i);y.default.get(this.rest,this.basePath,a,{},i,e||p)},t}(U.default);R.default=f},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(7)),E=v.__importDefault(l(3)),I=v.__importDefault(l(18)),x=v.__importDefault(l(14));function b(){}var C=function(y){v.__extends(r,y);function r(p){var A=y.call(this)||this;return A.channel=p,A.basePath=p.basePath+"/presence",A}return r.prototype.get=function(p,A){if(E.default.logAction(E.default.LOG_MICRO,"Presence.get()","channel = "+this.channel.name),A===void 0)if(typeof p=="function")A=p,p=null;else{if(this.channel.rest.options.promises)return s.promisify(this,"get",arguments);A=b}var O=this.channel.rest,u=O.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,f=this.channel.rest.http.supportsLinkHeaders?void 0:u,c=s.defaultGetHeaders(O.options,u);O.options.headers&&s.mixin(c,O.options.headers);var t=this.channel.channelOptions;new I.default(O,this.basePath,c,f,function(e,i,a){return x.default.fromResponseBody(e,t,a?void 0:u)}).get(p,A)},r.prototype.history=function(p,A){E.default.logAction(E.default.LOG_MICRO,"Presence.history()","channel = "+this.channel.name),this._history(p,A)},r.prototype._history=function(p,A){if(A===void 0)if(typeof p=="function")A=p,p=null;else{if(this.channel.rest.options.promises)return s.promisify(this,"_history",arguments);A=b}var O=this.channel.rest,u=O.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,f=this.channel.rest.http.supportsLinkHeaders?void 0:u,c=s.defaultGetHeaders(O.options,u);O.options.headers&&s.mixin(c,O.options.headers);var t=this.channel.channelOptions;new I.default(O,this.basePath+"/history",c,f,function(e,i,a){return x.default.fromResponseBody(e,t,a?void 0:u)}).get(p,A)},r}(U.default);R.default=C},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(7)),U=v.__importDefault(l(3)),E=function(I){v.__extends(x,I);function x(){var b=I.call(this)||this;return b.messages=[],b}return x.prototype.count=function(){return this.messages.length},x.prototype.push=function(b){this.messages.push(b)},x.prototype.shift=function(){return this.messages.shift()},x.prototype.last=function(){return this.messages[this.messages.length-1]},x.prototype.copyAll=function(){return this.messages.slice()},x.prototype.append=function(b){this.messages.push.apply(this.messages,b)},x.prototype.prepend=function(b){this.messages.unshift.apply(this.messages,b)},x.prototype.completeMessages=function(b,C,y){U.default.logAction(U.default.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+b+"; count = "+C),y=y||null;var r=this.messages;if(r.length===0)throw new Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");var p=r[0];if(p){var A=p.message.msgSerial,O=b+C;if(O>A)for(var u=r.splice(0,O-A),f=0,c=u;f<c.length;f++){var t=c[f];t.callback(y)}r.length==0&&this.emit("idle")}},x.prototype.completeAllMessages=function(b){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,b)},x.prototype.clear=function(){U.default.logAction(U.default.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")},x}(s.default);R.default=E},function(z,R,l){R.__esModule=!0;var v=function(){function s(U,E,I,x){this.previous=U,this.current=E,I&&(this.retryIn=I),x&&(this.reason=x)}return s}();R.default=v},function(z,R,l){R.__esModule=!0,R.isSuccessCode=void 0;var v;(function(U){U[U.Success=200]="Success",U[U.NoContent=204]="NoContent",U[U.BadRequest=400]="BadRequest",U[U.Unauthorized=401]="Unauthorized",U[U.Forbidden=403]="Forbidden",U[U.RequestTimeout=408]="RequestTimeout",U[U.InternalServerError=500]="InternalServerError"})(v||(v={}));function s(U){return U>=v.Success&&U<v.BadRequest}R.isSuccessCode=s,R.default=v},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(10)),U=v.__importDefault(l(7)),E=v.__importStar(l(2)),I=v.__importDefault(l(33)),x=v.__importDefault(l(3)),b=v.__importDefault(l(54)),C=v.__importDefault(l(9)),y=v.__importDefault(l(39)),r=v.__importDefault(l(5)),p=v.__importDefault(l(14)),A=v.__importDefault(l(19)),O=s.default.Action,u=function(){},f="statechange",c="sync";function t(i){if(i&&"params"in i&&!E.isObject(i.params))return new r.default("options.params must be an object",4e4,400);if(i&&"modes"in i){if(!E.isArray(i.modes))return new r.default("options.modes must be an array",4e4,400);for(var a=0;a<i.modes.length;a++){var o=i.modes[a];if(!o||typeof o!="string"||!E.arrIn(s.default.channelModes,String.prototype.toUpperCase.call(o)))return new r.default("Invalid channel mode: "+o,4e4,400)}}}var e=function(i){v.__extends(a,i);function a(o,n,d){var m=i.call(this,o,n,d)||this;return m.retryCount=0,m.history=function(S,T){if(x.default.logAction(x.default.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name),T===void 0)if(typeof S=="function")T=S,S=null;else{if(this.rest.options.promises)return E.promisify(this,"history",arguments);T=u}if(S&&S.untilAttach){if(this.state!=="attached"){T(new r.default("option untilAttach requires the channel to be attached",4e4,400));return}if(!this.properties.attachSerial){T(new r.default("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400));return}delete S.untilAttach,S.from_serial=this.properties.attachSerial}I.default.prototype._history.call(this,S,T)},m.whenState=function(S,T){return U.default.prototype.whenState.call(m,S,m.state,T)},x.default.logAction(x.default.LOG_MINOR,"RealtimeChannel()","started; name = "+n),m.realtime=o,m.presence=new b.default(m),m.connectionManager=o.connection.connectionManager,m.state="initialized",m.subscriptions=new U.default,m.syncChannelSerial=void 0,m.properties={attachSerial:void 0},m.setOptions(d),m.errorReason=null,m._requestedFlags=null,m._mode=null,m._attachedMsgIndicator=!1,m._attachResume=!1,m._decodingContext={channelOptions:m.channelOptions,plugins:o.options.plugins||{},baseEncodedPreviousPayload:void 0},m._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},m._allChannelChanges=new U.default,m}return a.invalidStateError=function(o){return{statusCode:400,code:90001,message:"Channel operation failed as channel state is "+o}},a.processListenerArgs=function(o){return o=Array.prototype.slice.call(o),typeof o[0]=="function"&&o.unshift(null),o[o.length-1]==null&&o.pop(),o},a.prototype.setOptions=function(o,n){if(!n&&this.rest.options.promises)return E.promisify(this,"setOptions",arguments);var d=n||function(S){S&&x.default.logAction(x.default.LOG_ERROR,"RealtimeChannel.setOptions()","Set options failed: "+S.toString())},m=t(o);if(m){d(m);return}I.default.prototype.setOptions.call(this,o),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(o)?(this.attachImpl(),this._allChannelChanges.once(function(S){switch(this.event){case"update":case"attached":d==null||d(null);return;default:d==null||d(S.reason);return}})):d()},a.prototype._shouldReattachToSetOptions=function(o){return(this.state==="attached"||this.state==="attaching")&&(o.params||o.modes)},a.prototype.publish=function(){for(var o=this,n=[],d=0;d<arguments.length;d++)n[d]=arguments[d];var m=n[0],S=n.length,T=n[S-1];if(typeof T!="function"){if(this.realtime.options.promises)return E.promisify(this,"publish",arguments);T=u,++S}if(!this.connectionManager.activeState()){T(this.connectionManager.getError());return}if(S==2)if(E.isObject(m))m=[C.default.fromValues(m)];else if(E.isArray(m))m=C.default.fromValuesArray(m);else throw new r.default("The single-argument form of publish() expects a message object or an array of message objects",40013,400);else m=[C.default.fromValues({name:n[0],data:n[1]})];var h=this.realtime.options.maxMessageSize;C.default.encodeArray(m,this.channelOptions,function(g){if(g){T(g);return}var P=C.default.getMessagesSize(m);if(P>h){T(new r.default("Maximum size of messages that can be published at once exceeded ( was "+P+" bytes; limit is "+h+" bytes)",40009,400));return}o.__publish(m,T)})},a.prototype.__publish=function(o,n){x.default.logAction(x.default.LOG_MICRO,"RealtimeChannel.publish()","message count = "+o.length);var d=this.state;switch(d){case"failed":case"suspended":n(r.default.fromValues(a.invalidStateError(d)));break;default:{x.default.logAction(x.default.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+d);var m=new s.default;m.action=O.MESSAGE,m.channel=this.name,m.messages=o,this.sendMessage(m,n);break}}},a.prototype.onEvent=function(o){x.default.logAction(x.default.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var n=this.subscriptions,d=0;d<o.length;d++){var m=o[d];n.emit(m.name,m)}},a.prototype.attach=function(o,n){var d;if(typeof o=="function"?(n=o,d=null):d=o,!n){if(this.realtime.options.promises)return E.promisify(this,"attach",arguments);n=function(m){m&&x.default.logAction(x.default.LOG_MAJOR,"RealtimeChannel.attach()","Channel attach failed: "+m.toString())}}if(d)x.default.deprecated("channel.attach() with flags","channel.setOptions() with channelOptions.params"),this._requestedFlags=d;else if(this.state==="attached"){n();return}this._attach(!1,null,n)},a.prototype._attach=function(o,n,d){d||(d=function(S){S&&x.default.logAction(x.default.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+S.toString())});var m=this.connectionManager;if(!m.activeState()){d(m.getError());return}(this.state!=="attaching"||o)&&this.requestState("attaching",n),this.once(function(S){switch(this.event){case"attached":d==null||d();break;case"detached":case"suspended":case"failed":d==null||d(S.reason||m.getError()||new r.default("Unable to attach; reason unknown; state = "+this.event,9e4,500));break;case"detaching":d==null||d(new r.default("Attach request superseded by a subsequent detach request",9e4,409));break}})},a.prototype.attachImpl=function(){x.default.logAction(x.default.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message"),this.setInProgress(f,!0);var o=s.default.fromValues({action:O.ATTACH,channel:this.name,params:this.channelOptions.params});this._requestedFlags?o.encodeModesToFlags(this._requestedFlags):this.channelOptions.modes&&o.encodeModesToFlags(E.allToUpperCase(this.channelOptions.modes)),this._attachResume&&o.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(o.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(o,u)},a.prototype.detach=function(o){if(!o){if(this.realtime.options.promises)return E.promisify(this,"detach",arguments);o=u}var n=this.connectionManager;if(!n.activeState()){o(n.getError());return}switch(this.state){case"suspended":this.notifyState("detached"),o();break;case"detached":o();break;case"failed":o(new r.default("Unable to detach; channel state = failed",90001,400));break;default:this.requestState("detaching");case"detaching":this.once(function(d){switch(this.event){case"detached":o();break;case"attached":case"suspended":case"failed":o(d.reason||n.getError()||new r.default("Unable to detach; reason unknown; state = "+this.event,9e4,500));break;case"attaching":o(new r.default("Detach request superseded by a subsequent attach request",9e4,409));break}})}},a.prototype.detachImpl=function(o){this.connectionManager.mostRecentMsg&&this.connectionManager.mostRecentMsg.channel===this.name&&(this.connectionManager.mostRecentMsg=null),x.default.logAction(x.default.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message"),this.setInProgress(f,!0);var n=s.default.fromValues({action:O.DETACH,channel:this.name});this.sendMessage(n,o||u)},a.prototype.subscribe=function(){for(var o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];var d=a.processListenerArgs(o),m=d[0],S=d[1],T=d[2];if(!T&&this.realtime.options.promises)return E.promisify(this,"subscribe",[m,S]);if(this.state==="failed"){T==null||T(r.default.fromValues(a.invalidStateError("failed")));return}return m&&typeof m=="object"&&!Array.isArray(m)?this._subscribeFilter(m,S):this.subscriptions.on(m,S),this.attach(T||u)},a.prototype._subscribeFilter=function(o,n){var d=function(m){var S,T,h,g,P,L,B={name:m.name,refTimeserial:(T=(S=m.extras)===null||S===void 0?void 0:S.ref)===null||T===void 0?void 0:T.timeserial,refType:(g=(h=m.extras)===null||h===void 0?void 0:h.ref)===null||g===void 0?void 0:g.type,isRef:!!(!((L=(P=m.extras)===null||P===void 0?void 0:P.ref)===null||L===void 0)&&L.timeserial),clientId:m.clientId};Object.entries(o).find(function(F){var V=F[0],j=F[1];return j!==void 0?B[V]!==j:!1})||n(m)};this._addFilteredSubscription(o,n,d),this.subscriptions.on(d)},a.prototype._addFilteredSubscription=function(o,n,d){var m;if(this.filteredSubscriptions||(this.filteredSubscriptions=new Map),this.filteredSubscriptions.has(n)){var S=this.filteredSubscriptions.get(n);S.set(o,((m=S==null?void 0:S.get(o))===null||m===void 0?void 0:m.concat(d))||[d])}else this.filteredSubscriptions.set(n,new Map([[o,[d]]]))},a.prototype._getAndDeleteFilteredSubscriptions=function(o,n){var d=this;if(!this.filteredSubscriptions)return[];if(!n&&o)return Array.from(this.filteredSubscriptions.entries()).map(function(h){var g,P=h[0],L=h[1],B=L.get(o);return L.delete(o),L.size===0&&((g=d.filteredSubscriptions)===null||g===void 0||g.delete(P)),B}).reduce(function(h,g){var P;return g?(P=h).concat.apply(P,g):h},[]);if(!n||!this.filteredSubscriptions.has(n))return[];var m=this.filteredSubscriptions.get(n);if(!o){var S=Array.from(m.values()).reduce(function(h,g){return h.concat.apply(h,g)},[]);return this.filteredSubscriptions.delete(n),S}var T=m.get(o);return m.delete(o),T||[]},a.prototype.unsubscribe=function(){for(var o=this,n,d=[],m=0;m<arguments.length;m++)d[m]=arguments[m];var S=a.processListenerArgs(d),T=S[0],h=S[1];if(typeof T=="object"&&!h||((n=this.filteredSubscriptions)===null||n===void 0?void 0:n.has(h))){this._getAndDeleteFilteredSubscriptions(T,h).forEach(function(g){return o.subscriptions.off(g)});return}this.subscriptions.off(T,h)},a.prototype.sync=function(){switch(this.state){case"initialized":case"detaching":case"detached":throw new r.default("Unable to sync to channel; not attached",4e4)}var o=this.connectionManager;if(!o.activeState())throw o.getError();var n=s.default.fromValues({action:O.SYNC,channel:this.name});this.syncChannelSerial&&(n.channelSerial=this.syncChannelSerial),o.send(n)},a.prototype.sendMessage=function(o,n){this.connectionManager.send(o,this.realtime.options.queueMessages,n)},a.prototype.sendPresence=function(o,n){var d=s.default.fromValues({action:O.PRESENCE,channel:this.name,presence:E.isArray(o)?p.default.fromValuesArray(o):[p.default.fromValues(o)]});this.sendMessage(d,n)},a.prototype.onMessage=function(o){var n,d=!1;switch(o.action){case O.ATTACHED:{this._attachedMsgIndicator=!0,this.properties.attachSerial=o.channelSerial,this._mode=o.getMode(),this.params=o.params||{};var m=o.decodeModesFromFlags();this.modes=m&&E.allToLowerCase(m)||void 0;var S=o.hasFlag("RESUMED"),T=o.hasFlag("HAS_PRESENCE");if(this.state==="attached"){this.setInProgress(f,!1),S||this.presence.onAttached(T);var h=new y.default(this.state,this.state,S,o.error);this._allChannelChanges.emit("update",h),(!S||this.channelOptions.updateOnAttached)&&this.emit("update",h)}else this.state==="detaching"?this.checkPendingState():this.notifyState("attached",o.error,S,T);break}case O.DETACHED:{var g=o.error?r.default.fromValues(o.error):new r.default("Channel detached",90001,404);this.state==="detaching"?this.notifyState("detached",g):this.state==="attaching"?this.notifyState("suspended",g):this.requestState("attaching",g);break}case O.SYNC:if(d=!0,n=this.syncChannelSerial=o.channelSerial,!o.presence)break;case O.PRESENCE:{for(var P=o.presence,L=o.id,B=o.connectionId,F=o.timestamp,V=this.channelOptions,j=void 0,D=0;D<P.length;D++)try{j=P[D],p.default.decode(j,V),j.connectionId||(j.connectionId=B),j.timestamp||(j.timestamp=F),j.id||(j.id=L+":"+D)}catch(K){x.default.logAction(x.default.LOG_ERROR,"RealtimeChannel.onMessage()",K.toString())}this.presence.setPresence(P,d,n);break}case O.MESSAGE:{if(this.state!=="attached"){x.default.logAction(x.default.LOG_MAJOR,"RealtimeChannel.onMessage()",'Message "'+o.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');return}var M=o.messages,w=M[0],G=M[M.length-1],L=o.id,B=o.connectionId,F=o.timestamp;if(w.extras&&w.extras.delta&&w.extras.delta.from!==this._lastPayload.messageId){var N='Delta message decode failure - previous message not available for message "'+o.id+'" on this channel "'+this.name+'".';x.default.logAction(x.default.LOG_ERROR,"RealtimeChannel.onMessage()",N),this._startDecodeFailureRecovery(new r.default(N,40018,400));break}for(var D=0;D<M.length;D++){var N=M[D];try{C.default.decode(N,this._decodingContext)}catch(Q){switch(x.default.logAction(x.default.LOG_ERROR,"RealtimeChannel.onMessage()",Q.toString()),Q.code){case 40018:this._startDecodeFailureRecovery(Q);return;case 40019:case 40021:this.notifyState("failed",Q);return}}N.connectionId||(N.connectionId=B),N.timestamp||(N.timestamp=F),N.id||(N.id=L+":"+D)}this._lastPayload.messageId=G.id,this._lastPayload.protocolMessageChannelSerial=o.channelSerial,this.onEvent(M);break}case O.ERROR:{var W=o.error;W&&W.code==80016?this.checkPendingState():this.notifyState("failed",r.default.fromValues(W));break}default:x.default.logAction(x.default.LOG_ERROR,"RealtimeChannel.onMessage()","Fatal protocol error: unrecognised action ("+o.action+")"),this.connectionManager.abort(A.default.unknownChannelErr)}},a.prototype._startDecodeFailureRecovery=function(o){var n=this;this._lastPayload.decodeFailureRecoveryInProgress||(x.default.logAction(x.default.LOG_MAJOR,"RealtimeChannel.onMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,o,function(){n._lastPayload.decodeFailureRecoveryInProgress=!1}))},a.prototype.onAttached=function(){x.default.logAction(x.default.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)},a.prototype.notifyState=function(o,n,d,m){if(x.default.logAction(x.default.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+o),this.clearStateTimer(),o!==this.state){this.presence.actOnChannelState(o,m,n),o==="suspended"&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),n&&(this.errorReason=n);var S=new y.default(this.state,o,d,n),T=o==="failed"?x.default.LOG_ERROR:x.default.LOG_MAJOR;x.default.logAction(T,'Channel state for channel "'+this.name+'"',o+(n?"; reason: "+n:"")),o!=="attaching"&&o!=="suspended"&&(this.retryCount=0),o==="attached"?(this.onAttached(),this.setInProgress(c,m),this.setInProgress(f,!1)):(o==="detached"||o==="failed"||o==="suspended")&&(this.setInProgress(f,!1),this.setInProgress(c,!1)),o==="attached"?this._attachResume=!0:(o==="detaching"||o==="failed")&&(this._attachResume=!1),this.state=o,this._allChannelChanges.emit(o,S),this.emit(o,S)}},a.prototype.requestState=function(o,n){x.default.logAction(x.default.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+o),this.notifyState(o,n),this.checkPendingState()},a.prototype.checkPendingState=function(){var o=this.connectionManager.state;if(!(o.sendEvents||o.forceQueueEvents)){x.default.logAction(x.default.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);return}switch(x.default.logAction(x.default.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync();break}},a.prototype.timeoutPendingState=function(){switch(this.state){case"attaching":{var o=new r.default("Channel attach timed out",90007,408);this.notifyState("suspended",o);break}case"detaching":{var o=new r.default("Channel detach timed out",90007,408);this.notifyState("attached",o);break}default:this.checkPendingState();break}},a.prototype.startStateTimerIfNotRunning=function(){var o=this;this.stateTimer||(this.stateTimer=setTimeout(function(){x.default.logAction(x.default.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),o.stateTimer=null,o.timeoutPendingState()},this.realtime.options.timeouts.realtimeRequestTimeout))},a.prototype.clearStateTimer=function(){var o=this.stateTimer;o&&(clearTimeout(o),this.stateTimer=null)},a.prototype.startRetryTimer=function(){var o=this;if(!this.retryTimer){this.retryCount++;var n=this.realtime.options.timeouts.channelRetryTimeout*E.getJitterCoefficient()*E.getBackoffCoefficient(this.retryCount);this.retryTimer=setTimeout(function(){o.state==="suspended"&&o.connectionManager.state.sendEvents&&(o.retryTimer=null,x.default.logAction(x.default.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),o.requestState("attaching"))},n)}},a.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},a.prototype.setInProgress=function(o,n){this.rest.channels.setInProgress(this,o,n)},a.prototype.getReleaseErr=function(){var o=this.state;return o==="initialized"||o==="detached"||o==="failed"?null:new r.default("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+o,90001,400)},a.progressOps={statechange:f,sync:c},a}(I.default);R.default=e},function(z,R,l){R.__esModule=!0;var v=function(){function s(U,E,I,x){this.previous=U,this.current=E,E==="attached"&&(this.resumed=I),x&&(this.reason=x)}return s}();R.default=v},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){return function(){var s=v,U=s.lib,E=U.WordArray,I=U.Hasher,x=s.algo,b=[],C=x.SHA1=I.extend({_doReset:function(){this._hash=new E.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(y,r){for(var p=this._hash.words,A=p[0],O=p[1],u=p[2],f=p[3],c=p[4],t=0;t<80;t++){if(t<16)b[t]=y[r+t]|0;else{var e=b[t-3]^b[t-8]^b[t-14]^b[t-16];b[t]=e<<1|e>>>31}var i=(A<<5|A>>>27)+c+b[t];t<20?i+=(O&u|~O&f)+1518500249:t<40?i+=(O^u^f)+1859775393:t<60?i+=(O&u|O&f|u&f)-1894007588:i+=(O^u^f)-899497514,c=f,f=u,u=O<<30|O>>>2,O=A,A=i}p[0]=p[0]+A|0,p[1]=p[1]+O|0,p[2]=p[2]+u|0,p[3]=p[3]+f|0,p[4]=p[4]+c|0},_doFinalize:function(){var y=this._data,r=y.words,p=this._nDataBytes*8,A=y.sigBytes*8;return r[A>>>5]|=128<<24-A%32,r[(A+64>>>9<<4)+14]=Math.floor(p/4294967296),r[(A+64>>>9<<4)+15]=p,y.sigBytes=r.length*4,this._process(),this._hash},clone:function(){var y=I.clone.call(this);return y._hash=this._hash.clone(),y}});s.SHA1=I._createHelper(C),s.HmacSHA1=I._createHmacHelper(C)}(),v.SHA1})},function(z,R,l){R.__esModule=!0;function v(t){if(t===void 0)return"undefined";var e,i;if(t instanceof ArrayBuffer?(i="ArrayBuffer",e=new DataView(t)):t instanceof DataView&&(i="DataView",e=t),!e)return JSON.stringify(t);for(var a=[],o=0;o<t.byteLength;o++){if(o>20){a.push("...");break}var n=e.getUint8(o).toString(16);n.length===1&&(n="0"+n),a.push(n)}return"<"+i+" "+a.join(" ")+">"}function s(t,e,i){for(var a=0,o=i.length;a<o;a++){var n=i.charCodeAt(a);if(n<128){t.setUint8(e++,n>>>0&127|0);continue}if(n<2048){t.setUint8(e++,n>>>6&31|192),t.setUint8(e++,n>>>0&63|128);continue}if(n<65536){t.setUint8(e++,n>>>12&15|224),t.setUint8(e++,n>>>6&63|128),t.setUint8(e++,n>>>0&63|128);continue}if(n<1114112){t.setUint8(e++,n>>>18&7|240),t.setUint8(e++,n>>>12&63|128),t.setUint8(e++,n>>>6&63|128),t.setUint8(e++,n>>>0&63|128);continue}throw new Error("bad codepoint "+n)}}function U(t,e,i){for(var a="",o=e,n=e+i;o<n;o++){var d=t.getUint8(o);if((d&128)===0){a+=String.fromCharCode(d);continue}if((d&224)===192){a+=String.fromCharCode((d&15)<<6|t.getUint8(++o)&63);continue}if((d&240)===224){a+=String.fromCharCode((d&15)<<12|(t.getUint8(++o)&63)<<6|(t.getUint8(++o)&63)<<0);continue}if((d&248)===240){a+=String.fromCharCode((d&7)<<18|(t.getUint8(++o)&63)<<12|(t.getUint8(++o)&63)<<6|(t.getUint8(++o)&63)<<0);continue}throw new Error("Invalid byte "+d.toString(16))}return a}function E(t){for(var e=0,i=0,a=t.length;i<a;i++){var o=t.charCodeAt(i);if(o<128){e+=1;continue}if(o<2048){e+=2;continue}if(o<65536){e+=3;continue}if(o<1114112){e+=4;continue}throw new Error("bad codepoint "+o)}return e}function I(t,e){var i=c(t,e);if(i!==0){var a=new ArrayBuffer(i),o=new DataView(a);return f(t,o,0,e),a}}var x=(1<<16)*(1<<16),b=1/x;function C(t,e){return e=e||0,t.getInt32(e)*x+t.getUint32(e+4)}function y(t,e){return e=e||0,t.getUint32(e)*x+t.getUint32(e+4)}function r(t,e,i){i<9223372036854776e3?(t.setInt32(e,Math.floor(i*b)),t.setInt32(e+4,i&-1)):(t.setUint32(e,2147483647),t.setUint32(e+4,2147483647))}function p(t,e,i){i<18446744073709552e3?(t.setUint32(e,Math.floor(i*b)),t.setInt32(e+4,i&-1)):(t.setUint32(e,4294967295),t.setUint32(e+4,4294967295))}var A=function(){function t(e,i){var a=this;this.map=function(o){for(var n={},d=0;d<o;d++){var m=a.parse();n[m]=a.parse()}return n},this.bin=function(o){var n=new ArrayBuffer(o);return new Uint8Array(n).set(new Uint8Array(a.view.buffer,a.offset,o),0),a.offset+=o,n},this.buf=this.bin,this.str=function(o){var n=U(a.view,a.offset,o);return a.offset+=o,n},this.array=function(o){for(var n=new Array(o),d=0;d<o;d++)n[d]=a.parse();return n},this.ext=function(o){return a.offset+=o,{type:a.view.getInt8(a.offset),data:a.buf(o)}},this.parse=function(){var o=a.view.getUint8(a.offset),n,d;if((o&128)===0)return a.offset++,o;if((o&240)===128)return d=o&15,a.offset++,a.map(d);if((o&240)===144)return d=o&15,a.offset++,a.array(d);if((o&224)===160)return d=o&31,a.offset++,a.str(d);if((o&224)===224)return n=a.view.getInt8(a.offset),a.offset++,n;switch(o){case 192:return a.offset++,null;case 193:a.offset++;return;case 194:return a.offset++,!1;case 195:return a.offset++,!0;case 196:return d=a.view.getUint8(a.offset+1),a.offset+=2,a.bin(d);case 197:return d=a.view.getUint16(a.offset+1),a.offset+=3,a.bin(d);case 198:return d=a.view.getUint32(a.offset+1),a.offset+=5,a.bin(d);case 199:return d=a.view.getUint8(a.offset+1),a.offset+=2,a.ext(d);case 200:return d=a.view.getUint16(a.offset+1),a.offset+=3,a.ext(d);case 201:return d=a.view.getUint32(a.offset+1),a.offset+=5,a.ext(d);case 202:return n=a.view.getFloat32(a.offset+1),a.offset+=5,n;case 203:return n=a.view.getFloat64(a.offset+1),a.offset+=9,n;case 204:return n=a.view.getUint8(a.offset+1),a.offset+=2,n;case 205:return n=a.view.getUint16(a.offset+1),a.offset+=3,n;case 206:return n=a.view.getUint32(a.offset+1),a.offset+=5,n;case 207:return n=y(a.view,a.offset+1),a.offset+=9,n;case 208:return n=a.view.getInt8(a.offset+1),a.offset+=2,n;case 209:return n=a.view.getInt16(a.offset+1),a.offset+=3,n;case 210:return n=a.view.getInt32(a.offset+1),a.offset+=5,n;case 211:return n=C(a.view,a.offset+1),a.offset+=9,n;case 212:return d=1,a.offset++,a.ext(d);case 213:return d=2,a.offset++,a.ext(d);case 214:return d=4,a.offset++,a.ext(d);case 215:return d=8,a.offset++,a.ext(d);case 216:return d=16,a.offset++,a.ext(d);case 217:return d=a.view.getUint8(a.offset+1),a.offset+=2,a.str(d);case 218:return d=a.view.getUint16(a.offset+1),a.offset+=3,a.str(d);case 219:return d=a.view.getUint32(a.offset+1),a.offset+=5,a.str(d);case 220:return d=a.view.getUint16(a.offset+1),a.offset+=3,a.array(d);case 221:return d=a.view.getUint32(a.offset+1),a.offset+=5,a.array(d);case 222:return d=a.view.getUint16(a.offset+1),a.offset+=3,a.map(d);case 223:return d=a.view.getUint32(a.offset+1),a.offset+=5,a.map(d)}throw new Error("Unknown type 0x"+o.toString(16))},this.offset=i||0,this.view=e}return t}();function O(t){var e=new DataView(t),i=new A(e),a=i.parse();if(i.offset!==t.byteLength)throw new Error(t.byteLength-i.offset+" trailing bytes");return a}function u(t,e){return Object.keys(t).filter(function(i){var a=t[i],o=typeof a;return(!e||a!=null)&&(o!=="function"||!!a.toJSON)})}function f(t,e,i,a){var o=typeof t;if(typeof t=="string"){var n=E(t);if(n<32)return e.setUint8(i,n|160),s(e,i+1,t),1+n;if(n<256)return e.setUint8(i,217),e.setUint8(i+1,n),s(e,i+2,t),2+n;if(n<65536)return e.setUint8(i,218),e.setUint16(i+1,n),s(e,i+3,t),3+n;if(n<4294967296)return e.setUint8(i,219),e.setUint32(i+1,n),s(e,i+5,t),5+n}if(ArrayBuffer.isView&&ArrayBuffer.isView(t)&&(t=t.buffer),t instanceof ArrayBuffer){var d=t.byteLength;if(d<256)return e.setUint8(i,196),e.setUint8(i+1,d),new Uint8Array(e.buffer).set(new Uint8Array(t),i+2),2+d;if(d<65536)return e.setUint8(i,197),e.setUint16(i+1,d),new Uint8Array(e.buffer).set(new Uint8Array(t),i+3),3+d;if(d<4294967296)return e.setUint8(i,198),e.setUint32(i+1,d),new Uint8Array(e.buffer).set(new Uint8Array(t),i+5),5+d}if(typeof t=="number"){if(Math.floor(t)!==t)return e.setUint8(i,203),e.setFloat64(i+1,t),9;if(t>=0){if(t<128)return e.setUint8(i,t),1;if(t<256)return e.setUint8(i,204),e.setUint8(i+1,t),2;if(t<65536)return e.setUint8(i,205),e.setUint16(i+1,t),3;if(t<4294967296)return e.setUint8(i,206),e.setUint32(i+1,t),5;if(t<18446744073709552e3)return e.setUint8(i,207),p(e,i+1,t),9;throw new Error("Number too big 0x"+t.toString(16))}if(t>=-32)return e.setInt8(i,t),1;if(t>=-128)return e.setUint8(i,208),e.setInt8(i+1,t),2;if(t>=-32768)return e.setUint8(i,209),e.setInt16(i+1,t),3;if(t>=-2147483648)return e.setUint8(i,210),e.setInt32(i+1,t),5;if(t>=-9223372036854776e3)return e.setUint8(i,211),r(e,i+1,t),9;throw new Error("Number too small -0x"+(-t).toString(16).substr(1))}if(o==="undefined")return a?0:(e.setUint8(i,212),e.setUint8(i+1,0),e.setUint8(i+2,0),3);if(t===null)return a?0:(e.setUint8(i,192),1);if(o==="boolean")return e.setUint8(i,t?195:194),1;if(typeof t.toJSON=="function")return f(t.toJSON(),e,i,a);if(o==="object"){var m,S=0,T=void 0,h=Array.isArray(t);if(h?m=t.length:(T=u(t,a),m=T.length),m<16?(e.setUint8(i,m|(h?144:128)),S=1):m<65536?(e.setUint8(i,h?220:222),e.setUint16(i+1,m),S=3):m<4294967296&&(e.setUint8(i,h?221:223),e.setUint32(i+1,m),S=5),h)for(var g=0;g<m;g++)S+=f(t[g],e,i+S,a);else if(T)for(var g=0;g<m;g++){var P=T[g];S+=f(P,e,i+S),S+=f(t[P],e,i+S,a)}return S}if(o==="function")return 0;throw new Error("Unknown type "+o)}function c(t,e){var i=typeof t;if(i==="string"){var a=E(t);if(a<32)return 1+a;if(a<256)return 2+a;if(a<65536)return 3+a;if(a<4294967296)return 5+a}if(ArrayBuffer.isView&&ArrayBuffer.isView(t)&&(t=t.buffer),t instanceof ArrayBuffer){var o=t.byteLength;if(o<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}if(typeof t=="number"){if(Math.floor(t)!==t)return 9;if(t>=0){if(t<128)return 1;if(t<256)return 2;if(t<65536)return 3;if(t<4294967296)return 5;if(t<18446744073709552e3)return 9;throw new Error("Number too big 0x"+t.toString(16))}if(t>=-32)return 1;if(t>=-128)return 2;if(t>=-32768)return 3;if(t>=-2147483648)return 5;if(t>=-9223372036854776e3)return 9;throw new Error("Number too small -0x"+t.toString(16).substr(1))}if(i==="boolean")return 1;if(t===null)return e?0:1;if(t===void 0)return e?0:3;if(typeof t.toJSON=="function")return c(t.toJSON(),e);if(i==="object"){var n,d=0;if(Array.isArray(t)){n=t.length;for(var m=0;m<n;m++)d+=c(t[m],e)}else{var S=u(t,e);n=S.length;for(var m=0;m<n;m++){var T=S[m];d+=c(T)+c(t[T],e)}}if(n<16)return 1+d;if(n<65536)return 3+d;if(n<4294967296)return 5+d;throw new Error("Array or object too long 0x"+n.toString(16))}if(i==="function")return 0;throw new Error("Unknown type "+i)}R.default={encode:I,decode:O,inspect:v,utf8Write:s,utf8Read:U,utf8ByteCount:E}},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(30)),U=v.__importDefault(l(50)),E=v.__importDefault(l(0)),I=v.__importDefault(l(55)),x=v.__importDefault(l(57)),b=v.__importDefault(l(62)),C=v.__importDefault(l(64)),y=v.__importDefault(l(68)),r=v.__importDefault(l(3)),p=l(8),A=v.__importDefault(l(25)),O=v.__importDefault(l(65)),u=v.__importDefault(l(66)),f=v.__importDefault(l(41)),c=v.__importDefault(l(9)),t=v.__importDefault(l(14));E.default.Crypto=x.default,E.default.BufferUtils=I.default,E.default.Http=b.default,E.default.Config=C.default,E.default.Transports=y.default,E.default.WebStorage=O.default,s.default.Crypto=x.default,U.default.Crypto=x.default,s.default.Message=c.default,U.default.Message=c.default,s.default.PresenceMessage=t.default,U.default.PresenceMessage=t.default,U.default.ConnectionManager=A.default,r.default.initLogHandlers(),E.default.Defaults=(0,p.getDefaults)(u.default),E.default.Config.agent&&(E.default.Defaults.agent+=" "+E.default.Config.agent),E.default.Config.noUpgrade&&(E.default.Defaults.upgradeTransports=[]),R.default={Rest:s.default,Realtime:U.default,msgpack:f.default}},function(z){z.exports=JSON.parse('{"name":"ably","description":"Realtime client library for Ably, the realtime messaging service","version":"1.2.33","license":"Apache-2.0","bugs":{"url":"https://github.com/ably/ably-js/issues","email":"support@ably.com"},"main":"./build/ably-node.js","typings":"./ably.d.ts","react-native":{"./build/ably-node.js":"./build/ably-reactnative.js"},"browser":{"./build/ably-node.js":"./build/ably-commonjs.js"},"files":["build/**","ably.d.ts","callbacks.d.ts","callbacks.js","promises.d.ts","promises.js","resources/**"],"dependencies":{"@ably/msgpack-js":"^0.4.0","got":"^11.8.2","ws":"^5.1"},"devDependencies":{"@ably/vcdiff-decoder":"1.0.4","@types/crypto-js":"^4.0.1","@types/node":"^15.0.0","@types/request":"^2.48.7","@types/ws":"^8.2.0","@typescript-eslint/eslint-plugin":"^5.14.0","@typescript-eslint/parser":"^5.14.0","async":"ably-forks/async#requirejs","aws-sdk":"^2.1075.0","chai":"^4.2.0","copy-webpack-plugin":"^6.4.1","cors":"~2.7","crypto-js":"ably-forks/crypto-js#crypto-lite","eslint":"^7.13.0","eslint-plugin-jsdoc":"^39.3.2","eslint-plugin-security":"^1.4.0","express":"^4.17.1","glob":"~4.4","google-closure-compiler":"^20180610.0.1","grunt":"^1.4.1","grunt-bump":"^0.3.1","grunt-cli":"~1.2.0","grunt-closure-tools":"^1.0.0","grunt-contrib-concat":"~0.5","grunt-shell":"~1.1","grunt-webpack":"^4.0.2","hexy":"~0.2","kexec":"ably-forks/node-kexec#update-for-node-12","minimist":"^1.2.5","mocha":"^8.1.3","null-loader":"^4.0.1","playwright":"^1.10.0","prettier":"^2.5.1","requirejs":"~2.1","shelljs":"~0.8","source-map-explorer":"^2.5.2","ts-loader":"^8.2.0","tsconfig-paths-webpack-plugin":"^3.5.2","tslib":"^2.3.1","typedoc":"^0.23.8","typescript":"^4.6.4","webpack":"^4.44.2","webpack-cli":"^4.2.0"},"engines":{"node":">=5.10.x"},"repository":"ably/ably-js","jspm":{"registry":"npm","directories":{"lib":"browser/static"},"main":"ably"},"scripts":{"grunt":"grunt","test":"grunt test","test:node":"grunt test:node","test:webserver":"grunt test:webserver","test:playwright":"node test/support/runPlaywrightTests.js","concat":"grunt concat","build":"grunt build:all","build:node":"grunt build:node","build:browser":"grunt build:browser","requirejs":"grunt requirejs","lint":"eslint .","lint:fix":"eslint --fix .","check-closure-compiler":"grunt check-closure-compiler","prepare":"npm run build","format":"prettier --write --ignore-path .gitignore src test ably.d.ts webpack.config.js Gruntfile.js scripts/cdn_deploy.js","format:check":"prettier --check --ignore-path .gitignore src test ably.d.ts webpack.config.js Gruntfile.js scripts/cdn_deploy.js","sourcemap":"source-map-explorer build/ably.min.js","sourcemap:noencryption":"source-map-explorer build/ably.noencryption.min.js","docs":"typedoc --entryPoints ably.d.ts --out docs/generated/default --readme docs/landing-pages/default.md && typedoc --entryPoints promises.d.ts --out docs/generated/promises --name \\"ably (Promise-based)\\" --readme docs/landing-pages/promises.md && cp docs/landing-pages/choose-library.html docs/generated/index.html"}}')},function(z,R,l){(function(v,s){z.exports=s(l(6),l(31),l(23))})(this,function(v){return v.HmacSHA256})},function(z,R){},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(47)),E=v.__importDefault(l(24)),I=v.__importDefault(l(18)),x=v.__importDefault(l(5)),b=v.__importDefault(l(48)),C=function(){},y=function(){function O(u){this.rest=u,this.admin=new r(u)}return O}(),r=function(){function O(u){this.rest=u,this.deviceRegistrations=new p(u),this.channelSubscriptions=new A(u)}return O.prototype.publish=function(u,f,c){var t=this.rest,e=t.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,i=s.defaultPostHeaders(t.options,e),a={},o=s.mixin({recipient:u},f);if(typeof c!="function"){if(this.rest.options.promises)return s.promisify(this,"publish",arguments);c=C}t.options.headers&&s.mixin(i,t.options.headers),t.options.pushFullWait&&s.mixin(a,{fullWait:"true"});var n=s.encodeBody(o,e);E.default.post(t,"/push/publish",n,i,a,null,function(d){return c(d)})},O}(),p=function(){function O(u){this.rest=u}return O.prototype.save=function(u,f){var c=this.rest,t=U.default.fromValues(u),e=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,i=s.defaultPostHeaders(c.options,e),a={};if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"save",arguments);f=C}c.options.headers&&s.mixin(i,c.options.headers),c.options.pushFullWait&&s.mixin(a,{fullWait:"true"});var o=s.encodeBody(t,e);E.default.put(c,"/push/deviceRegistrations/"+encodeURIComponent(u.id),o,i,a,null,function(n,d,m,S){f(n,n?void 0:U.default.fromResponseBody(d,S?void 0:e))})},O.prototype.get=function(u,f){var c=this.rest,t=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,e=s.defaultGetHeaders(c.options,t),i=u.id||u;if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"get",arguments);f=C}if(typeof i!="string"||!i.length){f(new x.default("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400));return}c.options.headers&&s.mixin(e,c.options.headers),E.default.get(c,"/push/deviceRegistrations/"+encodeURIComponent(i),e,{},null,function(a,o,n,d){f(a,a?void 0:U.default.fromResponseBody(o,d?void 0:t))})},O.prototype.list=function(u,f){var c=this.rest,t=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,e=this.rest.http.supportsLinkHeaders?void 0:t,i=s.defaultGetHeaders(c.options,t);if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"list",arguments);f=C}c.options.headers&&s.mixin(i,c.options.headers),new I.default(c,"/push/deviceRegistrations",i,e,function(a,o,n){return U.default.fromResponseBody(a,n?void 0:t)}).get(u,f)},O.prototype.remove=function(u,f){var c=this.rest,t=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,e=s.defaultGetHeaders(c.options,t),i={},a=u.id||u;if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"remove",arguments);f=C}if(typeof a!="string"||!a.length){f(new x.default("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400));return}c.options.headers&&s.mixin(e,c.options.headers),c.options.pushFullWait&&s.mixin(i,{fullWait:"true"}),E.default.delete(c,"/push/deviceRegistrations/"+encodeURIComponent(a),e,i,null,function(o){return f(o)})},O.prototype.removeWhere=function(u,f){var c=this.rest,t=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,e=s.defaultGetHeaders(c.options,t);if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"removeWhere",arguments);f=C}c.options.headers&&s.mixin(e,c.options.headers),c.options.pushFullWait&&s.mixin(u,{fullWait:"true"}),E.default.delete(c,"/push/deviceRegistrations",e,u,null,function(i){return f(i)})},O}(),A=function(){function O(u){this.remove=O.prototype.removeWhere,this.rest=u}return O.prototype.save=function(u,f){var c=this.rest,t=b.default.fromValues(u),e=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,i=s.defaultPostHeaders(c.options,e),a={};if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"save",arguments);f=C}c.options.headers&&s.mixin(i,c.options.headers),c.options.pushFullWait&&s.mixin(a,{fullWait:"true"});var o=s.encodeBody(t,e);E.default.post(c,"/push/channelSubscriptions",o,i,a,null,function(n,d,m,S){f(n,!n&&b.default.fromResponseBody(d,S?void 0:e))})},O.prototype.list=function(u,f){var c=this.rest,t=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,e=this.rest.http.supportsLinkHeaders?void 0:t,i=s.defaultGetHeaders(c.options,t);if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"list",arguments);f=C}c.options.headers&&s.mixin(i,c.options.headers),new I.default(c,"/push/channelSubscriptions",i,e,function(a,o,n){return b.default.fromResponseBody(a,n?void 0:t)}).get(u,f)},O.prototype.removeWhere=function(u,f){var c=this.rest,t=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,e=s.defaultGetHeaders(c.options,t);if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"removeWhere",arguments);f=C}c.options.headers&&s.mixin(e,c.options.headers),c.options.pushFullWait&&s.mixin(u,{fullWait:"true"}),E.default.delete(c,"/push/channelSubscriptions",e,u,null,function(i){return f(i)})},O.prototype.listChannels=function(u,f){var c=this.rest,t=c.options.useBinaryProtocol?s.Format.msgpack:s.Format.json,e=this.rest.http.supportsLinkHeaders?void 0:t,i=s.defaultGetHeaders(c.options,t);if(typeof f!="function"){if(this.rest.options.promises)return s.promisify(this,"listChannels",arguments);f=C}c.options.headers&&s.mixin(i,c.options.headers),c.options.pushFullWait&&s.mixin(u,{fullWait:"true"}),new I.default(c,"/push/channels",i,e,function(a,o,n){for(var d=!n&&t?s.decodeBody(a,t):a,m=0;m<d.length;m++)d[m]=String(d[m]);return d}).get(u,f)},O}();R.default=y},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(5)),E;(function(b){b.Phone="phone",b.Tablet="tablet",b.Desktop="desktop",b.TV="tv",b.Watch="watch",b.Car="car",b.Embedded="embedded",b.Other="other"})(E||(E={}));var I;(function(b){b.Android="android",b.IOS="ios",b.Browser="browser"})(I||(I={}));var x=function(){function b(){}return b.prototype.toJSON=function(){var C,y,r;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:(C=this.push)===null||C===void 0?void 0:C.recipient,state:(y=this.push)===null||y===void 0?void 0:y.state,error:(r=this.push)===null||r===void 0?void 0:r.error}}},b.prototype.toString=function(){var C,y,r,p,A="[DeviceDetails";return this.id&&(A+="; id="+this.id),this.platform&&(A+="; platform="+this.platform),this.formFactor&&(A+="; formFactor="+this.formFactor),this.clientId&&(A+="; clientId="+this.clientId),this.metadata&&(A+="; metadata="+this.metadata),this.deviceIdentityToken&&(A+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),!((C=this.push)===null||C===void 0)&&C.recipient&&(A+="; push.recipient="+JSON.stringify(this.push.recipient)),!((y=this.push)===null||y===void 0)&&y.state&&(A+="; push.state="+this.push.state),!((r=this.push)===null||r===void 0)&&r.error&&(A+="; push.error="+JSON.stringify(this.push.error)),!((p=this.push)===null||p===void 0)&&p.metadata&&(A+="; push.metadata="+this.push.metadata),A+="]",A},b.fromResponseBody=function(C,y){return y&&(C=s.decodeBody(C,y)),s.isArray(C)?b.fromValuesArray(C):b.fromValues(C)},b.fromValues=function(C){return C.error=C.error&&U.default.fromValues(C.error),Object.assign(new b,C)},b.fromValuesArray=function(C){for(var y=C.length,r=new Array(y),p=0;p<y;p++)r[p]=b.fromValues(C[p]);return r},b.toRequestBody=s.encodeBody,b}();R.default=x},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=function(){function E(){}return E.prototype.toJSON=function(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}},E.prototype.toString=function(){var I="[PushChannelSubscription";return this.channel&&(I+="; channel="+this.channel),this.deviceId&&(I+="; deviceId="+this.deviceId),this.clientId&&(I+="; clientId="+this.clientId),I+="]",I},E.fromResponseBody=function(I,x){return x&&(I=s.decodeBody(I,x)),s.isArray(I)?E.fromValuesArray(I):E.fromValues(I)},E.fromValues=function(I){return Object.assign(new E,I)},E.fromValuesArray=function(I){for(var x=I.length,b=new Array(x),C=0;C<x;C++)b[C]=E.fromValues(I[C]);return b},E.toRequestBody=s.encodeBody,E}();R.default=U},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=function(){function c(t){this.count=t&&t.count||0,this.data=t&&t.data||0,this.uncompressedData=t&&t.uncompressedData||0,this.failed=t&&t.failed||0,this.refused=t&&t.refused||0}return c}(),E=function(c){v.__extends(t,c);function t(e){var i=c.call(this,e)||this;return e&&e.category&&(i.category={},s.forInOwnNonNullProperties(e.category,function(a){i.category[a]=new U(e.category[a])})),i}return t}(U),I=function(){function c(t){this.peak=t&&t.peak||0,this.min=t&&t.min||0,this.mean=t&&t.mean||0,this.opened=t&&t.opened||0,this.refused=t&&t.refused||0}return c}(),x=function(){function c(t){this.succeeded=t&&t.succeeded||0,this.failed=t&&t.failed||0,this.refused=t&&t.refused||0}return c}(),b=function(){function c(t){this.plain=new I(t&&t.plain),this.tls=new I(t&&t.tls),this.all=new I(t&&t.all)}return c}(),C=function(){function c(t){this.messages=new E(t&&t.messages),this.presence=new E(t&&t.presence),this.all=new E(t&&t.all)}return c}(),y=function(){function c(t){this.realtime=new C(t&&t.realtime),this.rest=new C(t&&t.rest),this.webhook=new C(t&&t.webhook),this.sharedQueue=new C(t&&t.sharedQueue),this.externalQueue=new C(t&&t.externalQueue),this.httpEvent=new C(t&&t.httpEvent),this.push=new C(t&&t.push),this.all=new C(t&&t.all)}return c}(),r=function(){function c(t){this.all=new C(t&&t.all),this.inbound=new y(t&&t.inbound),this.outbound=new y(t&&t.outbound)}return c}(),p=function(){function c(t){this.all=new C(t&&t.all),this.producerPaid=new r(t&&t.producerPaid),this.consumerPaid=new r(t&&t.consumerPaid)}return c}(),A=function(){function c(t){this.messages=t&&t.messages||0;var e=t&&t.notifications;this.notifications={invalid:e&&e.invalid||0,attempted:e&&e.attempted||0,successful:e&&e.successful||0,failed:e&&e.failed||0},this.directPublishes=t&&t.directPublishes||0}return c}(),O=function(){function c(t){this.succeeded=t&&t.succeeded||0,this.skipped=t&&t.skipped||0,this.failed=t&&t.failed||0}return c}(),u=function(){function c(t){var e=this;this.delta=void 0,t&&t.delta&&(this.delta={},s.forInOwnNonNullProperties(t.delta,function(i){e.delta[i]=new O(t.delta[i])}))}return c}(),f=function(c){v.__extends(t,c);function t(e){var i=c.call(this,e)||this;return i.persisted=new C(e&&e.persisted),i.connections=new b(e&&e.connections),i.channels=new I(e&&e.channels),i.apiRequests=new x(e&&e.apiRequests),i.tokenRequests=new x(e&&e.tokenRequests),i.xchgProducer=new p(e&&e.xchgProducer),i.xchgConsumer=new p(e&&e.xchgConsumer),i.push=new A(e&&e.pushStats),i.processed=new u(e&&e.processed),i.inProgress=e&&e.inProgress||void 0,i.unit=e&&e.unit||void 0,i.intervalId=e&&e.intervalId||void 0,i}return t.fromValues=function(e){return new t(e)},t}(r);R.default=f},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(30)),E=v.__importDefault(l(7)),I=v.__importDefault(l(3)),x=v.__importDefault(l(51)),b=v.__importDefault(l(38)),C=v.__importDefault(l(8)),y=v.__importDefault(l(5)),r=v.__importDefault(l(10)),p=v.__importDefault(l(25)),A=v.__importDefault(l(0)),O=v.__importDefault(l(9)),u=function(c){v.__extends(t,c);function t(e){var i=c.call(this,e)||this;return I.default.logAction(I.default.LOG_MINOR,"Realtime()",""),i.connection=new x.default(i,i.options),i.channels=new f(i),e.autoConnect!==!1&&i.connect(),i}return t.prototype.connect=function(){I.default.logAction(I.default.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()},t.prototype.close=function(){I.default.logAction(I.default.LOG_MINOR,"Realtime.close()",""),this.connection.close()},t.Promise=function(e){return e=C.default.objectifyOptions(e),e.promises=!0,new t(e)},t.Callbacks=t,t.Utils=s,t.ConnectionManager=p.default,t.Platform=A.default,t.ProtocolMessage=r.default,t.Message=O.default,t}(U.default),f=function(c){v.__extends(t,c);function t(e){var i=c.call(this)||this;return i.realtime=e,i.all=Object.create(null),i.inProgress=Object.create(null),e.connection.connectionManager.on("transport.active",function(){i.onTransportActive()}),i}return t.prototype.onChannelMessage=function(e){var i=e.channel;if(i===void 0){I.default.logAction(I.default.LOG_ERROR,"Channels.onChannelMessage()","received event unspecified channel, action = "+e.action);return}var a=this.all[i];if(!a){I.default.logAction(I.default.LOG_ERROR,"Channels.onChannelMessage()","received event for non-existent channel: "+i);return}a.onMessage(e)},t.prototype.onTransportActive=function(){for(var e in this.all){var i=this.all[e];i.state==="attaching"||i.state==="detaching"?i.checkPendingState():i.state==="suspended"&&i._attach(!1,null)}},t.prototype.reattach=function(e){for(var i in this.all){var a=this.all[i];a.state==="attached"&&a.requestState("attaching",e)}},t.prototype.resetAttachedMsgIndicators=function(){for(var e in this.all){var i=this.all[e];i.state==="attached"&&(i._attachedMsgIndicator=!1)}},t.prototype.checkAttachedMsgIndicators=function(e){for(var i in this.all){var a=this.all[i];if(a.state==="attached"&&a._attachedMsgIndicator===!1){var o="30s after a resume, found channel which has not received an attached; channelId = "+i+"; connectionId = "+e;I.default.logAction(I.default.LOG_ERROR,"Channels.checkAttachedMsgIndicators()",o),a.requestState("attaching")}}},t.prototype.propogateConnectionInterruption=function(e,i){var a={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"},o=["attaching","attached","detaching","suspended"],n=a[e];for(var d in this.all){var m=this.all[d];s.arrIn(o,m.state)&&m.notifyState(n,i)}},t.prototype.get=function(e,i){e=String(e);var a=this.all[e];if(!a)a=this.all[e]=new b.default(this.realtime,e,i);else if(i){if(a._shouldReattachToSetOptions(i))throw new y.default("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);a.setOptions(i)}return a},t.prototype.release=function(e){e=String(e);var i=this.all[e];if(!!i){var a=i.getReleaseErr();if(a)throw a;delete this.all[e],delete this.inProgress[e]}},t.prototype.setInProgress=function(e,i,a){this.inProgress[e.name]=this.inProgress[e.name]||{},this.inProgress[e.name][i]=a,!a&&this.hasNopending()&&this.emit("nopending")},t.prototype.onceNopending=function(e){if(this.hasNopending()){e();return}this.once("nopending",e)},t.prototype.hasNopending=function(){return s.arrEvery(s.valuesArray(this.inProgress,!0),function(e){return!s.containsValue(e,!0)})},t}(E.default);R.default=u},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(7)),E=v.__importDefault(l(25)),I=v.__importDefault(l(3)),x=v.__importDefault(l(36)),b=v.__importDefault(l(0));function C(){}var y=function(r){v.__extends(p,r);function p(A,O){var u=r.call(this)||this;return u.whenState=function(f,c){return U.default.prototype.whenState.call(u,f,u.state,c,new x.default(void 0,f))},u.ably=A,u.connectionManager=new E.default(A,O),u.state=u.connectionManager.state.state,u.key=void 0,u.id=void 0,u.serial=void 0,u.recoveryKey=void 0,u.errorReason=null,u.connectionManager.on("connectionstate",function(f){var c=u.state=f.current;b.default.Config.nextTick(function(){u.emit(c,f)})}),u.connectionManager.on("update",function(f){b.default.Config.nextTick(function(){u.emit("update",f)})}),u}return p.prototype.connect=function(){I.default.logAction(I.default.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})},p.prototype.ping=function(A){if(I.default.logAction(I.default.LOG_MINOR,"Connection.ping()",""),!A){if(this.ably.options.promises)return s.promisify(this,"ping",arguments);A=C}this.connectionManager.ping(null,A)},p.prototype.close=function(){I.default.logAction(I.default.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})},p}(U.default);R.default=y},function(z,R,l){R.__esModule=!0,R.PendingMessage=void 0;var v=l(1),s=v.__importDefault(l(10)),U=v.__importStar(l(2)),E=v.__importDefault(l(7)),I=v.__importDefault(l(3)),x=v.__importDefault(l(35)),b=v.__importDefault(l(5)),C=s.default.Action,y=function(){function p(A,O){this.message=A,this.callback=O,this.merged=!1;var u=A.action;this.sendAttempted=!1,this.ackRequired=u==C.MESSAGE||u==C.PRESENCE}return p}();R.PendingMessage=y;var r=function(p){v.__extends(A,p);function A(O){var u=p.call(this)||this;return u.transport=O,u.messageQueue=new x.default,O.on("ack",function(f,c){u.onAck(f,c)}),O.on("nack",function(f,c,t){u.onNack(f,c,t)}),u}return A.prototype.onAck=function(O,u){I.default.logAction(I.default.LOG_MICRO,"Protocol.onAck()","serial = "+O+"; count = "+u),this.messageQueue.completeMessages(O,u)},A.prototype.onNack=function(O,u,f){I.default.logAction(I.default.LOG_ERROR,"Protocol.onNack()","serial = "+O+"; count = "+u+"; err = "+U.inspectError(f)),f||(f=new b.default("Unable to send message; channel not responding",50001,500)),this.messageQueue.completeMessages(O,u,f)},A.prototype.onceIdle=function(O){var u=this.messageQueue;if(u.count()===0){O();return}u.once("idle",O)},A.prototype.send=function(O){O.ackRequired&&this.messageQueue.push(O),I.default.shouldLog(I.default.LOG_MICRO)&&I.default.logAction(I.default.LOG_MICRO,"Protocol.send()","sending msg; "+s.default.stringify(O.message)),O.sendAttempted=!0,this.transport.send(O.message)},A.prototype.getTransport=function(){return this.transport},A.prototype.getPendingMessages=function(){return this.messageQueue.copyAll()},A.prototype.clearPendingMessages=function(){return this.messageQueue.clear()},A.prototype.finish=function(){var O=this.transport;this.onceIdle(function(){O.disconnect()})},A}(E.default);R.default=r},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(0)),U=v.__importStar(l(2)),E=v.__importDefault(l(26)),I=v.__importDefault(l(8)),x=v.__importDefault(l(3)),b=v.__importDefault(l(10)),C=v.__importDefault(l(5)),y="web_socket";function r(O){return!!O.on}var p=function(O){v.__extends(u,O);function u(f,c,t){var e=O.call(this,f,c,t)||this;return e.shortName=y,t.heartbeats=s.default.Config.useProtocolHeartbeats,e.wsHost=I.default.getHost(t.options,t.host,!0),e}return u.isAvailable=function(){return!!s.default.Config.WebSocket},u.prototype.createWebSocket=function(f,c){var t=0;if(c)for(var e in c)f+=(t++?"&":"?")+e+"="+c[e];return this.uri=f,new s.default.Config.WebSocket(f)},u.prototype.toString=function(){return"WebSocketTransport; uri="+this.uri},u.prototype.connect=function(){x.default.logAction(x.default.LOG_MINOR,"WebSocketTransport.connect()","starting"),E.default.prototype.connect.call(this);var f=this,c=this.params,t=c.options,e=t.tls?"wss://":"ws://",i=e+this.wsHost+":"+I.default.getPort(t)+"/";x.default.logAction(x.default.LOG_MINOR,"WebSocketTransport.connect()","uri: "+i),this.auth.getAuthParams(function(a,o){if(!f.isDisposed){var n="";for(var d in o)n+=" "+d+": "+o[d]+";";if(x.default.logAction(x.default.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+n+" err: "+a),a){f.disconnect(a);return}var m=c.getConnectParams(o);try{var S=f.wsConnection=f.createWebSocket(i,m);S.binaryType=s.default.Config.binaryType,S.onopen=function(){f.onWsOpen()},S.onclose=function(T){f.onWsClose(T)},S.onmessage=function(T){f.onWsData(T.data)},S.onerror=function(T){f.onWsError(T)},r(S)&&S.on("ping",function(){f.onActivity()})}catch(T){x.default.logAction(x.default.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(T.stack||T.message)),f.disconnect(T)}}})},u.prototype.send=function(f){var c=this.wsConnection;if(!c){x.default.logAction(x.default.LOG_ERROR,"WebSocketTransport.send()","No socket connection");return}try{c.send(b.default.serialize(f,this.params.format))}catch(e){var t="Exception from ws connection when trying to send: "+U.inspectError(e);x.default.logAction(x.default.LOG_ERROR,"WebSocketTransport.send()",t),this.finish("disconnected",new C.default(t,5e4,500))}},u.prototype.onWsData=function(f){x.default.logAction(x.default.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+f.length+"; type = "+typeof f);try{this.onProtocolMessage(b.default.deserialize(f,this.format))}catch(c){x.default.logAction(x.default.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+c.stack)}},u.prototype.onWsOpen=function(){x.default.logAction(x.default.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")},u.prototype.onWsClose=function(f){var c,t;if(typeof f=="object"?(t=f.code,c=f.wasClean||t===1e3):(t=f,c=t==1e3),delete this.wsConnection,c){x.default.logAction(x.default.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");var e=new C.default("Websocket closed",80003,400);this.finish("disconnected",e)}else{var i="Unclean disconnection of WebSocket ; code = "+t,e=new C.default(i,80003,400);x.default.logAction(x.default.LOG_MINOR,"WebSocketTransport.onWsClose()",i),this.finish("disconnected",e)}this.emit("disposed")},u.prototype.onWsError=function(f){var c=this;x.default.logAction(x.default.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+f.message),s.default.Config.nextTick(function(){c.disconnect(Error(f.message))})},u.prototype.dispose=function(){x.default.logAction(x.default.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;var f=this.wsConnection;f&&(f.onmessage=function(){},delete this.wsConnection,s.default.Config.nextTick(function(){if(x.default.logAction(x.default.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!f)throw new Error("WebSocketTransport.dispose(): wsConnection is not defined");f.close()}))},u}(E.default);function A(O){return p.isAvailable()&&(O.supportedTransports[y]=p),p}R.default=A},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importStar(l(2)),U=v.__importDefault(l(34)),E=v.__importDefault(l(7)),I=v.__importDefault(l(3)),x=v.__importDefault(l(14)),b=v.__importDefault(l(5)),C=v.__importDefault(l(38)),y=v.__importDefault(l(22)),r=v.__importDefault(l(39)),p=function(){};function A(i){return i.clientId+":"+i.connectionId}function O(i){return i.channel.realtime.auth.clientId}function u(i){var a=i.channel.realtime,o=a.auth.clientId;return(!o||o==="*")&&a.connection.state==="connected"}function f(i,a,o){switch(i.state){case"attached":case"suspended":o();break;case"initialized":case"detached":case"detaching":case"attaching":i.attach(function(n){n?a(n):o()});break;default:a(b.default.fromValues(C.default.invalidStateError(i.state)))}}function c(i,a){if(i.isSynthesized()||a.isSynthesized())return i.timestamp>a.timestamp;var o=i.parseId(),n=a.parseId();return o.msgSerial===n.msgSerial?o.index>n.index:o.msgSerial>n.msgSerial}var t=function(i){v.__extends(a,i);function a(o){var n=i.call(this,o)||this;return n.channel=o,n.syncComplete=!1,n.members=new e(n),n._myMembers=new e(n),n.subscriptions=new E.default,n.pendingPresence=[],n}return a.prototype.enter=function(o,n){if(u(this))throw new b.default("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,o,"enter",n)},a.prototype.update=function(o,n){if(u(this))throw new b.default("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,o,"update",n)},a.prototype.enterClient=function(o,n,d){return this._enterOrUpdateClient(o,n,"enter",d)},a.prototype.updateClient=function(o,n,d){return this._enterOrUpdateClient(o,n,"update",d)},a.prototype._enterOrUpdateClient=function(o,n,d,m){var S=this;if(!m)if(typeof n=="function")m=n,n=null;else{if(this.channel.realtime.options.promises)return s.promisify(this,"_enterOrUpdateClient",[o,n,d]);m=p}var T=this.channel;if(!T.connectionManager.activeState()){m(T.connectionManager.getError());return}I.default.logAction(I.default.LOG_MICRO,"RealtimePresence."+d+"Client()","channel = "+T.name+", client = "+(o||"(implicit) "+O(this)));var h=x.default.fromValues({action:d,data:n});o&&(h.clientId=o),x.default.encode(h,T.channelOptions,function(g){if(g){m(g);return}switch(T.state){case"attached":T.sendPresence(h,m);break;case"initialized":case"detached":T.attach();case"attaching":S.pendingPresence.push({presence:h,callback:m});break;default:g=new b.default("Unable to "+d+" presence channel while in "+T.state+" state",90001),g.code=90001,m(g)}})},a.prototype.leave=function(o,n){if(u(this))throw new b.default("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,o,n)},a.prototype.leaveClient=function(o,n,d){if(!d)if(typeof n=="function")d=n,n=null;else{if(this.channel.realtime.options.promises)return s.promisify(this,"leaveClient",[o,n]);d=p}var m=this.channel;if(!m.connectionManager.activeState()){d==null||d(m.connectionManager.getError());return}I.default.logAction(I.default.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+o);var S=x.default.fromValues({action:"leave",data:n});switch(o&&(S.clientId=o),m.state){case"attached":m.sendPresence(S,d);break;case"attaching":this.pendingPresence.push({presence:S,callback:d});break;case"initialized":case"failed":{var T=new b.default("Unable to leave presence channel (incompatible state)",90001);d==null||d(T);break}default:d==null||d(C.default.invalidStateError(m.state))}},a.prototype.get=function(o,n){var d=this,m=Array.prototype.slice.call(arguments);m.length==1&&typeof m[0]=="function"&&m.unshift(null),o=m[0],n=m[1];var S=!o||("waitForSync"in o?o.waitForSync:!0);if(!n){if(this.channel.realtime.options.promises)return s.promisify(this,"get",m);n=p}function T(h){n(null,o?h.list(o):h.values())}if(this.channel.state==="suspended"){S?n(b.default.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):T(this.members);return}f(this.channel,n,function(){var h=d.members;S?h.waitSync(function(){T(h)}):T(h)})},a.prototype.history=function(o,n){if(I.default.logAction(I.default.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name),n===void 0)if(typeof o=="function")n=o,o=null;else{if(this.channel.realtime.options.promises)return s.promisify(this,"history",arguments);n=p}o&&o.untilAttach&&(this.channel.state==="attached"?(delete o.untilAttach,o.from_serial=this.channel.properties.attachSerial):n(new b.default("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400))),U.default.prototype._history.call(this,o,n)},a.prototype.setPresence=function(o,n,d){I.default.logAction(I.default.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+o.length+" participants; syncChannelSerial = "+d);var m,S,T=this.members,h=this._myMembers,g=[],P=this.channel.connectionManager.connectionId;n&&(this.members.startSync(),d&&(S=d.match(/^[\w-]+:(.*)$/))&&(m=S[1]));for(var L=0;L<o.length;L++){var B=x.default.fromValues(o[L]);switch(B.action){case"leave":T.remove(B)&&g.push(B),B.connectionId===P&&!B.isSynthesized()&&h.remove(B);break;case"enter":case"present":case"update":T.put(B)&&g.push(B),B.connectionId===P&&h.put(B);break}}n&&!m&&(T.endSync(),this._ensureMyMembersPresent(),this.channel.setInProgress(C.default.progressOps.sync,!1),this.channel.syncChannelSerial=null);for(var L=0;L<g.length;L++){var B=g[L];this.subscriptions.emit(B.action,B)}},a.prototype.onAttached=function(o){I.default.logAction(I.default.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+o),o?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear(),this._ensureMyMembersPresent());var n=this.pendingPresence,d=n.length;if(d){this.pendingPresence=[];var m=[],S=y.default.create();I.default.logAction(I.default.LOG_MICRO,"RealtimePresence.onAttached","sending "+d+" queued presence messages");for(var T=0;T<d;T++){var h=n[T];m.push(h.presence),S.push(h.callback)}this.channel.sendPresence(m,S)}},a.prototype.actOnChannelState=function(o,n,d){switch(o){case"attached":this.onAttached(n);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(d);break}},a.prototype.failPendingPresence=function(o){if(this.pendingPresence.length){I.default.logAction(I.default.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+s.inspectError(o));for(var n=0;n<this.pendingPresence.length;n++)try{this.pendingPresence[n].callback(o)}catch{}this.pendingPresence=[]}},a.prototype._clearMyMembers=function(){this._myMembers.clear()},a.prototype._ensureMyMembersPresent=function(){var o=this,n=this.members,d=this._myMembers,m=function(h){if(h){var g="Presence auto-re-enter failed: "+h.toString(),P=new b.default(g,91004,400);I.default.logAction(I.default.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()",g);var L=new r.default(o.channel.state,o.channel.state,!0,P);o.channel.emit("update",L)}};for(var S in d.map)if(!(S in n.map)){var T=d.map[S];I.default.logAction(I.default.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+T.clientId+'" into the presence set'),this._enterOrUpdateClient(T.clientId,T.data,"enter",m),delete d.map[S]}},a.prototype._synthesizeLeaves=function(o){var n=this.subscriptions;s.arrForEach(o,function(d){var m=x.default.fromValues({action:"leave",connectionId:d.connectionId,clientId:d.clientId,data:d.data,encoding:d.encoding,timestamp:s.now()});n.emit("leave",m)})},a.prototype.on=function(){for(var o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];I.default.deprecated("presence.on","presence.subscribe"),this.subscribe.apply(this,o)},a.prototype.off=function(){for(var o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];I.default.deprecated("presence.off","presence.unsubscribe"),this.unsubscribe.apply(this,o)},a.prototype.subscribe=function(){for(var o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];var d=C.default.processListenerArgs(o),m=d[0],S=d[1],T=d[2],h=this.channel;if(!T){if(this.channel.realtime.options.promises)return s.promisify(this,"subscribe",[m,S]);T=p}if(h.state==="failed"){T(b.default.fromValues(C.default.invalidStateError("failed")));return}this.subscriptions.on(m,S),h.attach(T)},a.prototype.unsubscribe=function(){for(var o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];var d=C.default.processListenerArgs(o),m=d[0],S=d[1];this.subscriptions.off(m,S)},a}(U.default),e=function(i){v.__extends(a,i);function a(o){var n=i.call(this)||this;return n.presence=o,n.map=Object.create(null),n.syncInProgress=!1,n.residualMembers=null,n}return a.prototype.get=function(o){return this.map[o]},a.prototype.getClient=function(o){var n=this.map,d=[];for(var m in n){var S=n[m];S.clientId==o&&S.action!="absent"&&d.push(S)}return d},a.prototype.list=function(o){var n=this.map,d=o&&o.clientId,m=o&&o.connectionId,S=[];for(var T in n){var h=n[T];h.action!=="absent"&&(d&&d!=h.clientId||m&&m!=h.connectionId||S.push(h))}return S},a.prototype.put=function(o){(o.action==="enter"||o.action==="update")&&(o=x.default.fromValues(o),o.action="present");var n=this.map,d=A(o);this.residualMembers&&delete this.residualMembers[d];var m=n[d];return m&&!c(o,m)?!1:(n[d]=o,!0)},a.prototype.values=function(){var o=this.map,n=[];for(var d in o){var m=o[d];m.action!="absent"&&n.push(m)}return n},a.prototype.remove=function(o){var n=this.map,d=A(o),m=n[d];return m&&!c(o,m)?!1:(this.syncInProgress?(o=x.default.fromValues(o),o.action="absent",n[d]=o):delete n[d],!0)},a.prototype.startSync=function(){var o=this.map,n=this.syncInProgress;I.default.logAction(I.default.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+n),this.syncInProgress||(this.residualMembers=s.copy(o),this.setInProgress(!0))},a.prototype.endSync=function(){var o=this.map,n=this.syncInProgress;if(I.default.logAction(I.default.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+n),n){for(var d in o){var m=o[d];m.action==="absent"&&delete o[d]}this.presence._synthesizeLeaves(s.valuesArray(this.residualMembers));for(var S in this.residualMembers)delete o[S];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")},a.prototype.waitSync=function(o){var n=this.syncInProgress;if(I.default.logAction(I.default.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+n),!n){o();return}this.once("sync",o)},a.prototype.clear=function(){this.map={},this.setInProgress(!1),this.residualMembers=null},a.prototype.setInProgress=function(o){I.default.logAction(I.default.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+o),this.syncInProgress=o,this.presence.syncComplete=!o},a}(E.default);R.default=t},function(z,R,l){R.__esModule=!0;var v=l(1),s=l(56),U=l(32),E=l(13),I=v.__importDefault(l(4)),x=v.__importDefault(l(0)),b=function(){function C(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}return C.prototype.isWordArray=function(y){return y!=null&&y.sigBytes!==void 0},C.prototype.isArrayBuffer=function(y){return y!=null&&y.constructor===ArrayBuffer},C.prototype.isTypedArray=function(y){return!!ArrayBuffer&&ArrayBuffer.isView&&ArrayBuffer.isView(y)},C.prototype.uint8ViewToBase64=function(y){for(var r="",p=this.base64CharSet,A=y.byteLength,O=A%3,u=A-O,f,c,t,e,i,a=0;a<u;a=a+3)i=y[a]<<16|y[a+1]<<8|y[a+2],f=(i&16515072)>>18,c=(i&258048)>>12,t=(i&4032)>>6,e=i&63,r+=p[f]+p[c]+p[t]+p[e];return O==1?(i=y[u],f=(i&252)>>2,c=(i&3)<<4,r+=p[f]+p[c]+"=="):O==2&&(i=y[u]<<8|y[u+1],f=(i&64512)>>10,c=(i&1008)>>4,t=(i&15)<<2,r+=p[f]+p[c]+p[t]+"="),r},C.prototype.base64ToArrayBuffer=function(y){for(var r=atob==null?void 0:atob(y),p=r.length,A=new Uint8Array(p),O=0;O<p;O++){var u=r.charCodeAt(O);A[O]=u}return A.buffer},C.prototype.isBuffer=function(y){return this.isArrayBuffer(y)||this.isWordArray(y)||this.isTypedArray(y)},C.prototype.toBuffer=function(y){if(!ArrayBuffer)throw new Error("Can't convert to Buffer: browser does not support the necessary types");if(this.isArrayBuffer(y))return new Uint8Array(y);if(this.isTypedArray(y))return new Uint8Array(y.buffer);if(this.isWordArray(y)){for(var r=new ArrayBuffer(y.sigBytes),p=new Uint8Array(r),A=0;A<y.sigBytes;A++)p[A]=y.words[A>>>2]>>>24-A%4*8&255;return p}throw new Error("BufferUtils.toBuffer expected an arraybuffer, typed array, or CryptoJS wordarray")},C.prototype.toArrayBuffer=function(y){return this.isArrayBuffer(y)?y:this.toBuffer(y).buffer},C.prototype.toWordArray=function(y){return this.isTypedArray(y)&&(y=y.buffer),this.isWordArray(y)?y:I.default.create(y)},C.prototype.base64Encode=function(y){return this.isWordArray(y)?(0,E.stringify)(y):this.uint8ViewToBase64(this.toBuffer(y))},C.prototype.base64Decode=function(y){return ArrayBuffer&&x.default.Config.atob?this.base64ToArrayBuffer(y):(0,E.parse)(y)},C.prototype.hexEncode=function(y){return(0,s.stringify)(this.toWordArray(y))},C.prototype.hexDecode=function(y){var r=(0,s.parse)(y);return ArrayBuffer?this.toArrayBuffer(r):r},C.prototype.utf8Encode=function(y){return TextEncoder?new TextEncoder().encode(y).buffer:(0,U.parse)(y)},C.prototype.utf8Decode=function(y){if(!this.isBuffer(y))throw new Error("Expected input of utf8decode to be an arraybuffer, typed array, or CryptoJS wordarray");return TextDecoder&&!this.isWordArray(y)?new TextDecoder().decode(y):(y=this.toWordArray(y),(0,U.stringify)(y))},C.prototype.bufferCompare=function(y,r){if(!y)return-1;if(!r)return 1;var p=this.toWordArray(y),A=this.toWordArray(r);p.clamp(),A.clamp();var O=p.sigBytes-A.sigBytes;if(O!=0)return O;for(var u=p.words,f=A.words,c=0;c<u.length;c++)if(O=u[c]-f[c],O!=0)return O;return 0},C.prototype.byteLength=function(y){return this.isArrayBuffer(y)||this.isTypedArray(y)?y.byteLength:this.isWordArray(y)?y.sigBytes:-1},C.prototype.typedArrayToBuffer=function(y){return y.buffer},C}();R.default=new b},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){return v.enc.Hex})},function(z,R,l){l.r(R);var v=l(4),s=l.n(v),U=l(13),E=l(21),I=l.n(E),x=l(0),b=l.n(x),C=l(3),y=l.n(C),r=function(){var p="aes",A=256,O="cbc",u=16,f=4,c=4294967296,t=2147483648,e;if(b.a.getRandomWordArray)e=b.a.getRandomWordArray;else if(typeof Uint32Array<"u"&&b.a.getRandomValues){var i=new Uint32Array(f);e=function(h,g){var P=h/4,L=P==f?i:new Uint32Array(P);b.a.getRandomValues(L,function(B){typeof g<"u"&&g(B,b.a.BufferUtils.toWordArray(L))})}}else e=function(h,g){y.a.logAction(y.a.LOG_MAJOR,"Ably.Crypto.generateRandom()","Warning: the browser you are using does not support secure cryptographically secure randomness generation; falling back to insecure Math.random()");for(var P=h/4,L=new Array(P),B=0;B<P;B++)L[B]=Math.floor(Math.random()*c)-t;g(null,s.a.create(L))};function a(h){return h+u&-u}function o(h){if(h.algorithm==="aes"&&h.mode==="cbc"){if(h.keyLength===128||h.keyLength===256)return;throw new Error("Unsupported key length "+h.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}}function n(h){return h.replace("_","/").replace("-","+")}var d=[s.a.create([269488144,269488144,269488144,269488144],16),s.a.create([16777216],1),s.a.create([33685504],2),s.a.create([50529024],3),s.a.create([67372036],4),s.a.create([84215045,83886080],5),s.a.create([101058054,101056512],6),s.a.create([117901063,117901056],7),s.a.create([134744072,134744072],8),s.a.create([151587081,151587081,150994944],9),s.a.create([168430090,168430090,168427520],10),s.a.create([185273099,185273099,185273088],11),s.a.create([202116108,202116108,202116108],12),s.a.create([218959117,218959117,218959117,218103808],13),s.a.create([235802126,235802126,235802126,235798528],14),s.a.create([252645135,252645135,252645135,252645135],15),s.a.create([269488144,269488144,269488144,269488144],16)];function m(){}function S(){this.algorithm=null,this.keyLength=null,this.mode=null,this.key=null}m.CipherParams=S,m.getDefaultParams=function(h){var g;if(typeof h=="function"||typeof h=="string"){if(y.a.deprecated("Crypto.getDefaultParams(key, callback)","Crypto.getDefaultParams({key: key})"),typeof h=="function")m.generateRandomKey(function(L){h(null,m.getDefaultParams({key:L}))});else if(typeof arguments[1]=="function")arguments[1](null,m.getDefaultParams({key:h}));else throw new Error("Invalid arguments for Crypto.getDefaultParams");return}if(!h.key)throw new Error("Crypto.getDefaultParams: a key is required");typeof h.key=="string"?g=Object(U.parse)(n(h.key)):g=b.a.BufferUtils.toWordArray(h.key);var P=new S;if(P.key=g,P.algorithm=h.algorithm||p,P.keyLength=g.words.length*(4*8),P.mode=h.mode||O,h.keyLength&&h.keyLength!==P.keyLength)throw new Error("Crypto.getDefaultParams: a keyLength of "+h.keyLength+" was specified, but the key actually has length "+P.keyLength);return o(P),P},m.generateRandomKey=function(h,g){arguments.length==1&&typeof h=="function"&&(g=h,h=void 0),e((h||A)/8,g)},m.getCipher=function(h){var g=h instanceof S?h:m.getDefaultParams(h);return{cipherParams:g,cipher:new T(g,f,h.iv)}};function T(h,g,P){this.algorithm=h.algorithm+"-"+String(h.keyLength)+"-"+h.mode,this.cjsAlgorithm=h.algorithm.toUpperCase().replace(/-\d+$/,""),this.key=b.a.BufferUtils.toWordArray(h.key),P&&(this.iv=b.a.BufferUtils.toWordArray(P).clone()),this.blockLengthWords=g}return T.prototype.encrypt=function(h,g){y.a.logAction(y.a.LOG_MICRO,"CBCCipher.encrypt()",""),h=b.a.BufferUtils.toWordArray(h);var P=h.sigBytes,L=a(P),B=this,F=function(){B.getIv(function(V,j){if(V){g(V);return}var D=B.encryptCipher.process(h.concat(d[L-P])),M=j.concat(D);g(null,M)})};this.encryptCipher?F():this.iv?(this.encryptCipher=I.a.algo[this.cjsAlgorithm].createEncryptor(this.key,{iv:this.iv}),F()):e(u,function(V,j){if(V){g(V);return}B.encryptCipher=I.a.algo[B.cjsAlgorithm].createEncryptor(B.key,{iv:j}),B.iv=j,F()})},T.prototype.decrypt=function(h){y.a.logAction(y.a.LOG_MICRO,"CBCCipher.decrypt()",""),h=b.a.BufferUtils.toWordArray(h);var g=this.blockLengthWords,P=h.words,L=s.a.create(P.slice(0,g)),B=s.a.create(P.slice(g)),F=I.a.algo[this.cjsAlgorithm].createDecryptor(this.key,{iv:L}),V=F.process(B),j=F.finalize();return F.reset(),j&&j.sigBytes&&V.concat(j),V},T.prototype.getIv=function(h){if(this.iv){var g=this.iv;this.iv=null,h(null,g);return}var P=this;e(u,function(L,B){if(L){h(L);return}h(null,P.encryptCipher.process(B))})},m}();R.default=r},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){return function(){var s=v,U=s.lib,E=U.WordArray,I=s.enc;I.Utf16=I.Utf16BE={stringify:function(b){for(var C=b.words,y=b.sigBytes,r=[],p=0;p<y;p+=2){var A=C[p>>>2]>>>16-p%4*8&65535;r.push(String.fromCharCode(A))}return r.join("")},parse:function(b){for(var C=b.length,y=[],r=0;r<C;r++)y[r>>>1]|=b.charCodeAt(r)<<16-r%2*16;return E.create(y,C*2)}},I.Utf16LE={stringify:function(b){for(var C=b.words,y=b.sigBytes,r=[],p=0;p<y;p+=2){var A=x(C[p>>>2]>>>16-p%4*8&65535);r.push(String.fromCharCode(A))}return r.join("")},parse:function(b){for(var C=b.length,y=[],r=0;r<C;r++)y[r>>>1]|=x(b.charCodeAt(r)<<16-r%2*16);return E.create(y,C*2)}};function x(b){return b<<8&4278255360|b>>>8&16711935}}(),v.enc.Utf16})},function(z,R,l){(function(v,s){z.exports=s(l(6),l(28))})(this,function(v){return function(s){var U=v,E=U.lib,I=E.CipherParams,x=U.enc,b=x.Hex,C=U.format;C.Hex={stringify:function(y){return y.ciphertext.toString(b)},parse:function(y){var r=b.parse(y);return I.create({ciphertext:r})}}}(),v.format.Hex})},function(z,R,l){(function(v,s){z.exports=s(l(6),l(13),l(61),l(27),l(28))})(this,function(v){return function(){var s=v,U=s.lib,E=U.BlockCipher,I=s.algo,x=[],b=[],C=[],y=[],r=[],p=[],A=[],O=[],u=[],f=[];(function(){for(var e=[],i=0;i<256;i++)i<128?e[i]=i<<1:e[i]=i<<1^283;for(var a=0,o=0,i=0;i<256;i++){var n=o^o<<1^o<<2^o<<3^o<<4;n=n>>>8^n&255^99,x[a]=n,b[n]=a;var d=e[a],m=e[d],S=e[m],T=e[n]*257^n*16843008;C[a]=T<<24|T>>>8,y[a]=T<<16|T>>>16,r[a]=T<<8|T>>>24,p[a]=T;var T=S*16843009^m*65537^d*257^a*16843008;A[n]=T<<24|T>>>8,O[n]=T<<16|T>>>16,u[n]=T<<8|T>>>24,f[n]=T,a?(a=d^e[e[e[S^d]]],o^=e[e[o]]):a=o=1}})();var c=[0,1,2,4,8,16,32,64,128,27,54],t=I.AES=E.extend({_doReset:function(){var e;if(!(this._nRounds&&this._keyPriorReset===this._key)){for(var i=this._keyPriorReset=this._key,a=i.words,o=i.sigBytes/4,n=this._nRounds=o+6,d=(n+1)*4,m=this._keySchedule=[],S=0;S<d;S++)S<o?m[S]=a[S]:(e=m[S-1],S%o?o>6&&S%o==4&&(e=x[e>>>24]<<24|x[e>>>16&255]<<16|x[e>>>8&255]<<8|x[e&255]):(e=e<<8|e>>>24,e=x[e>>>24]<<24|x[e>>>16&255]<<16|x[e>>>8&255]<<8|x[e&255],e^=c[S/o|0]<<24),m[S]=m[S-o]^e);for(var T=this._invKeySchedule=[],h=0;h<d;h++){var S=d-h;if(h%4)var e=m[S];else var e=m[S-4];h<4||S<=4?T[h]=e:T[h]=A[x[e>>>24]]^O[x[e>>>16&255]]^u[x[e>>>8&255]]^f[x[e&255]]}}},encryptBlock:function(e,i){this._doCryptBlock(e,i,this._keySchedule,C,y,r,p,x)},decryptBlock:function(e,i){var a=e[i+1];e[i+1]=e[i+3],e[i+3]=a,this._doCryptBlock(e,i,this._invKeySchedule,A,O,u,f,b);var a=e[i+1];e[i+1]=e[i+3],e[i+3]=a},_doCryptBlock:function(e,i,a,o,n,d,m,S){for(var T=this._nRounds,h=e[i]^a[0],g=e[i+1]^a[1],P=e[i+2]^a[2],L=e[i+3]^a[3],B=4,F=1;F<T;F++){var V=o[h>>>24]^n[g>>>16&255]^d[P>>>8&255]^m[L&255]^a[B++],j=o[g>>>24]^n[P>>>16&255]^d[L>>>8&255]^m[h&255]^a[B++],D=o[P>>>24]^n[L>>>16&255]^d[h>>>8&255]^m[g&255]^a[B++],M=o[L>>>24]^n[h>>>16&255]^d[g>>>8&255]^m[P&255]^a[B++];h=V,g=j,P=D,L=M}var V=(S[h>>>24]<<24|S[g>>>16&255]<<16|S[P>>>8&255]<<8|S[L&255])^a[B++],j=(S[g>>>24]<<24|S[P>>>16&255]<<16|S[L>>>8&255]<<8|S[h&255])^a[B++],D=(S[P>>>24]<<24|S[L>>>16&255]<<16|S[h>>>8&255]<<8|S[g&255])^a[B++],M=(S[L>>>24]<<24|S[h>>>16&255]<<16|S[g>>>8&255]<<8|S[P&255])^a[B++];e[i]=V,e[i+1]=j,e[i+2]=D,e[i+3]=M},keySize:256/32});s.AES=E._createHelper(t)}(),v.AES})},function(z,R,l){(function(v,s){z.exports=s(l(6))})(this,function(v){return function(s){var U=v,E=U.lib,I=E.WordArray,x=E.Hasher,b=U.algo,C=[];(function(){for(var u=0;u<64;u++)C[u]=s.abs(s.sin(u+1))*4294967296|0})();var y=b.MD5=x.extend({_doReset:function(){this._hash=new I.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(u,f){for(var c=0;c<16;c++){var t=f+c,e=u[t];u[t]=(e<<8|e>>>24)&16711935|(e<<24|e>>>8)&4278255360}var i=this._hash.words,a=u[f+0],o=u[f+1],n=u[f+2],d=u[f+3],m=u[f+4],S=u[f+5],T=u[f+6],h=u[f+7],g=u[f+8],P=u[f+9],L=u[f+10],B=u[f+11],F=u[f+12],V=u[f+13],j=u[f+14],D=u[f+15],M=i[0],w=i[1],G=i[2],N=i[3];M=r(M,w,G,N,a,7,C[0]),N=r(N,M,w,G,o,12,C[1]),G=r(G,N,M,w,n,17,C[2]),w=r(w,G,N,M,d,22,C[3]),M=r(M,w,G,N,m,7,C[4]),N=r(N,M,w,G,S,12,C[5]),G=r(G,N,M,w,T,17,C[6]),w=r(w,G,N,M,h,22,C[7]),M=r(M,w,G,N,g,7,C[8]),N=r(N,M,w,G,P,12,C[9]),G=r(G,N,M,w,L,17,C[10]),w=r(w,G,N,M,B,22,C[11]),M=r(M,w,G,N,F,7,C[12]),N=r(N,M,w,G,V,12,C[13]),G=r(G,N,M,w,j,17,C[14]),w=r(w,G,N,M,D,22,C[15]),M=p(M,w,G,N,o,5,C[16]),N=p(N,M,w,G,T,9,C[17]),G=p(G,N,M,w,B,14,C[18]),w=p(w,G,N,M,a,20,C[19]),M=p(M,w,G,N,S,5,C[20]),N=p(N,M,w,G,L,9,C[21]),G=p(G,N,M,w,D,14,C[22]),w=p(w,G,N,M,m,20,C[23]),M=p(M,w,G,N,P,5,C[24]),N=p(N,M,w,G,j,9,C[25]),G=p(G,N,M,w,d,14,C[26]),w=p(w,G,N,M,g,20,C[27]),M=p(M,w,G,N,V,5,C[28]),N=p(N,M,w,G,n,9,C[29]),G=p(G,N,M,w,h,14,C[30]),w=p(w,G,N,M,F,20,C[31]),M=A(M,w,G,N,S,4,C[32]),N=A(N,M,w,G,g,11,C[33]),G=A(G,N,M,w,B,16,C[34]),w=A(w,G,N,M,j,23,C[35]),M=A(M,w,G,N,o,4,C[36]),N=A(N,M,w,G,m,11,C[37]),G=A(G,N,M,w,h,16,C[38]),w=A(w,G,N,M,L,23,C[39]),M=A(M,w,G,N,V,4,C[40]),N=A(N,M,w,G,a,11,C[41]),G=A(G,N,M,w,d,16,C[42]),w=A(w,G,N,M,T,23,C[43]),M=A(M,w,G,N,P,4,C[44]),N=A(N,M,w,G,F,11,C[45]),G=A(G,N,M,w,D,16,C[46]),w=A(w,G,N,M,n,23,C[47]),M=O(M,w,G,N,a,6,C[48]),N=O(N,M,w,G,h,10,C[49]),G=O(G,N,M,w,j,15,C[50]),w=O(w,G,N,M,S,21,C[51]),M=O(M,w,G,N,F,6,C[52]),N=O(N,M,w,G,d,10,C[53]),G=O(G,N,M,w,L,15,C[54]),w=O(w,G,N,M,o,21,C[55]),M=O(M,w,G,N,g,6,C[56]),N=O(N,M,w,G,D,10,C[57]),G=O(G,N,M,w,T,15,C[58]),w=O(w,G,N,M,V,21,C[59]),M=O(M,w,G,N,m,6,C[60]),N=O(N,M,w,G,B,10,C[61]),G=O(G,N,M,w,n,15,C[62]),w=O(w,G,N,M,P,21,C[63]),i[0]=i[0]+M|0,i[1]=i[1]+w|0,i[2]=i[2]+G|0,i[3]=i[3]+N|0},_doFinalize:function(){var u=this._data,f=u.words,c=this._nDataBytes*8,t=u.sigBytes*8;f[t>>>5]|=128<<24-t%32;var e=s.floor(c/4294967296),i=c;f[(t+64>>>9<<4)+15]=(e<<8|e>>>24)&16711935|(e<<24|e>>>8)&4278255360,f[(t+64>>>9<<4)+14]=(i<<8|i>>>24)&16711935|(i<<24|i>>>8)&4278255360,u.sigBytes=(f.length+1)*4,this._process();for(var a=this._hash,o=a.words,n=0;n<4;n++){var d=o[n];o[n]=(d<<8|d>>>24)&16711935|(d<<24|d>>>8)&4278255360}return a},clone:function(){var u=x.clone.call(this);return u._hash=this._hash.clone(),u}});function r(u,f,c,t,e,i,a){var o=u+(f&c|~f&t)+e+a;return(o<<i|o>>>32-i)+f}function p(u,f,c,t,e,i,a){var o=u+(f&t|c&~t)+e+a;return(o<<i|o>>>32-i)+f}function A(u,f,c,t,e,i,a){var o=u+(f^c^t)+e+a;return(o<<i|o>>>32-i)+f}function O(u,f,c,t,e,i,a){var o=u+(c^(f|~t))+e+a;return(o<<i|o>>>32-i)+f}U.MD5=x._createHelper(y),U.HmacMD5=x._createHmacHelper(y)}(Math),v.MD5})},function(z,R,l){var v;R.__esModule=!0;var s=l(1),U=s.__importDefault(l(0)),E=s.__importStar(l(2)),I=s.__importDefault(l(8)),x=s.__importDefault(l(5)),b=s.__importDefault(l(17)),C=s.__importDefault(l(15)),y=s.__importDefault(l(20)),r=s.__importDefault(l(3)),p=l(29),A=s.__importDefault(l(63)),O=l(37);function u(t){var e=t.statusCode;return e===408&&!t.code||e===400&&!t.code||e>=500&&e<=504}function f(t){var e=t.connection,i=e&&e.connectionManager.host;return i?[i].concat(I.default.getFallbackHosts(t.options)):I.default.getHosts(t.options)}var c=(v=function(){function t(e){this.checksInProgress=null,this.checkConnectivity=void 0,this.supportsAuthHeaders=!1,this.supportsLinkHeaders=!1,this._getHosts=f,this.options=e||{};var i=this.options.connectivityCheckUrl||I.default.connectivityCheckUrl,a=this.options.connectivityCheckParams,o=!this.options.connectivityCheckUrl;U.default.Config.xhrSupported?(this.supportsAuthHeaders=!0,this.Request=function(n,d,m,S,T,h,g){var P=C.default.createRequest(m,S,T,h,y.default.REQ_SEND,d&&d.options.timeouts,n);return P.once("complete",g),P.exec(),P},this.options.disableConnectivityCheck?this.checkConnectivity=function(n){n(null,!0)}:this.checkConnectivity=function(n){r.default.logAction(r.default.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+i),this.doUri(b.default.Get,null,i,null,null,a,function(d,m,S,T,h){var g=!1;o?g=!d&&(m==null?void 0:m.replace(/\n/,""))=="yes":g=!d&&(0,O.isSuccessCode)(h),r.default.logAction(r.default.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+g),n(null,g)})}):U.default.Config.jsonpSupported?(this.Request=function(n,d,m,S,T,h,g){var P=(0,p.createRequest)(m,S,T,h,y.default.REQ_SEND,d&&d.options.timeouts,n);return P.once("complete",g),U.default.Config.nextTick(function(){P.exec()}),P},this.options.disableConnectivityCheck?this.checkConnectivity=function(n){n(null,!0)}:this.checkConnectivity=function(n){var d=this,m=I.default.jsonpInternetUpUrl;if(this.checksInProgress){this.checksInProgress.push(n);return}this.checksInProgress=[n],r.default.logAction(r.default.LOG_MICRO,"(JSONP)Http.checkConnectivity()","Sending; "+m);var S=new p.Request("isTheInternetUp",m,null,null,null,y.default.REQ_SEND,I.default.TIMEOUTS);S.once("complete",function(T,h){var g=!T&&h;r.default.logAction(r.default.LOG_MICRO,"(JSONP)Http.checkConnectivity()","Result: "+g);for(var P=0;P<d.checksInProgress.length;P++)d.checksInProgress[P](null,g);d.checksInProgress=null}),U.default.Config.nextTick(function(){S.exec()})}):U.default.Config.fetchSupported?(this.supportsAuthHeaders=!0,this.Request=A.default,this.checkConnectivity=function(n){r.default.logAction(r.default.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Sending; "+i),this.doUri(b.default.Get,null,i,null,null,null,function(d,m){var S=!d&&(m==null?void 0:m.replace(/\n/,""))=="yes";r.default.logAction(r.default.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Result: "+S),n(null,S)})}):this.Request=function(n,d,m,S,T,h,g){g(new x.default("no supported HTTP transports available",null,400),null)}}return t.prototype.do=function(e,i,a,o,n,d,m){var S=this,T=typeof a=="function"?a:function(L){return i.baseUri(L)+a},h=i._currentFallback;if(h)if(h.validUntil>E.now()){if(!this.Request){m==null||m(new x.default("Request invoked before assigned to",null,500));return}this.Request(e,i,T(h.host),o,d,n,function(L){for(var B=[],F=1;F<arguments.length;F++)B[F-1]=arguments[F];if(L&&u(L)){i._currentFallback=null,S.do(e,i,a,o,n,d,m);return}m==null||m.apply(void 0,s.__spreadArray([L],B,!1))});return}else i._currentFallback=null;var g=f(i);if(g.length===1){this.doUri(e,i,T(g[0]),o,n,d,m);return}var P=function(L,B){var F=L.shift();S.doUri(e,i,T(F),o,n,d,function(V){for(var j=[],D=1;D<arguments.length;D++)j[D-1]=arguments[D];if(V&&u(V)&&L.length){P(L,!0);return}B&&(i._currentFallback={host:F,validUntil:E.now()+i.options.timeouts.fallbackRetryTimeout}),m==null||m.apply(void 0,s.__spreadArray([V],j,!1))})};P(g)},t.prototype.doUri=function(e,i,a,o,n,d,m){if(!this.Request){m(new x.default("Request invoked before assigned to",null,500));return}this.Request(e,i,a,o,d,n,m)},t}(),v.methods=[b.default.Get,b.default.Delete,b.default.Post,b.default.Put,b.default.Patch],v.methodsWithoutBody=[b.default.Get,b.default.Delete],v.methodsWithBody=[b.default.Post,b.default.Put,b.default.Patch],v);R.default=c},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(5)),U=v.__importDefault(l(0)),E=v.__importDefault(l(8)),I=v.__importStar(l(2)),x=l(2);function b(r,p){return!!p.get("x-ably-errorcode")}function C(r,p){if(b(r,p))return r.error&&s.default.fromValues(r.error)}function y(r,p,A,O,u,f,c){var t=new Headers(O||{}),e=r?r.toUpperCase():I.isEmptyArg(f)?"GET":"POST",i=new AbortController,a=setTimeout(function(){i.abort(),c(new s.default("Request timed out",null,408))},p?p.options.timeouts.httpRequestTimeout:E.default.TIMEOUTS.httpRequestTimeout);(0,x.getGlobalObject)().fetch(A+"?"+new URLSearchParams(u||{}),{method:e,headers:t,body:f,credentials:t.has("authorization")?"include":"same-origin"}).then(function(o){clearTimeout(a);var n=o.headers.get("Content-Type"),d;n&&n.indexOf("application/x-msgpack")>-1?d=o.arrayBuffer():n&&n.indexOf("application/json")>-1?d=o.json():d=o.text(),d.then(function(m){var S=!!n&&n.indexOf("application/x-msgpack")===-1;if(o.ok)c(null,m,o.headers,S,o.status);else{var T=C(m,o.headers)||new s.default("Error response received from server: "+o.status+" body was: "+U.default.Config.inspect(m),null,o.status);c(T,m,o.headers,S,o.status)}})}).catch(function(o){clearTimeout(a),c(o)})}R.default=y},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(41)),U=v.__importStar(l(2)),E=U.getGlobalObject();typeof Window>"u"&&typeof WorkerGlobalScope>"u"&&console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");function I(){var y=E.location;return!E.WebSocket||!y||!y.origin||y.origin.indexOf("http")>-1}var x=E.navigator&&E.navigator.userAgent.toString(),b=E.location&&E.location.href,C={agent:"browser",logTimestamps:!0,userAgent:x,currentUrl:b,noUpgrade:x&&!!x.match(/MSIE\s8\.0/),binaryType:"arraybuffer",WebSocket:E.WebSocket,fetchSupported:!!E.fetch,xhrSupported:E.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,jsonpSupported:typeof document<"u",allowComet:I(),streamingSupported:!0,useProtocolHeartbeats:!0,createHmac:null,msgpack:s.default,supportsBinary:!!E.TextDecoder,preferBinary:!1,ArrayBuffer:E.ArrayBuffer,atob:E.atob,nextTick:typeof E.setImmediate<"u"?E.setImmediate.bind(E):function(y){setTimeout(y,0)},addEventListener:E.addEventListener,inspect:JSON.stringify,stringByteSize:function(y){return E.TextDecoder&&new E.TextEncoder().encode(y).length||y.length},TextEncoder:E.TextEncoder,TextDecoder:E.TextDecoder,Promise:E.Promise,getRandomValues:function(y){if(y!==void 0)return function(r,p){y.getRandomValues(r),p&&p(null)}}(E.crypto||msCrypto)};R.default=C},function(z,R,l){(function(v){R.__esModule=!0;var s=l(1),U=s.__importStar(l(2)),E="ablyjs-storage-test",I=function(){function x(){try{v.sessionStorage.setItem(E,E),v.sessionStorage.removeItem(E),this.sessionSupported=!0}catch{this.sessionSupported=!1}try{v.localStorage.setItem(E,E),v.localStorage.removeItem(E),this.localSupported=!0}catch{this.localSupported=!1}}return x.prototype.get=function(b){return this._get(b,!1)},x.prototype.getSession=function(b){return this._get(b,!0)},x.prototype.remove=function(b){return this._remove(b,!1)},x.prototype.removeSession=function(b){return this._remove(b,!0)},x.prototype.set=function(b,C,y){return this._set(b,C,y,!1)},x.prototype.setSession=function(b,C,y){return this._set(b,C,y,!0)},x.prototype._set=function(b,C,y,r){var p={value:C};return y&&(p.expires=U.now()+y),this.storageInterface(r).setItem(b,JSON.stringify(p))},x.prototype._get=function(b,C){if(C&&!this.sessionSupported)throw new Error("Session Storage not supported");if(!C&&!this.localSupported)throw new Error("Local Storage not supported");var y=this.storageInterface(C).getItem(b);if(!y)return null;var r=JSON.parse(y);return r.expires&&r.expires<U.now()?(this.storageInterface(C).removeItem(b),null):r.value},x.prototype._remove=function(b,C){return this.storageInterface(C).removeItem(b)},x.prototype.storageInterface=function(b){return b?v.sessionStorage:v.localStorage},x}();R.default=new I}).call(this,l(12))},function(z,R,l){R.__esModule=!0;var v=l(1),s=v.__importDefault(l(67)),U={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",jsonpInternetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up-0-9.js",defaultTransports:[s.default.XhrPolling,s.default.XhrStreaming,s.default.JsonP,s.default.WebSocket],baseTransportOrder:[s.default.XhrPolling,s.default.XhrStreaming,s.default.JsonP,s.default.WebSocket],transportPreferenceOrder:[s.default.JsonP,s.default.XhrPolling,s.default.XhrStreaming,s.default.WebSocket],upgradeTransports:[s.default.XhrStreaming,s.default.WebSocket]};R.default=U},function(z,R,l){R.__esModule=!0;var v;(function(s){s.WebSocket="web_socket",s.Comet="comet",s.XhrStreaming="xhr_streaming",s.XhrPolling="xhr_polling",s.JsonP="jsonp"})(v||(v={})),R.default=v},function(z,R,l){l.r(R);var v=l(29),s=l.n(v),U=l(2),E=l(0),I=l.n(E),x=l(11),b=l.n(x),C=l(15),y=l.n(C),r=function(u){var f="xhr_polling";function c(t,e,i){i.stream=!1,b.a.call(this,t,e,i),this.shortName=f}return U.inherits(c,b.a),c.isAvailable=function(){return I.a.Config.xhrSupported&&I.a.Config.allowComet},c.prototype.toString=function(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},c.prototype.createRequest=function(t,e,i,a,o){return y.a.createRequest(t,e,i,a,o,this.timeouts)},typeof u<"u"&&c.isAvailable()&&(u.supportedTransports[f]=c),c},p=r,A=function(u){var f="xhr_streaming";function c(t,e,i){b.a.call(this,t,e,i),this.shortName=f}return U.inherits(c,b.a),c.isAvailable=function(){return I.a.Config.xhrSupported&&I.a.Config.streamingSupported&&I.a.Config.allowComet},c.prototype.toString=function(){return"XHRStreamingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},c.prototype.createRequest=function(t,e,i,a,o){return y.a.createRequest(t,e,i,a,o,this.timeouts)},typeof u<"u"&&c.isAvailable()&&(u.supportedTransports[f]=c),c},O=A;R.default=[s.a,p,O]}]).default})})(ut);export{ut as a,lt as c,ct as g};
